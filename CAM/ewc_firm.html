<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="auto">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="favicon.ico" />
  <title>EWC Device Flasher â€” ç·šä¸Šç‡’éŒ„ä¸­å¿ƒ</title>

  <!-- ç‰ˆæœ¬æ§åˆ¶ï¼ˆåªéœ€æ”¹é€™è£¡ï¼‰ -->
  <script>
    const APP_VERSION = "2.0.5+ewc-flash";
    const VQ = `?v=${encodeURIComponent(APP_VERSION)}`;
    try {
      const KEY = "ewc.flash.version"; const prev = localStorage.getItem(KEY);
      if (prev !== APP_VERSION) { localStorage.setItem(KEY, APP_VERSION); window.__EWC_JUST_UPDATED__ = !!prev; }
    } catch (e) { }
  </script>

  <!-- Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

  <!-- esp-web-tools -->
  <script type="module" src="https://unpkg.com/esp-web-tools@10.0.1/dist/web/install-button.js?module"></script>

  <style>
    :root {
      --ewc-primary: #4f46e5;
      --ewc-gradient: linear-gradient(135deg, #4f46e5 0%, #22c55e 100%);
    }

    body {
      background:
        radial-gradient(1200px 600px at -10% -10%, rgba(79, 70, 229, .10), transparent 70%),
        radial-gradient(1200px 600px at 110% 110%, rgba(34, 197, 94, .10), transparent 70%);
      min-height: 100dvh;
    }

    .navbar-brand span {
      font-weight: 700;
      letter-spacing: .2px;
    }

    .badge-version {
      background: var(--ewc-gradient);
      color: #fff;
      box-shadow: 0 .25rem 1rem rgba(0, 0, 0, .12)
    }

    /* Heroï¼šä½¿ç”¨ BS çš„è‡ªé©æ‡‰åº•è‰²ï¼Œç¢ºä¿æ·±/æ·ºè‰²éƒ½å¯è®€ */
    .hero {
      border-radius: 1.25rem;
      background: var(--bs-tertiary-bg);
      padding: 2rem;
      border: 1px solid var(--bs-border-color);
    }

    .hero h1 {
      color: var(--bs-emphasis-color);
    }

    .hero .lead {
      color: var(--bs-body-color);
      opacity: .96;
    }

    .card {
      border-radius: 1rem;
      box-shadow: 0 .5rem 1.5rem rgba(0, 0, 0, .06);
      border: 1px solid var(--bs-border-color)
    }

    .muted {
      opacity: .9
    }

    .install-ready {
      animation: pop .3s ease-out
    }

    @keyframes pop {
      from {
        transform: scale(.98);
        opacity: .6
      }

      to {
        transform: scale(1);
        opacity: 1
      }
    }

    .list-steps li::marker {
      color: var(--ewc-primary)
    }

    .code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(0, 0, 0, .06);
      padding: .1rem .4rem;
      border-radius: .35rem
    }

    [data-bs-theme="dark"] .code {
      background: rgba(255, 255, 255, .06)
    }

    .footer {
      font-size: .9rem;
      opacity: .85
    }

    /* è®“ esp-web-tools çš„æŒ‰éˆ•åƒåˆ° Bootstrap æ¨£å¼ä¸”å…¨å¯¬ */
    .ewc-install-btn {
      display: block;
      width: 100%
    }

    .ewc-install-btn::part(button) {
      width: 100%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      padding: .6rem 1rem;
      border-radius: .5rem;
      border: 1px solid var(--bs-border-color)
    }

    .ewc-install-btn.btn-primary::part(button) {
      background-color: var(--bs-primary);
      color: #fff;
      border-color: var(--bs-primary)
    }

    .ewc-install-btn.btn-primary::part(button):hover {
      filter: brightness(1.05)
    }

    .ewc-install-btn.btn-secondary::part(button) {
      background-color: var(--bs-secondary-bg);
      color: var(--bs-body-color)
    }

    /* Live Console */
    .console-box {
      background: var(--bs-body-bg);
      border: 1px solid var(--bs-border-color);
      border-radius: .75rem;
      padding: .75rem;
      height: 220px;
      overflow: auto;
      font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      white-space: pre-wrap;
    }

    .console-box .ts {
      opacity: .6
    }

    .console-actions .btn {
      --bs-btn-padding-y: .25rem;
      --bs-btn-padding-x: .5rem;
      --bs-btn-font-size: .8rem;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom sticky-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <svg width="24" height="24" viewBox="0 0 24 24" class="text-primary" fill="currentColor" role="img"
          aria-label="EWC">
          <path d="M12 2l2.5 5.5L20 9l-5 3.5L16 19l-4-2.5L8 19l1-6.5L4 9l5.5-1.5L12 2z" />
        </svg>
        <span>EWC Device Flasher</span>
        <span class="badge badge-version ms-2">v<span id="appVersionLabel"></span></span>
      </a>
      <div class="ms-auto">
        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal"
          data-bs-target="#changelogModal">ç‰ˆæœ¬èªªæ˜</button>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <header class="container my-4">
    <div class="hero">
      <div class="row align-items-center g-4">
        <div class="col-lg-7">
          <h1 class="display-6 mb-2">EWC ç·šä¸Šç‡’éŒ„ä¸­å¿ƒ</h1>
          <p class="lead mb-3">
            ä½¿ç”¨ç€è¦½å™¨ï¼ˆChrome/Edgeï¼‰ç›´æ¥å° ESP è£ç½®ç‡’éŒ„éŸŒé«”ã€‚æ”¯æ´ã€Œé è¨­æ¸…å–®ç‡’éŒ„ã€èˆ‡
            <strong>é€šç”¨ç‡’éŒ„ï¼šESP8266 / ESP8285ï¼ˆESP-01Mï¼‰</strong>ï¼›å…¨ç¨‹åœ¨æœ¬æ©Ÿå®Œæˆï¼Œä¸ä¸Šå‚³ä¼ºæœå™¨ã€‚
          </p>
          <div id="envAlert" class="alert alert-warning d-none" role="alert"></div>
          <div id="updateToast" class="alert alert-success d-none" role="alert">
            å·²æ›´æ–°è‡³ <span class="code">v<span id="updatedVersion"></span></span>ã€‚æŸ¥çœ‹
            <a class="link-success" data-bs-toggle="modal" data-bs-target="#changelogModal" href="#">ç‰ˆæœ¬èªªæ˜</a>ã€‚
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" id="testPortBtn">æ¸¬è©¦åºåˆ—åŸ å¯ç”¨æ€§</button>
            <button class="btn btn-outline-primary" id="openFaqBtn">å¸¸è¦‹å•é¡Œ</button>
          </div>
        </div>
        <div class="col-lg-5">
          <ul class="list-unstyled small mb-0">
            <li>âœ… æ”¯æ´ï¼šESP32-CAMã€ESP-01Mã€ESP32-C3</li>
            <li>ğŸ”’ è«‹ä»¥ <span class="code">HTTPS</span> æˆ– <span class="code">localhost</span> é–‹å•Ÿ</li>
            <li>ğŸ§© ç€è¦½å™¨ï¼šChrome / Edgeï¼ˆéœ€ Web Serialï¼‰</li>
            <li>âš¡ è‡ªé¸æª”ä»¥æœ¬æ©Ÿ Blob æ–¹å¼ç‡’éŒ„ï¼Œ<u>ä¸ç¶“ä¼ºæœå™¨</u></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container my-4">
    <div class="row g-4">
      <!-- â‘  é è¨­éŸŒé«”ç‡’éŒ„ï¼ˆä¿ç•™åŸå…©ç¨® manifestï¼‰ -->
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">â‘  é è¨­éŸŒé«”ç‡’éŒ„</h5>
            <p class="card-text muted">
              å¾æ¸…å–®é¸æ“‡è£ç½®ä¸¦é–‹å§‹ç‡’éŒ„ï¼ˆè«‹åœ¨åŒè³‡æ–™å¤¾æº–å‚™å¥½å°æ‡‰çš„ <span class="code">manifest_*.json</span>ï¼‰ã€‚
            </p>

            <form id="presetForm" class="mb-3">
              <div class="mb-2 fw-semibold">é¸æ“‡è£ç½®é¡å‹</div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="type" id="ewccam" value="ewccam">
                <label class="form-check-label" for="ewccam">EWC CAM ä¸²æµç›£æ§é€šçŸ¥ï¼ˆESP32-CAMï¼‰</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="type" id="ewc01m" value="ewc01m">
                <label class="form-check-label" for="ewc01m">EWC èª¿å…‰ç‡ˆæ§é€šçŸ¥ï¼ˆESP-01M / å°ˆç”¨éŸŒé«”ï¼‰</label>
              </div>
            </form>

            <div class="d-grid">
              <esp-web-install-button id="presetBtn" class="ewc-install-btn btn btn-primary d-none" type="button">
                é–‹å§‹ç‡’éŒ„ï¼ˆé è¨­ï¼‰
              </esp-web-install-button>
            </div>

            <hr class="my-4">
            <h6 class="fw-bold">æ­¥é©Ÿæç¤º</h6>
            <ol class="list-steps">
              <li>æŠŠè£ç½®æ¥ä¸Š USB-TTLï¼ˆ3.3Vï¼‰æˆ–æ¿è¼‰ USBã€‚</li>
              <li>ä¸‹è¼‰æ¨¡å¼ï¼šESP32-CAM ä¾æ¿å­æŒ‰éµï¼›ESP-01M è«‹å°‡ <span class="code">GPIO0</span> æ‹‰ä½ã€<span class="code">EN/CH_PD</span>
                æ‹‰é«˜å¾Œä¸Šé›»ã€‚</li>
              <li>é»ã€Œé–‹å§‹ç‡’éŒ„ã€â†’ é¸æ“‡åºåˆ—åŸ  â†’ ä¾ç•«é¢æŒ‡ç¤ºé€²è¡Œã€‚</li>
            </ol>
          </div>
        </div>
      </div>

      <!-- â‘¡ é€šç”¨ç‡’éŒ„ï¼šESP8266/ESP8285ï¼ˆESP-01Mï¼‰ï½œä¸å‹•åŸ manifest -->
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">â‘¡ é€šç”¨ç‡’éŒ„ï¼ˆESP8266 / ESP8285ï½œESP-01Mï¼‰</h5>
            <p class="card-text muted">
              æ–¼æœ¬æ©Ÿé¸æ“‡ <span class="code">.bin</span> æª”ï¼Œç³»çµ±æœƒå‹•æ…‹ç”¢ç”Ÿè‡¨æ™‚ manifest å¾Œé€²è¡Œç‡’éŒ„ã€‚
              é©ç”¨ä»¥ Arduino-ESP8266/ESP8285 ç·¨è­¯ä¹‹å–®ä¸€æ˜ åƒï¼ˆoffset 0x0ï¼‰ã€‚<br>
              <strong>ä¸æœƒä¿®æ”¹æˆ–ä¾è³´ä½ åŸæœ¬çš„ manifestã€‚</strong>
            </p>

            <div class="row g-3 align-items-end">
              <div class="col-12">
                <label for="espGenericBin" class="form-label">é¸æ“‡éŸŒé«”æª”ï¼ˆ.binï¼‰</label>
                <input type="file" id="espGenericBin" class="form-control" accept=".bin" />
                <div class="form-text">
                  * è‹¥æœ‰å¤šåˆ†å€æª”ï¼Œè«‹å…ˆç”¨ <span class="code">esptool.py merge_bin</span> åˆä½µã€‚
                </div>
              </div>
              <div class="col-12">
                <div id="fileInfoGeneric" class="small text-body-secondary"></div>
              </div>
              <div class="col-12 d-grid">
                <esp-web-install-button id="espGenericBtn" class="ewc-install-btn btn btn-secondary d-none">
                  é–‹å§‹ç‡’éŒ„ï¼ˆé€šç”¨ï¼‰
                </esp-web-install-button>
              </div>
            </div>

            <hr class="my-4">
            <h6 class="fw-bold">å¿«é€Ÿæª¢æŸ¥</h6>
            <ul class="mb-0">
              <li>é©…å‹•ï¼šCH340 / CP210x å·²å®‰è£ã€‚</li>
              <li>å¤±æ•—æ™‚å…ˆæŠŠæ³¢ç‰¹ç‡é™è‡³ 115200ï¼ˆè‡ªç·¨ manifest å¯è¨­å®šï¼‰ã€‚</li>
              <li>ç¢ºèª TX/RX äº¤å‰æ¥ã€é›»æº 3.3V ç©©å®šï¼ˆå»ºè­° â‰¥500mAï¼‰ã€‚</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- â‘¢ é€šç”¨ç‡’éŒ„ï¼šESP32-C3 -->
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">â‘¢ é€šç”¨ç‡’éŒ„ï¼ˆESP32-C3ï¼‰</h5>
            <p class="card-text muted">
              æ–¼æœ¬æ©Ÿé¸æ“‡ <span class="code">.bin</span> æª”ï¼Œç³»çµ±æœƒå‹•æ…‹ç”¢ç”Ÿè‡¨æ™‚ manifest å¾Œé€²è¡Œç‡’éŒ„ã€‚
              é©ç”¨ ESP32-C3 åˆä½µæª”ï¼ˆoffset 0x0ï¼‰ã€‚<br>
              <strong>ä¸æœƒä¿®æ”¹æˆ–ä¾è³´ä½ åŸæœ¬çš„ manifestã€‚</strong>
            </p>

            <div class="row g-3 align-items-end">
              <div class="col-12">
                <label for="espGenericBinC3" class="form-label">é¸æ“‡éŸŒé«”æª”ï¼ˆ.binï¼‰</label>
                <input type="file" id="espGenericBinC3" class="form-control" accept=".bin" />
                <div class="form-text">
                  * è«‹ç¢ºèªæª”æ¡ˆç‚ºå®Œæ•´åˆä½µæª”ï¼ˆåŒ…å« Bootloader/Partition Tableï¼‰ã€‚
                </div>
              </div>
              <div class="col-12">
                <div id="fileInfoGenericC3" class="small text-body-secondary"></div>
              </div>
              <div class="col-12 d-grid">
                <esp-web-install-button id="espGenericBtnC3" class="ewc-install-btn btn btn-secondary d-none">
                  é–‹å§‹ç‡’éŒ„ï¼ˆESP32-C3ï¼‰
                </esp-web-install-button>
              </div>
            </div>

            <hr class="my-4">
            <h6 class="fw-bold">å¿«é€Ÿæª¢æŸ¥</h6>
            <ul class="mb-0">
              <li>æŒ‰ä½ <span class="code">BOOT/IO9</span> ä¸Šé›»é€²å…¥ä¸‹è¼‰æ¨¡å¼ã€‚</li>
              <li>ç¢ºèª USB æ™¶ç‰‡é©…å‹•å·²å®‰è£ã€‚</li>
              <li>ç‡’éŒ„ä½å€å›ºå®šç‚º <span class="code">0x0</span>ã€‚</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- â‘£ ç‡’éŒ„äº‹ä»¶ Console -->
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <h5 class="card-title mb-0">ç‡’éŒ„äº‹ä»¶ Console</h5>
              <div class="console-actions">
                <button class="btn btn-outline-secondary btn-sm" id="copyConsoleBtn">è¤‡è£½</button>
                <button class="btn btn-outline-danger btn-sm" id="clearConsoleBtn">æ¸…é™¤</button>
              </div>
            </div>
            <div id="liveConsole" class="console-box mt-2" aria-live="polite"></div>
          </div>
        </div>
      </div>

      <!-- FAQ -->
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">FAQ / æ•…éšœæ’é™¤</h5>
            <div class="accordion" id="faq">
              <div class="accordion-item">
                <h2 class="accordion-header" id="q1">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#a1" aria-expanded="false">æŒ‰éˆ•ç°è‰²æˆ–æ²’åæ‡‰ï¼Ÿ</button>
                </h2>
                <div id="a1" class="accordion-collapse collapse" data-bs-parent="#faq" tabindex="-1">
                  <div class="accordion-body">
                    è«‹ä½¿ç”¨ Chrome/Edge ä¸¦åœ¨ <span class="code">HTTPS</span> æˆ– <span class="code">localhost</span> é–‹å•Ÿï¼›
                    ä¸”å·²é¸æ“‡è£ç½®æˆ–ä¸Šå‚³ .bin æª”ã€‚
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="q2">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#a2">å¦‚ä½•é€²å…¥ä¸‹è¼‰æ¨¡å¼ï¼Ÿ</button>
                </h2>
                <div id="a2" class="accordion-collapse collapse" data-bs-parent="#faq" tabindex="-1">
                  <div class="accordion-body">
                    ESP-01Mï¼ˆESP8285/8266ï¼‰ï¼šä¸Šé›»æ™‚ <span class="code">GPIO0</span> æ‹‰ä½ã€<span class="code">EN/CH_PD</span> æ‹‰é«˜ï¼›
                    ESP32-C3ï¼šæŒ‰ä½ <span class="code">BOOT/IO9</span> ä¸Šé›»ï¼›
                    ESP32-CAM ä¾æ¿è¼‰æŒ‰éµæˆ–çŸ­æ¥æ–¹å¼é€²å…¥ã€‚
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="q3">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#a3">ä¸Šå‚³è‡ªé¸æª”å®‰å…¨å—ï¼Ÿ</button>
                </h2>
                <div id="a3" class="accordion-collapse collapse" data-bs-parent="#faq" tabindex="-1">
                  <div class="accordion-body">
                    å®‰å…¨ã€‚æª”æ¡ˆä»¥ <em>æœ¬æ©Ÿ Blob URL</em> æ–¹å¼ä½¿ç”¨ï¼Œä¸æœƒä¸Šå‚³åˆ°ä¼ºæœå™¨ï¼›ä½ äº¦å¯æ¯”å° SHA-256ã€‚
                  </div>
                </div>
              </div>
            </div>
            <div class="text-body-secondary small mt-2">ï¼Šè‹¥æŒ‰éˆ•ä»ç„¡åæ‡‰ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦å…è¨±ã€Œç¶²ç«™å¯å­˜å–åºåˆ—åŸ ã€ã€‚</div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="container my-5 footer">
    <div class="d-flex flex-wrap justify-content-between align-items-center">
      <div>Â© <span id="year"></span> EWC IoT ProDeck Â· All rights reserved.</div>
      <div>ç‰ˆæœ¬ï¼š<span class="code">v<span id="appVersionFoot"></span></span></div>
    </div>
  </footer>

  <!-- Changelog Modal -->
  <div class="modal fade" id="changelogModal" tabindex="-1" aria-labelledby="changelogLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="changelogLabel">ç‰ˆæœ¬èªªæ˜ï¼ˆRelease Notesï¼‰</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
        </div>
        <div class="modal-body">
          <pre id="changelog" class="mb-0 small"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const $ = (sel) => document.querySelector(sel);

    // ===== Live Console =====
    const consoleBox = $("#liveConsole");
    function log(msg, level = "info") {
      const ts = new Date().toLocaleTimeString();
      const line = `[${level.toUpperCase()}] <span class="ts">${ts}</span> ${msg}`;
      consoleBox.insertAdjacentHTML("beforeend", line + "<br>");
      consoleBox.scrollTop = consoleBox.scrollHeight;
    }
    $("#clearConsoleBtn").addEventListener("click", () => { consoleBox.textContent = ""; });
    $("#copyConsoleBtn").addEventListener("click", async () => {
      try { await navigator.clipboard.writeText(consoleBox.innerText); } catch (e) { }
    });

    // ç‰ˆæœ¬é¡¯ç¤º
    $("#appVersionLabel").textContent = APP_VERSION;
    $("#appVersionFoot").textContent = APP_VERSION;
    $("#year").textContent = new Date().getFullYear();
    if (window.__EWC_JUST_UPDATED__) {
      $("#updatedVersion").textContent = APP_VERSION;
      $("#updateToast").classList.remove("d-none");
      log(`å·²æ›´æ–°è‡³ v${APP_VERSION}`, "ok");
    }

    // Release Notes
    const RELEASE_NOTES = [
      {
        v: "2.0.5", date: "2025-11-30", notes: [
          "æ–°å¢ï¼šé€šç”¨ç‡’éŒ„å€å¡Šï¼ˆESP32-C3ï¼‰",
          "ç§»é™¤ï¼šESP32-C3 é è¨­é¸é …ï¼ˆæ”¹ç‚ºé€šç”¨ç‡’éŒ„ï¼‰"
        ]
      },
      {
        v: "2.0.4", date: "2025-11-30", notes: [
          "æ–°å¢ï¼šæ”¯æ´ ESP32-C3 é è¨­ç‡’éŒ„é¸é …"
        ]
      },
      {
        v: "2.0.3", date: "2025-09-26", notes: [
          "æ–°å¢ï¼šç‡’éŒ„äº‹ä»¶ Consoleï¼ˆæ¸…é™¤/è¤‡è£½ã€å³æ™‚ç´€éŒ„æµç¨‹ï¼‰",
          "ä¿®æ­£ï¼šFAQ æŒ‰éˆ•å¿…å®šå±•é–‹ç¬¬ 1 é¡Œä¸¦æ²å‹•",
          "å„ªåŒ–ï¼šæ›´å¤šæ­¥é©Ÿç¯€é»å¯«å…¥ Console"
        ]
      },
      {
        v: "2.0.2", date: "2025-09-26", notes: [
          "ä¿®æ­£ï¼šæ·±è‰²æ¨¡å¼ Hero å€åŸŸå°æ¯”",
          "æ–°å¢ï¼šé€šç”¨ç‡’éŒ„ï¼ˆESP8266/ESP8285ï½œESP-01Mï¼‰ï¼Œä¸å‹•åŸ manifest"
        ]
      },
      {
        v: "2.0.1", date: "2025-09-26", notes: [
          "æŒ‰éˆ•æ¨£å¼èˆ‡ä½ç½®ã€d-none åˆ‡æ›å„ªåŒ–"
        ]
      }
    ];
    $("#changelog").textContent = RELEASE_NOTES
      .map(x => `v${x.v} â€” ${x.date}\n - ${x.notes.join("\n - ")}`).join("\n\n");

    // ç’°å¢ƒæª¢æŸ¥
    (function () {
      const alertBox = $("#envAlert"); const msgs = [];
      if (!(location.protocol === "https:" || location.hostname === "localhost"))
        msgs.push("è«‹ä»¥ HTTPS æˆ– localhost é–‹å•Ÿæœ¬é ï¼Œå¦å‰‡ç€è¦½å™¨å¯èƒ½ç¦æ­¢å­˜å–åºåˆ—åŸ ã€‚");
      const isChrome = /Chrome/i.test(navigator.userAgent) && !/Edg/i.test(navigator.userAgent);
      const isEdge = /Edg/i.test(navigator.userAgent);
      if (!isChrome && !isEdge) msgs.push("å»ºè­°ä½¿ç”¨ Chrome æˆ– Edge ä»¥æ”¯æ´ Web Serialã€‚");
      if (!("serial" in navigator)) msgs.push("æ­¤ç€è¦½å™¨æœªæä¾› Web Serial APIã€‚");
      if (msgs.length) { alertBox.textContent = msgs.join(" "); alertBox.classList.remove("d-none"); }
      log("ç’°å¢ƒæª¢æŸ¥å®Œæˆï¼š" + (msgs.length ? msgs.join(" / ") : "OK"), msgs.length ? "warn" : "ok");
    })();

    // â‘  é è¨­æ¸…å–®ç‡’éŒ„ï¼ˆä¿ç•™åŸ manifestï¼‰
    (function () {
      const form = $("#presetForm"); const btn = $("#presetBtn");
      form.addEventListener("change", () => {
        const sel = form.querySelector('input[name="type"]:checked')?.value;
        if (!sel) return;
        btn.manifest = `./manifest_${sel}.json${VQ}`;
        btn.classList.remove("d-none");
        btn.classList.add("btn-primary", "install-ready");
        log(`å·²é¸æ“‡é è¨­å‹è™Ÿï¼š${sel}ï¼Œè¼‰å…¥ manifest_` + sel + `.json`);
      });
      btn?.addEventListener("click", () => log("é è¨­ç‡’éŒ„ï¼šæŒ‰ä¸‹é–‹å§‹ç‡’éŒ„", "ok"));
    })();

    // â‘¡ é€šç”¨ç‡’éŒ„ï¼ˆESP8266/ESP8285ï½œESP-01Mï¼‰
    (function () {
      const fileInput = $("#espGenericBin"); const info = $("#fileInfoGeneric");
      const installBtn = $("#espGenericBtn");
      let lastManifestURL = null, lastBinURL = null;

      async function sha256(file) {
        const buf = await file.arrayBuffer();
        const hash = await crypto.subtle.digest("SHA-256", buf);
        return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2, "0")).join("");
      }

      fileInput.addEventListener("change", async () => {
        const file = fileInput.files?.[0]; if (!file) return;
        log(`é€šç”¨ç‡’éŒ„ï¼šé¸æ“‡æª”æ¡ˆ ${file.name}ï¼ˆ${(file.size / 1024).toFixed(1)} KBï¼‰`);

        // æª”æ¡ˆè³‡è¨Š + SHA256
        info.textContent = "è¨ˆç®—æ ¡é©—ä¸­â‹¯";
        const digest = await sha256(file);
        info.innerHTML = `æª”åï¼š<span class="code">${file.name}</span>ï¼Œ
                        å¤§å°ï¼š${(file.size / 1024).toFixed(1)} KBï¼Œ
                        SHA-256ï¼š<span class="code">${digest}</span>`;
        log(`SHA-256ï¼š${digest}`);

        // Blob URL
        if (lastBinURL) URL.revokeObjectURL(lastBinURL);
        lastBinURL = URL.createObjectURL(file);

        // å‹•æ…‹ manifestï¼ˆESP8266/ESP8285 å–®æª” offset 0ï¼‰
        const manifest = {
          name: "EWC-Generic-ESP8266-8285",
          version: new Date().toISOString().slice(0, 19).replace("T", " "),
          new_install_prompt_erase: true,
          builds: [{ chipFamily: "ESP8266", parts: [{ path: lastBinURL, offset: 0 }] }]
        };

        const blob = new Blob([JSON.stringify(manifest)], { type: "application/json" });
        if (lastManifestURL) URL.revokeObjectURL(lastManifestURL);
        lastManifestURL = URL.createObjectURL(blob);

        installBtn.manifest = lastManifestURL;
        installBtn.classList.remove("d-none");
        installBtn.classList.add("btn-primary", "install-ready");
        log("å·²å»ºç«‹è‡¨æ™‚ manifestï¼ˆESP8266/ESP8285, offset=0ï¼‰", "ok");
      });

      installBtn?.addEventListener("click", () => log("é€šç”¨ç‡’éŒ„ï¼šæŒ‰ä¸‹é–‹å§‹ç‡’éŒ„", "ok"));
    })();

    // â‘¢ é€šç”¨ç‡’éŒ„ï¼ˆESP32-C3ï¼‰
    (function () {
      const fileInput = $("#espGenericBinC3"); const info = $("#fileInfoGenericC3");
      const installBtn = $("#espGenericBtnC3");
      let lastManifestURL = null, lastBinURL = null;

      async function sha256(file) {
        const buf = await file.arrayBuffer();
        const hash = await crypto.subtle.digest("SHA-256", buf);
        return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2, "0")).join("");
      }

      fileInput.addEventListener("change", async () => {
        const file = fileInput.files?.[0]; if (!file) return;
        log(`C3 é€šç”¨ç‡’éŒ„ï¼šé¸æ“‡æª”æ¡ˆ ${file.name}ï¼ˆ${(file.size / 1024).toFixed(1)} KBï¼‰`);

        info.textContent = "è¨ˆç®—æ ¡é©—ä¸­â‹¯";
        const digest = await sha256(file);
        info.innerHTML = `æª”åï¼š<span class="code">${file.name}</span>ï¼Œ
                        å¤§å°ï¼š${(file.size / 1024).toFixed(1)} KBï¼Œ
                        SHA-256ï¼š<span class="code">${digest}</span>`;
        log(`SHA-256ï¼š${digest}`);

        if (lastBinURL) URL.revokeObjectURL(lastBinURL);
        lastBinURL = URL.createObjectURL(file);

        // å‹•æ…‹ manifestï¼ˆESP32-C3, offset 0ï¼‰
        const manifest = {
          name: "EWC-Generic-ESP32-C3",
          version: new Date().toISOString().slice(0, 19).replace("T", " "),
          new_install_prompt_erase: true,
          builds: [{ chipFamily: "ESP32-C3", parts: [{ path: lastBinURL, offset: 0 }] }]
        };

        const blob = new Blob([JSON.stringify(manifest)], { type: "application/json" });
        if (lastManifestURL) URL.revokeObjectURL(lastManifestURL);
        lastManifestURL = URL.createObjectURL(blob);

        installBtn.manifest = lastManifestURL;
        installBtn.classList.remove("d-none");
        installBtn.classList.add("btn-primary", "install-ready");
        log("å·²å»ºç«‹è‡¨æ™‚ manifestï¼ˆESP32-C3, offset=0ï¼‰", "ok");
      });

      installBtn?.addEventListener("click", () => log("C3 é€šç”¨ç‡’éŒ„ï¼šæŒ‰ä¸‹é–‹å§‹ç‡’éŒ„", "ok"));
    })();

    // å·¥å…·ï¼šæ¸¬è©¦åºåˆ—åŸ 
    $("#testPortBtn").addEventListener("click", async () => {
      if (!("serial" in navigator)) { alert("ç€è¦½å™¨ä¸æ”¯æ´ Web Serialã€‚è«‹æ”¹ç”¨ Chrome / Edgeã€‚"); log("ç€è¦½å™¨ç„¡ Web Serial", "err"); return; }
      try { await navigator.serial.requestPort({}); alert("åºåˆ—åŸ å¯ä½¿ç”¨ âœ…"); log("åºåˆ—åŸ å¯ç”¨", "ok"); }
      catch (e) { log("åºåˆ—åŸ æ¸¬è©¦å–æ¶ˆæˆ–å¤±æ•—ï¼š" + (e?.message || e), "warn"); }
    });

    // å·¥å…·ï¼šæ‰“é–‹ FAQï¼ˆå±•é–‹ç¬¬ä¸€é …ä¸¦æ²å‹•ï¼›è‹¥ bootstrap ä¸å¯ç”¨ä¹Ÿæœƒ fallbackï¼‰
    $("#openFaqBtn").addEventListener("click", () => {
      const firstCollapse = document.getElementById("a1");
      try {
        if (firstCollapse) {
          if (window.bootstrap?.Collapse) {
            const c = bootstrap.Collapse.getOrCreateInstance(firstCollapse, { toggle: false });
            c.show();
          } else {
            firstCollapse.classList.add("show");
          }
          firstCollapse.focus({ preventScroll: true });
          document.getElementById("faq").scrollIntoView({ behavior: "smooth", block: "start" });
          log("å·²é–‹å•Ÿ FAQï¼ˆç¬¬ 1 é¡Œï¼‰", "ok");
        }
      } catch (e) { log("é–‹å•Ÿ FAQ ä¾‹å¤–ï¼š" + (e?.message || e), "err"); }
    });
  </script>
</body>

</html>