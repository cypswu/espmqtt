<!--
===============================================================================
  æª”æ¡ˆåç¨±ï¼šindex.html
  å°ˆæ¡ˆåç¨±ï¼šå“èŒ¶ QR Code ç®¡ç†ç³»çµ±
  ç‰ˆæœ¬è™Ÿç¢¼ï¼šv1.6.0ã€€(2025-05-01)
  Author  : lung / ChatGPT-o3 collaborative draft
-------------------------------------------------------------------------------
  åŠŸèƒ½æ‘˜è¦ï¼š
    Â· ä»¥å–®é æ‡‰ç”¨ï¼ˆSPAï¼‰å½¢å¼ï¼Œè¼¸å…¥èŒ¶è‘‰è³‡æ–™ âœ ç”¢ç”Ÿ / æƒæ QR Code
    Â· æ”¯æ´ PNG ä¸‹è¼‰ã€ File System Access API å„²å­˜ã€JSON é›²ç«¯æ¨¡å¼
    Â· ä¸‰åˆ†é å°è¦½ï¼šç”¢ç”Ÿï½œæƒæï½œä½¿ç”¨èªªæ˜ï¼›Tooltip èˆ‡å³æ™‚é©—è­‰å¼·åŒ– UX
-------------------------------------------------------------------------------
  Authors & Tools :
    â–¸ Author   : cypswu
    â–¸ Generated : Gemini 2.5 Pro (initial scaffolding)
    â–¸ Modified  : ChatGPT-o3 (UX & code refinement)
-------------------------------------------------------------------------------
  ä¸»è¦ç›¸ä¾ï¼š
    â–¸ Bootstrap 5.3.2ã€€(CSS / JS bundle)
    â–¸ Bootstrap Icons 1.11
    â–¸ QRious 4.0.2
    â–¸ html5-qrcode 2.3.8
-------------------------------------------------------------------------------
  ç€è¦½å™¨æ”¯æ´ï¼š
    Â· Chrome / Edge 96+ï¼ˆå®Œæ•´æ”¯æ´ File System Access APIï¼‰
    Â· Firefox 95+ï¼ˆè‡ªå‹•é™ç´šç‚º <a download> ä¸‹è¼‰ï¼‰
    Â· è¡Œå‹•ç€è¦½å™¨å‡å¯æ“ä½œæƒæèˆ‡æª”æ¡ˆè¼‰å…¥
-------------------------------------------------------------------------------
  ç‰ˆæ¬Šå®£å‘Šï¼šMIT License
-------------------------------------------------------------------------------
  ä¿®è¨‚ç´€éŒ„ï¼š
    â–¸ v1.6.0 â€” 2025-05-01
        - æ–°å¢ã€Œä½¿ç”¨èªªæ˜ã€åˆ†é èˆ‡å¿«é€Ÿå°è¦½
        - åŠ å…¥ File System Access API / <a download> æ··åˆä¸‹è¼‰æ–¹æ¡ˆ
        - æå‡ Tooltipã€Spinner èˆ‡å…¨åŸŸè¨Šæ¯å¯ç”¨æ€§
===============================================================================
-->
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“èŒ¶ QR Code ç®¡ç†ç³»çµ±</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #5a7d2c;
            --secondary-color: #d4c3a0;
            --background-gradient: linear-gradient(to bottom right, #f8f5f0, #e9e0d1); /* Slightly adjusted gradient */
            --text-color: #333;
            --card-border-color: #e0d8c7;
            --accordion-button-bg: #f8f9fa;
            --accordion-button-active-bg: #e7f0e1;
        }

        body {
            font-family: 'Noto Serif TC', serif;
            background: var(--background-gradient);
            color: var(--text-color);
            padding-bottom: 70px; /* Increased padding */
        }

        h1, h2, h3, h4, h5, h6, .navbar-brand, .nav-link.active, .accordion-button:not(.collapsed) {
            font-family: 'Playfair Display', serif;
            color: var(--primary-color);
        }
        h1 {
            font-weight: 700;
        }

        .nav-tabs {
             border-bottom: 1px solid var(--card-border-color);
        }

        .nav-tabs .nav-link {
            color: var(--primary-color);
            border: 1px solid transparent; /* Add transparent border for consistent height */
             margin-bottom: -1px; /* Overlap border */
             border-top-left-radius: 0.375rem;
             border-top-right-radius: 0.375rem;
             padding: 0.75rem 1.25rem; /* Slightly larger padding */
        }

        .nav-tabs .nav-link.active {
            background-color: #fff; /* Make active tab background white */
            border-color: var(--card-border-color) var(--card-border-color) #fff; /* Match card border */
            font-weight: bold;
            color: var(--primary-color);
        }
         .nav-tabs .nav-link:hover:not(.active) {
             border-color: transparent transparent var(--card-border-color) transparent;
             background-color: #f8f5f0; /* Slight hover effect */
         }

        .tab-content {
            padding-top: 1.5rem; /* Add space below tabs */
        }

        .accordion-item {
            border: 1px solid var(--card-border-color);
            margin-bottom: 0.5rem; /* Add space between items */
            border-radius: 0.375rem; /* Rounded corners for items */
            overflow: hidden; /* Ensure children conform to rounded corners */
        }
        .accordion-item:first-of-type {
             border-top-left-radius: 0.375rem;
             border-top-right-radius: 0.375rem;
        }
         .accordion-item:last-of-type {
             border-bottom-left-radius: 0.375rem;
             border-bottom-right-radius: 0.375rem;
             margin-bottom: 0;
         }

        .accordion-button {
            background-color: var(--accordion-button-bg);
            color: var(--text-color);
            font-weight: bold; /* Make section titles bolder */
            border-bottom: 1px solid var(--card-border-color); /* Separator line */
        }
         .accordion-item:last-of-type .accordion-button.collapsed {
             border-bottom: 0; /* Remove border if last item and collapsed */
         }

        .accordion-button:not(.collapsed) {
            background-color: var(--accordion-button-active-bg);
            color: var(--primary-color); /* Use primary color when active */
            box-shadow: inset 0 -1px 0 var(--card-border-color); /* Keep bottom border */
        }

        .accordion-button:focus {
            box-shadow: 0 0 0 0.2rem rgba(90, 125, 44, 0.25); /* Primary color focus */
            z-index: 3; /* Ensure focus outline is visible */
        }
        .accordion-body {
            background-color: #fff; /* White background for content */
        }

        .btn {
             border-radius: 0.375rem;
             padding: 0.5rem 1rem; /* Consistent padding */
             font-weight: 500; /* Slightly bolder text */
             transition: all 0.2s ease-in-out; /* Smoother transitions */
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #486423;
            border-color: #486423;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #c3b28f;
            border-color: #c3b28f;
            transform: translateY(-1px);
             box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
         .btn-success { /* Style save button */
             background-color: #28a745;
             border-color: #28a745;
         }
         .btn-success:hover {
             background-color: #218838;
             border-color: #1e7e34;
             transform: translateY(-1px);
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
         }
         .btn-outline-secondary {
             color: var(--primary-color);
             border-color: var(--primary-color);
         }
         .btn-outline-secondary:hover {
             background-color: var(--accordion-button-active-bg);
             color: var(--primary-color);
         }


        .card {
            border: 1px solid var(--card-border-color);
            border-radius: 0.5rem;
            box-shadow: 0 6px 12px rgba(0,0,0,0.08); /* Slightly softer shadow */
            background-color: #fff; /* Ensure card background is white */
        }
        .card-body {
            padding: 1.5rem; /* More padding in cards */
        }

        .form-control, .form-select {
            border-radius: 0.375rem;
            border: 1px solid #ced4da;
        }
        .form-control:focus, .form-select:focus {
             border-color: #a8c589; /* Primary color related focus */
             box-shadow: 0 0 0 0.2rem rgba(90, 125, 44, 0.25);
        }
        .form-label {
            margin-bottom: 0.5rem;
            font-weight: 500; /* Slightly bolder labels */
        }

        #qrCodeResult img,
        #qrCodeResult canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid var(--card-border-color);
            border-radius: 0.375rem;
            margin-top: 1rem;
            background-color: white; /* Ensure QR code background is white */
            padding: 10px; /* Add padding around QR code */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        #reader {
            width: 100%; /* Make reader take full width of container */
            max-width: 400px; /* Limit max width */
            margin: 1rem auto; /* Center and add margin */
            border: 2px dashed var(--secondary-color); /* Dashed border */
            border-radius: 0.5rem;
            overflow: hidden; /* Ensure rounded corners */
            background-color: #f8f9fa; /* Light background for reader area */
        }
        #reader video { /* Style the video element if possible */
             display: block;
             width: 100%;
             height: auto;
        }


        .list-group-item {
            word-break: break-word; /* Avoid long string overflow */
            padding: 0.75rem 1.25rem;
            border-color: var(--card-border-color); /* Match card border */
            background-color: #fff; /* Ensure white background */
        }
        .list-group-item:first-child {
             border-top-left-radius: 0; /* Remove radius if inside card */
             border-top-right-radius: 0;
        }
        .list-group-item:last-child {
             border-bottom-left-radius: 0;
             border-bottom-right-radius: 0;
        }

        .list-group-item strong {
             color: var(--primary-color);
             margin-right: 0.5em; /* Space after label */
        }

        .list-group-item img {
            max-width: 100%;
            height: auto;
            max-height: 250px; /* Increased max height */
            margin-top: 8px;
            border-radius: 0.375rem;
            border: 1px solid var(--card-border-color);
            display: block; /* Ensure image is block level */
        }
        .list-group-item pre { /* Style for textarea display */
            white-space: pre-wrap;
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            background-color: #f8f9fa; /* Slight background for pre */
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-top: 5px;
        }

        /* Hide default file input */
        input[type="file"] {
            display: none;
        }
        /* Custom file upload button style */
        .custom-file-upload {
            border: 1px solid var(--primary-color);
            display: inline-block;
            padding: 0.375rem 0.75rem; /* Match form control padding */
            cursor: pointer;
            background-color: #fff;
            color: var(--primary-color);
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
            margin-right: 5px; /* Space next to filename */
        }
        .custom-file-upload:hover {
            background-color: var(--accordion-button-active-bg);
        }
        .file-name-display {
            font-style: italic;
            color: #6c757d;
            font-size: 0.9em;
        }
        #productImageFilePreview img {
             max-width: 100%; /* Allow image to scale */
             max-height: 200px;
             margin-top: 10px;
             border-radius: 0.375rem;
             border: 1px solid var(--card-border-color);
        }
        .alert {
            border-radius: 0.375rem;
            padding: 1rem 1.25rem;
        }
        .debug-info {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-4 mb-5">
        <header class="text-center mb-5">
            <h1 class="display-5">å“èŒ¶ QR Code ç®¡ç†ç³»çµ±</h1>
        </header>

        <ul class="nav nav-tabs mb-4" id="teaTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="generate-tab" data-bs-toggle="tab" data-bs-target="#generateTabPane" type="button" role="tab" aria-controls="generateTabPane" aria-selected="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-qr-code-scan me-1" viewBox="0 0 16 16"><path d="M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5zM.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7 2H2v5h5V2ZM3 3h3v3H3V3Zm2 8H4v1h1v-1Z"/><path d="M7 9H2v5h5V9Zm-4 1h3v3H3v-3Zm8-6h1v1h-1V4Z"/><path d="M9 2h5v5H9V2Zm1 1v3h3V3h-3ZM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8H8Zm2 2H9V9h1v1Zm4 2h-1v1h-2v1h3v-2Zm-4 2v-1H8v1h2Z"/><path d="M12 9h2V8h-2v1Z"/></svg>
                    ç”¢ç”Ÿ QR Code
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="scan-tab" data-bs-toggle="tab" data-bs-target="#scanTabPane" type="button" role="tab" aria-controls="scanTabPane" aria-selected="false">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-fill me-1" viewBox="0 0 16 16"> <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/> <path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1m9-1a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0"/> </svg>
                    æƒæ QR Code
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#helpTabPane" type="button" role="tab" aria-controls="helpTabPane" aria-selected="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle me-1" viewBox="0 0 16 16"> <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1m0 1a6 6 0 1 1 0 12A6 6 0 0 1 8 2m.93 4.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.194.897c-.194.897.105 1.319.808 1.319.545 0 .934-.252 1.019-.598l.088-.416c.063-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287.082-.38-.45-.083c-.294-.07-.352-.176-.288-.469l.194-.897c.194-.897-.105-1.319-.808-1.319-.545 0-.934.252-1.019.598l-.088.416c-.063.293-.006.399.287.47l.451.081-.082.381z"/> <circle cx="8" cy="4.5" r="1"/> </svg>
                    ä½¿ç”¨èªªæ˜
                </button>
            </li>
        </ul>

        <div class="tab-content" id="teaTabsContent">
            <div class="tab-pane fade show active" id="generateTabPane" role="tabpanel" aria-labelledby="generate-tab" tabindex="0">
                <div class="card mb-4">
                    <div class="card-body">
                        <form id="teaForm">
                            <div class="accordion" id="teaFormAccordion">
                                </div>

                            <div class="d-flex justify-content-between align-items-center mt-4 flex-wrap gap-3">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill me-1" viewBox="0 0 16 16"> <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"/> </svg>
                                    ç”¢ç”Ÿ QR Code
                                </button>
                                <div>
                                    <label for="loadQrInput" class="btn btn-secondary custom-file-upload">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16"> <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/> <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/> </svg>
                                        è¼‰å…¥ QR Code
                                    </label>
                                    <input type="file" id="loadQrInput" accept="image/png, image/jpeg, image/gif">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="qrCodeResult" class="mt-4 text-center" style="display: none;">
                     <div class="card">
                         <div class="card-body">
                             <h3 class="h5 mb-3">ç”¢ç”Ÿçš„ QR Code:</h3>
                             <canvas id="qrCanvas" width="420" height="420"></canvas>
                             <div id="qrCodeImageContainer"></div>
                             <button id="saveQrButton" class="btn btn-success mt-3">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16"> <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/> <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/> </svg>
                                 å„²å­˜ QR Code
                             </button>
                         </div>
                     </div>
                </div>

                <div id="cloudModeSection" class="mt-4 card" style="display: none;">
                    <div class="card-body">
                        <h3 class="h5 text-warning mb-3">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill me-1" viewBox="0 0 16 16"> <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/> </svg>
                            è³‡æ–™é‡éå¤§ï¼Œè«‹ä½¿ç”¨é›²ç«¯æ¨¡å¼
                        </h3>
                        <p class="mb-2">å£“ç¸®å¾Œçš„è³‡æ–™å¤§å°è¶…é QR Code å®¹é‡ä¸Šé™ (<span id="compressedSizeInfo"></span> bytes)ã€‚</p>
                        <p>è«‹å°‡ä¸‹æ–¹ JSON è³‡æ–™è¤‡è£½ä¸¦å„²å­˜åˆ°æ‚¨é¸æ“‡çš„é›²ç«¯ç©ºé–“ï¼ˆä¾‹å¦‚ï¼š<a href="https://gist.github.com/" target="_blank" rel="noopener noreferrer">GitHub Gist</a>, <a href="https://pastebin.com/" target="_blank" rel="noopener noreferrer">Pastebin</a> ç­‰ï¼Œ**è«‹ç¢ºä¿è¨­ç‚ºå…¬é–‹æˆ–æ“æœ‰é€£çµè€…å¯è®€**ï¼‰ï¼Œç„¶å¾Œå°‡ç”¢ç”Ÿçš„**åŸå§‹è³‡æ–™é€£çµ (Raw URL)** è²¼å›ä¸‹æ–¹ã€‚</p>
                        <div class="mb-3">
                            <label for="jsonDataDisplay" class="form-label">å®Œæ•´ JSON è³‡æ–™:</label>
                            <textarea id="jsonDataDisplay" class="form-control" rows="6" readonly></textarea>
                            <button id="copyJsonButton" class="btn btn-sm btn-outline-secondary mt-2">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard me-1" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/> </svg>
                                è¤‡è£½ JSON
                            </button>
                        </div>
                        <div class="mb-3">
                            <label for="cloudUrlInput" class="form-label">è²¼ä¸Šæ‚¨çš„é›²ç«¯è³‡æ–™é€£çµ (Raw URL):</label>
                            <input type="url" id="cloudUrlInput" class="form-control" placeholder="ä¾‹å¦‚ï¼šhttps://gist.githubusercontent.com/.../raw/...">
                        </div>
                        <button id="generateLinkQrButton" class="btn btn-primary">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link-45deg me-1" viewBox="0 0 16 16"> <path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1 1 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4 4 0 0 1-.128-1.287z"/> <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243z"/> </svg>
                            ä½¿ç”¨é€£çµç”¢ç”Ÿ QR Code
                        </button>
                    </div>
                </div>

                <div id="generateMessage" class="alert mt-4 d-none" role="alert"></div>
            </div>

            <div class="tab-pane fade" id="scanTabPane" role="tabpanel" aria-labelledby="scan-tab" tabindex="0">
                 <div class="card mb-4">
                     <div class="card-body text-center">
                        <h3 class="h5 mb-3">æƒæ QR Code</h3>
                        <p class="text-muted">å°‡ QR Code ç½®æ–¼ä¸‹æ–¹æƒæå€åŸŸå…§</p>
                        <div id="reader"></div>
                         <div id="scanMessage" class="alert alert-info mt-3 d-none" role="alert">
                            æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...
                        </div>
                     </div>
                 </div>

                 <div id="scanResult" class="mt-4 card" style="display: none;">
                     <div class="card-body">
                        <h3 class="h5 mb-3">æƒæçµæœ:</h3>
                        <ul id="scanResultList" class="list-group list-group-flush">
                            </ul>
                     </div>
                 </div>

            </div>
            
            <!-- ä½¿ç”¨èªªæ˜é ç±¤å…§å®¹ -->
            <div class="tab-pane fade" id="helpTabPane" role="tabpanel" aria-labelledby="help-tab" tabindex="0">
                <!-- ===== ä½¿ç”¨èªªæ˜ï¼ˆBeginï¼‰ ===== -->
                <div class="card">
                    <div class="card-body">

                        <!-- â­• 1. å¿«é€Ÿå°è¦½ -->
                        <h2 class="h5 mb-3">
                            <i class="bi bi-compass me-1"></i> å¿«é€Ÿå°è¦½ â€§ ä¸‰æ­¥é©Ÿ
                        </h2>
                        <ol class="ps-3 mb-4">
                            <li><strong>è¼¸å…¥è³‡æ–™</strong>ï¼šåˆ‡åˆ° <em>ç”¢ç”Ÿ QR Code</em> åˆ†é ï¼Œå¡«å…¥èŒ¶è‘‰è³‡è¨Šå¾Œé» <kbd>ç”¢ç”Ÿ QR Code</kbd>ã€‚</li>
                            <li><strong>é è¦½æª¢æŸ¥</strong>ï¼šç³»çµ±å³æ™‚é¡¯ç¤º QR åœ–åƒèˆ‡ JSON å£“ç¸®å­—ä¸²ï¼›å¦‚éœ€ä¿®æ”¹ï¼Œå¯ç›´æ¥è¿”å›ç·¨è¼¯ã€‚</li>
                            <li><strong>ä¸‹è¼‰ / é‚„åŸ</strong>ï¼šæŒ‰ <kbd>å„²å­˜ QR Code</kbd> ä¸‹è¼‰ PNGï¼›æˆ–åˆ©ç”¨ <kbd>è¼‰å…¥ QR Code</kbd> / <em>æƒæ QR Code</em> åˆ†é éš¨æ™‚å›å¡«ã€‚</li>
                        </ol>

                        <!-- ğŸ’¡ 2. é€²éšæŠ€å·§ -->
                        <h2 class="h5 mb-3">
                            <i class="bi bi-lightbulb me-1"></i> é€²éšæŠ€å·§
                        </h2>
                        <ul class="ps-3 mb-4">
                            <li>è‹¥è³‡æ–™é‡éå¤§ï¼Œç³»çµ±æœƒè‡ªå‹•å•Ÿç”¨ <strong>é›²ç«¯æ¨¡å¼</strong>ï¼Œä¸¦å¼•å°ä½ è¤‡è£½ JSON-URL ä»¥ç¸®çŸ­ QR å®¹é‡ã€‚</li>
                            <li>ä¸‹è¼‰æ™‚å¯è‡ªè¨‚æª”åï¼Œæ–¹ä¾¿ä¾èŒ¶æ¬¾æˆ–æ‰¹æ¬¡æ­¸æª”ã€‚</li>
                            <li>æ¡Œæ©Ÿèˆ‡æ‰‹æ©Ÿçš†å¯æ“ä½œï¼›æ‰‹æ©Ÿå¯ç›´æ¥ç”¨ç›¸æ©Ÿæƒæ QR é‚„åŸè³‡æ–™ã€‚</li>
                        </ul>

                        <!-- â“ 3. å¸¸è¦‹å•é¡Œ -->
                        <h2 class="h5 mb-2">
                            <i class="bi bi-question-circle me-1"></i> å¸¸è¦‹å•é¡Œ
                        </h2>
                        <p class="mb-1"><strong>Q1 ï¼šæƒæä¸åˆ° QRï¼Ÿ</strong></p>
                        <p>A ï¼šè«‹ç¢ºèªå½±åƒæ¸…æ™°ã€å…‰ç·šå……è¶³ï¼Œä¸¦ä¿æŒé¡é ­å°ç„¦æ–¼æ•´å€‹ QRã€‚</p>

                        <p class="mb-1"><strong>Q2 ï¼šQR å…§æ˜¯äº‚ç¢¼ï¼Œçœ‹ä¸æ‡‚ï¼Ÿ</strong></p>
                        <p>A ï¼šé‚£æ˜¯ç³»çµ±è‡ªå‹•å£“ç¸®çš„å­—ä¸²ï¼Œç›´æ¥æƒææˆ–è¼‰å…¥å³å¯è§£æï¼Œä¸éœ€äººå·¥é–±è®€ã€‚</p>

                        <p class="mb-1"><strong>Q3 ï¼šæƒ³é‡æ–°ç·¨è¼¯è³‡æ–™ï¼Ÿ</strong></p>
                        <p>A ï¼šå…ˆè¼‰å…¥æ—¢æœ‰ QR âœ ä¿®æ”¹è¡¨å–® âœ å†é» <kbd>ç”¢ç”Ÿ QR Code</kbd> å³å¯è¦†è“‹èˆŠæª”ã€‚</p>

                    </div>
                </div>
                <!-- ===== ä½¿ç”¨èªªæ˜ï¼ˆEndï¼‰ ===== -->
            </div>
            
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script>
        // --- Configuration ---
        const fieldConfig = [
            // åŸºæœ¬è³‡è¨Š (Basic)
            { id: 'teaName', label: 'å“å', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼šé˜¿é‡Œå±±é‡‘è±', type: 'text', col: 'col-md-6' },
            { id: 'teaType', label: 'èŒ¶é¡', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼šçƒé¾èŒ¶', type: 'text', col: 'col-md-6' },
            { id: 'cultivar', label: 'å“ç¨®', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼šé‡‘è± (å°èŒ¶12è™Ÿ)', type: 'text', col: 'col-md-6' },
            { id: 'originRegion', label: 'ç”¢åœ°', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼šå°ç£å˜‰ç¾©ç¸£é˜¿é‡Œå±±é„‰', type: 'text', col: 'col-md-6' },
            { id: 'producer', label: 'ç”Ÿç”¢è€…/èŒ¶å» ', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼šXXèŒ¶æ¥­', type: 'text', col: 'col-md-6' },
            { id: 'altitude', label: 'æµ·æ‹” (å…¬å°º)', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼š1200', type: 'number', col: 'col-md-6' },
            { id: 'harvestDate', label: 'æ¡æ”¶æ—¥æœŸ', section: 'basic', placeholder: '', type: 'date', col: 'col-md-6' },
            { id: 'harvestSeason', label: 'æ¡æ”¶å­£ç¯€', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼šæ˜¥å­£', type: 'text', col: 'col-md-6' },
            // å¸¸ç”¨è³‡è¨Š (Common)
            { id: 'grade', label: 'ç­‰ç´š', section: 'common', placeholder: 'ä¾‹å¦‚ï¼šç‰¹ç´š', type: 'text', col: 'col-md-4' },
            { id: 'batchNo', label: 'æ‰¹è™Ÿ', section: 'common', placeholder: 'ä¾‹å¦‚ï¼š202405A', type: 'text', col: 'col-md-4' },
            { id: 'netWeight', label: 'æ·¨é‡ (å…‹)', section: 'common', placeholder: 'ä¾‹å¦‚ï¼š150', type: 'number', col: 'col-md-4' },
            { id: 'teaMaster', label: 'è£½èŒ¶å¸«', section: 'common', placeholder: 'ä¾‹å¦‚ï¼šç‹å°æ˜', type: 'text', col: 'col-md-4' },
            { id: 'packagingDate', label: 'åŒ…è£æ—¥æœŸ', section: 'common', placeholder: '', type: 'date', col: 'col-md-4' },
            { id: 'shelfLife', label: 'ä¿å­˜æœŸé™', section: 'common', placeholder: 'ä¾‹å¦‚ï¼š2å¹´', type: 'text', col: 'col-md-4' },
            { id: 'flavorNotes', label: 'é¢¨å‘³æè¿°', section: 'common', placeholder: 'ä¾‹å¦‚ï¼šå¸¶æœ‰å¥¶é¦™ã€èŠ±é¦™ï¼Œå£æ„Ÿæ»‘é †', type: 'textarea', col: 'col-md-6' },
            { id: 'brewGuide', label: 'æ²–æ³¡å»ºè­°', section: 'common', placeholder: 'ä¾‹å¦‚ï¼šæ°´æº«95Â°Cï¼Œç¬¬ä¸€æ³¡60ç§’...', type: 'textarea', col: 'col-md-6' },
            { id: 'storagePack', label: 'ä¿å­˜æ–¹å¼/åŒ…è£', section: 'common', placeholder: 'ä¾‹å¦‚ï¼šçœŸç©ºåŒ…è£ï¼Œå­˜æ”¾æ–¼é™°æ¶¼ä¹¾ç‡¥è™•', type: 'text', col: 'col-md-6' },
            { id: 'certification', label: 'èªè­‰æ¨™ç« ', section: 'common', placeholder: 'ä¾‹å¦‚ï¼šSGS èªè­‰ã€æœ‰æ©Ÿèªè­‰', type: 'text', col: 'col-md-6' },
            { id: 'priceTWD', label: 'åƒè€ƒå”®åƒ¹ (TWD)', section: 'common', placeholder: 'ä¾‹å¦‚ï¼š800', type: 'number', col: 'col-md-4' },
            { id: 'barcode', label: 'å•†å“æ¢ç¢¼', section: 'common', placeholder: 'ä¾‹å¦‚ï¼š471xxxxxxxxxx', type: 'text', col: 'col-md-4' },
            { id: 'productImageUrl', label: 'å•†å“åœ–ç‰‡ç¶²å€', section: 'common', placeholder: 'https://...', type: 'url', col: 'col-md-12' },
            { id: 'productImageFile', label: 'ä¸Šå‚³å•†å“åœ–ç‰‡', section: 'common', type: 'file', col: 'col-md-6' }, // Keep col-md-6 for layout
             { id: 'productImageFilePreview', label: '', section: 'common', type: 'preview', col: 'col-md-6' }, // Placeholder for preview area positioning
            { id: 'notes', label: 'å‚™è¨»', section: 'common', placeholder: 'å…¶ä»–è£œå……è³‡è¨Š', type: 'textarea', col: 'col-md-12' },
            // é€²éšè³‡è¨Š (Advance)
            { id: 'gardenArea', label: 'èŒ¶åœ’é¢ç©', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼š5å…¬é ƒ', type: 'text', col: 'col-md-4' },
            { id: 'farmingMethod', label: 'è€•ä½œæ–¹å¼', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šæœ‰æ©Ÿè¾²æ³•ã€è‡ªç„¶è¾²æ³•', type: 'text', col: 'col-md-4' },
            { id: 'fermentation', label: 'ç™¼é…µç¨‹åº¦ (%)', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼š20', type: 'number', col: 'col-md-4' },
            { id: 'roastLevel', label: 'ç„™ç«ç¨‹åº¦', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šè¼•ç„™ç«ã€ä¸­ç„™ç«', type: 'text', col: 'col-md-4' },
            { id: 'treeAge', label: 'èŒ¶æ¨¹æ¨¹é½¡', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼š30å¹´', type: 'text', col: 'col-md-4' },
            { id: 'liquorColor', label: 'èŒ¶æ¹¯è‰²æ¾¤', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šé‡‘é»ƒæ˜äº®', type: 'text', col: 'col-md-4' },
            { id: 'leafAppearance', label: 'è‘‰åº•å¤–è§€', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šè‘‰ç‰‡å®Œæ•´ï¼Œè‘‰ç·£é‘²ç´…é‚Š', type: 'text', col: 'col-md-6' },
            { id: 'climate', label: 'æ°£å€™æ¢ä»¶', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šé›²éœ§ç¹šç¹ï¼Œæ—¥å¤œæº«å·®å¤§', type: 'text', col: 'col-md-6' },
            { id: 'clarity', label: 'èŒ¶æ¹¯æ¾„æ¸…åº¦', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šæ¸…æ¾ˆé€äº®', type: 'text', col: 'col-md-4' },
            { id: 'brokenRate', label: 'ç¢æœ«ç‡ (%)', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼š< 5', type: 'number', col: 'col-md-4' },
            { id: 'moisture', label: 'å«æ°´é‡ (%)', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼š< 7', type: 'number', col: 'col-md-4' },
            { id: 'phValue', label: 'pHå€¼', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼š5.5', type: 'number', step: '0.1', col: 'col-md-6' },
            { id: 'caffeine', label: 'å’–å•¡å› å«é‡', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šä¸­ç­‰', type: 'text', col: 'col-md-6' },
            // å°ˆå®¶è³‡è¨Š (Expert)
            { id: 'pesticideReport', label: 'è¾²è—¥æª¢æ¸¬å ±å‘Š', section: 'expert', placeholder: 'ä¾‹å¦‚ï¼šSGS æª¢æ¸¬é€£çµæˆ–æ‘˜è¦', type: 'textarea', col: 'col-md-12' },
            { id: 'equipment', label: 'ä½¿ç”¨è¨­å‚™', section: 'expert', placeholder: 'ä¾‹å¦‚ï¼šç‰¹æ®Šè£½èŒ¶è¨­å‚™èªªæ˜', type: 'textarea', col: 'col-md-12' },
            { id: 'awards', label: 'å¾—çç´€éŒ„', section: 'expert', placeholder: 'ä¾‹å¦‚ï¼š2023å¹´ XX æ¯”è³½é‡‘ç', type: 'textarea', col: 'col-md-12' },
        ];

        const sections = {
            basic: { title: 'åŸºæœ¬è³‡è¨Š', fields: [], element: null },
            common: { title: 'å¸¸ç”¨è³‡è¨Š', fields: [], element: null },
            advance: { title: 'é€²éšè³‡è¨Š', fields: [], element: null },
            expert: { title: 'å°ˆå®¶è³‡è¨Š', fields: [], element: null },
        };

        const MAX_QR_LENGTH = 2953; // QR Code Version 40, Level M max bytes (approx for alphanumeric)

        // --- DOM Elements ---
        const teaForm = document.getElementById('teaForm');
        const teaFormAccordion = document.getElementById('teaFormAccordion');
        const qrCodeResultDiv = document.getElementById('qrCodeResult');
        const qrCanvas = document.getElementById('qrCanvas');
        const qrCodeImageContainer = document.getElementById('qrCodeImageContainer');
        const saveQrButton = document.getElementById('saveQrButton');
        const loadQrInput = document.getElementById('loadQrInput');
        const generateMessageDiv = document.getElementById('generateMessage');
        const scanMessageDiv = document.getElementById('scanMessage');
        const scanResultDiv = document.getElementById('scanResult');
        const scanResultList = document.getElementById('scanResultList');
        const readerDiv = document.getElementById('reader');
        const generateTab = document.getElementById('generate-tab');
        const scanTab = document.getElementById('scan-tab');
        const cloudModeSection = document.getElementById('cloudModeSection');
        const jsonDataDisplay = document.getElementById('jsonDataDisplay');
        const copyJsonButton = document.getElementById('copyJsonButton');
        const cloudUrlInput = document.getElementById('cloudUrlInput');
        const generateLinkQrButton = document.getElementById('generateLinkQrButton');
        const compressedSizeInfo = document.getElementById('compressedSizeInfo');

        let html5QrCode = null; // Scanner instance
        let currentQrData = null; // To store data for saving QR
        let currentQrDataType = 'canvas'; // 'canvas', 'image'
        let productImageBase64 = null; // To store uploaded image data as base64 string

        // --- Utility Functions ---

        /**
         * é¡¯ç¤ºè¨Šæ¯
         * @param {HTMLElement} element - é¡¯ç¤ºè¨Šæ¯çš„å…ƒç´ 
         * @param {string} message - è¨Šæ¯å…§å®¹
         * @param {string} type - è¨Šæ¯é¡å‹ (success, danger, warning, info)
         */
        function showMessage(element, message, type = 'info') {
            element.className = `alert alert-${type} mt-3`; // Keep margin
            element.innerHTML = message; // Use innerHTML to allow basic formatting if needed
            element.style.display = 'block';
            console.log(`[Message ${type}]: ${message}`); // Debug log
        }

        /**
         * éš±è—è¨Šæ¯
         * @param {HTMLElement} element - éš±è—è¨Šæ¯çš„å…ƒç´ 
         */
        function hideMessage(element) {
            element.style.display = 'none';
            element.textContent = '';
        }

        /**
         * å°‡ File ç‰©ä»¶è®€å–ç‚º Base64 å­—ä¸² (Data URL)
         * @param {File} file - è¦è®€å–çš„æª”æ¡ˆ
         * @returns {Promise<string>} - Base64 Data URL å­—ä¸²çš„ Promise
         */
        function readFileAsBase64(file) {
             console.log(`[Debug] Reading file: ${file.name}, size: ${file.size}, type: ${file.type}`);
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                     console.log("[Debug] File read successfully as Base64.");
                    resolve(reader.result); // reader.result contains the Data URL (e.g., "data:image/jpeg;base64,...")
                }
                reader.onerror = (error) => {
                     console.error("[Debug] File reading error:", error);
                    reject(error);
                }
                reader.readAsDataURL(file);
            });
        }

        // --- Core Application Logic ---

        /**
         * æ ¹æ“š fieldConfig å‹•æ…‹ç”¢ç”Ÿè¡¨å–®æ¬„ä½å’Œ Accordion
         */
        function generateFormFields() {
            console.log("[Debug] Generating form fields...");
            // 1. å°‡æ¬„ä½åˆ†é…åˆ°å„å€‹ section
            fieldConfig.forEach(field => {
                if (sections[field.section] && field.type !== 'preview') { // Exclude preview placeholders
                    sections[field.section].fields.push(field);
                }
            });

            // 2. ç‚ºæ¯å€‹ section ç”¢ç”Ÿ Accordion Item
            Object.keys(sections).forEach((key, index) => {
                const section = sections[key];
                if (section.fields.length === 0) return; // Skip sections with no fields

                const accordionItemId = `accordion-${key}`;
                const headerId = `header-${key}`;
                const collapseId = `collapse-${key}`;

                const accordionItem = document.createElement('div');
                accordionItem.className = 'accordion-item';
                sections[key].element = accordionItem; // Store reference

                const accordionHeader = document.createElement('h2');
                accordionHeader.className = 'accordion-header';
                accordionHeader.id = headerId;

                const accordionButton = document.createElement('button');
                accordionButton.className = `accordion-button ${index === 0 ? '' : 'collapsed'}`; // First section expanded by default
                accordionButton.type = 'button';
                accordionButton.dataset.bsToggle = 'collapse';
                accordionButton.dataset.bsTarget = `#${collapseId}`;
                accordionButton.ariaExpanded = index === 0 ? 'true' : 'false';
                accordionButton.ariaControls = collapseId;
                accordionButton.textContent = section.title;

                accordionHeader.appendChild(accordionButton);

                const accordionCollapse = document.createElement('div');
                accordionCollapse.id = collapseId;
                // REMOVED data-bs-parent to allow multiple sections open
                accordionCollapse.className = `accordion-collapse collapse ${index === 0 ? 'show' : ''}`;
                accordionCollapse.ariaLabelledby = headerId;
                // accordionCollapse.dataset.bsParent = '#teaFormAccordion'; // REMOVED THIS LINE

                const accordionBody = document.createElement('div');
                accordionBody.className = 'accordion-body';

                const row = document.createElement('div');
                row.className = 'row g-3'; // g-3 for gutters

                // 3. åœ¨ Accordion Body ä¸­ç”¢ç”Ÿæ¬„ä½
                section.fields.forEach(field => {
                    const colDiv = document.createElement('div');
                    colDiv.className = field.col || 'col-12';

                    const label = document.createElement('label');
                    label.htmlFor = field.id;
                    label.className = 'form-label';
                    label.textContent = field.label;

                    let inputElement;
                    if (field.type === 'textarea') {
                        inputElement = document.createElement('textarea');
                        inputElement.rows = 3;
                        inputElement.id = field.id;
                        inputElement.name = field.id;
                        inputElement.className = 'form-control';
                        if (field.placeholder) inputElement.placeholder = field.placeholder;
                        colDiv.appendChild(label);
                        colDiv.appendChild(inputElement);

                    } else if (field.type === 'file') {
                        inputElement = document.createElement('input'); // The hidden actual input
                        inputElement.type = 'file';
                        inputElement.accept = 'image/*';
                        inputElement.id = field.id;
                        inputElement.name = field.id; // Important for FormData

                        const fileLabelButton = document.createElement('label'); // The visible button
                        fileLabelButton.htmlFor = field.id;
                        fileLabelButton.className = 'btn btn-sm custom-file-upload'; // Use custom class
                        fileLabelButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-image me-1" viewBox="0 0 16 16"> <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/> <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/> </svg>
                            é¸æ“‡åœ–ç‰‡`;

                        const fileNameSpan = document.createElement('span'); // To display filename
                        fileNameSpan.id = `${field.id}Name`; // Corrected ID here
                        fileNameSpan.className = 'file-name-display ms-2'; // Add margin start

                        const previewDiv = document.createElement('div'); // Preview container
                        previewDiv.id = `${field.id}Preview`;
                        previewDiv.className = 'mt-2'; // Add margin top

                        colDiv.appendChild(label);
                        colDiv.appendChild(document.createElement('br'));
                        colDiv.appendChild(fileLabelButton);
                        colDiv.appendChild(fileNameSpan);
                        colDiv.appendChild(inputElement); // Append hidden input
                        colDiv.appendChild(previewDiv); // Append preview container

                        // Event listener for file selection
                        inputElement.addEventListener('change', async (event) => {
                           const file = event.target.files[0];
                           previewDiv.innerHTML = ''; // Clear previous preview
                           fileNameSpan.textContent = ''; // Clear filename
                           productImageBase64 = null; // Clear stored base64
                           if (file) {
                                fileNameSpan.textContent = file.name; // Show filename
                                try {
                                    productImageBase64 = await readFileAsBase64(file);
                                    console.log(`[Debug] Read Base64 for preview, length: ${productImageBase64.length}`);
                                    const img = document.createElement('img');
                                    img.src = productImageBase64;
                                    img.alt = 'åœ–ç‰‡é è¦½';
                                    // Styles moved to CSS (#productImageFilePreview img)
                                    previewDiv.appendChild(img);
                                } catch (error) {
                                    console.error("ç„¡æ³•è®€å–æª”æ¡ˆ:", error);
                                    showMessage(generateMessageDiv, 'ç„¡æ³•è®€å–åœ–ç‰‡æª”æ¡ˆã€‚', 'danger');
                                    fileNameSpan.textContent = 'è®€å–å¤±æ•—';
                                }
                           }
                        });

                    } else { // Handles text, number, date, url etc.
                        inputElement = document.createElement('input');
                        inputElement.type = field.type;
                         if (field.step) inputElement.step = field.step;
                        inputElement.id = field.id;
                        inputElement.name = field.id;
                        inputElement.className = 'form-control';
                        if (field.placeholder) inputElement.placeholder = field.placeholder;
                        colDiv.appendChild(label);
                        colDiv.appendChild(inputElement);
                    }

                    row.appendChild(colDiv);
                });

                accordionBody.appendChild(row);
                accordionCollapse.appendChild(accordionBody);
                accordionItem.appendChild(accordionHeader);
                accordionItem.appendChild(accordionCollapse);
                teaFormAccordion.appendChild(accordionItem);
            });
            console.log("[Debug] Form fields generated.");
        }

        /**
         * ç”¢ç”Ÿ QR Code (Canvas or Image for URL)
         * @param {string} data - è¦ç·¨ç¢¼çš„è³‡æ–™ (å£“ç¸®å¾Œçš„ Base64 å­—ä¸²æˆ– URL)
         * @param {boolean} isUrl - æ¨™ç¤º data æ˜¯å¦ç‚º URL
         */
        function displayQrCode(data, isUrl = false) {
            hideMessage(generateMessageDiv);
            cloudModeSection.style.display = 'none';
            qrCodeImageContainer.innerHTML = ''; // Clear previous image QR
            qrCanvas.style.display = 'none'; // Hide canvas initially

            console.log(`[Debug] Generating QR Code. Is URL: ${isUrl}, Data: ${isUrl ? data : data.substring(0, 50) + '...'}`);

            try {
                currentQrData = data; // Store data for saving

                // Use Canvas for compressed data, potentially image for URL for cleaner saving?
                // Let's stick to Canvas for consistency for now.
                qrCanvas.style.display = 'block';
                currentQrDataType = 'canvas';
                new QRious({
                    element: qrCanvas,
                    value: data,
                    size: 420,
                    level: 'M',
                    padding: 20 // Increased padding
                });

                qrCodeResultDiv.style.display = 'block';
                qrCodeResultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                console.log("[Debug] QR Code generated successfully on canvas.");

            } catch (error) {
                console.error("QR Code ç”¢ç”Ÿå¤±æ•—:", error);
                showMessage(generateMessageDiv, `QR Code ç”¢ç”Ÿå¤±æ•—: ${error.message}`, 'danger');
                qrCodeResultDiv.style.display = 'none';
            }
        }

        /**
         * è™•ç†è¡¨å–®æäº¤äº‹ä»¶
         */
        async function handleFormSubmit(event) {
            event.preventDefault();
            console.log("[Debug] Form submitted.");
            hideMessage(generateMessageDiv);
            qrCodeResultDiv.style.display = 'none';
            cloudModeSection.style.display = 'none';

            const formData = new FormData(teaForm);
            const teaData = {};

            // æ”¶é›†è¡¨å–®æ•¸æ“š
            fieldConfig.forEach(field => {
                if (field.type !== 'file' && field.type !== 'preview') { // Exclude file input and preview
                    const value = formData.get(field.id);
                    if (value !== null && value !== '') { // Only store non-empty values
                       teaData[field.id] = value;
                       console.log(`[Debug] Form Data: ${field.id} = ${value}`);
                    }
                }
            });

            // è™•ç†åœ–ç‰‡ï¼šå„ªå…ˆä½¿ç”¨ä¸Šå‚³çš„æª”æ¡ˆ (Base64 Data URL)
            if (productImageBase64) {
                teaData.productImageBase64 = productImageBase64; // Store the Base64 Data URL
                console.log(`[Debug] Using uploaded image Base64 (length: ${productImageBase64.length})`);
                // If Base64 exists, remove the URL field value to avoid redundancy
                if (teaData.productImageUrl) {
                    console.log(`[Debug] Removing productImageUrl (${teaData.productImageUrl}) because Base64 exists.`);
                    delete teaData.productImageUrl;
                    const urlInput = document.getElementById('productImageUrl');
                    if(urlInput) urlInput.value = ''; // Clear the input field visually
                }
            } else if (teaData.productImageUrl) {
                console.log(`[Debug] Using productImageUrl: ${teaData.productImageUrl}`);
                // Keep the URL if no Base64 is present
            }

            // Remove potentially empty placeholder fields if needed (e.g., productImageFile)
            delete teaData.productImageFile; // This field itself doesn't hold the value

            if (Object.keys(teaData).length === 0) {
                showMessage(generateMessageDiv, 'è«‹è‡³å°‘å¡«å¯«ä¸€é …è³‡è¨Šã€‚', 'warning');
                return;
            }

            try {
                const jsonString = JSON.stringify(teaData);
                console.log("[Debug] Original JSON String:", jsonString.substring(0, 200) + '...'); // Log beginning

                const compressedData = LZString.compressToBase64(jsonString);
                const compressedLength = compressedData.length;
                console.log("[Debug] Compressed Base64:", compressedData.substring(0, 100) + '...'); // Log beginning
                console.log("[Debug] Compressed Length:", compressedLength);

                if (compressedLength <= MAX_QR_LENGTH) {
                    // --- Direct Mode ---
                    console.log("[Debug] Data fits in QR Code (Direct Mode).");
                    displayQrCode(compressedData, false);
                } else {
                    // --- Cloud Mode ---
                    console.log("[Debug] Data too large for QR Code (Cloud Mode).");
                    compressedSizeInfo.textContent = compressedLength; // Show compressed size
                    showMessage(generateMessageDiv, `è³‡æ–™é‡éå¤§ (${compressedLength} > ${MAX_QR_LENGTH} bytes)ï¼Œè«‹ä½¿ç”¨é›²ç«¯æ¨¡å¼ã€‚`, 'warning');
                    jsonDataDisplay.value = jsonString; // Display full JSON for copying
                    cloudUrlInput.value = ''; // Clear URL input
                    cloudModeSection.style.display = 'block';
                    qrCodeResultDiv.style.display = 'none';
                    cloudModeSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }

            } catch (error) {
                console.error("è™•ç†è¡¨å–®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                showMessage(generateMessageDiv, `è™•ç†è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'danger');
            }
        }

        /**
         * è™•ç†å„²å­˜ QR Code æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼ˆçµåˆ File System Access API èˆ‡ <a download> fallbackï¼‰
         */
        async function handleSaveQr() {
            if (!currentQrData) {
                showMessage(generateMessageDiv, 'æ²’æœ‰å¯å„²å­˜çš„ QR Codeã€‚', 'warning');
                return;
            }
            console.log("[Debug] é–‹å§‹å„²å­˜ QR Code...");

            // 1. å»ºè­°æª”åï¼ˆä¾†è‡ªèŒ¶åï¼‰
            const teaName = document.getElementById('teaName')?.value.trim();
            const baseName = `tea_qrcode${teaName ? '_' + teaName : ''}`;
            const suggestedName = baseName + '.png';

            // å¦‚æœæ”¯æ´ File System Access APIï¼Œå°±ç”¨åŸç”Ÿå°è©±æ¡†
            if (window.showSaveFilePicker) {
                try {
                    console.log("[Debug] ä½¿ç”¨ File System Access API å„²å­˜");
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName,
                        types: [{
                            description: 'PNG åœ–ç‰‡',
                            accept: { 'image/png': ['.png'] }
                        }]
                    });
                    const writable = await fileHandle.createWritable();

                    // å–å¾— Blob
                    let blob;
                    if (currentQrDataType === 'canvas' && qrCanvas) {
                        blob = await new Promise(res => qrCanvas.toBlob(res, 'image/png'));
                    } else if (currentQrDataType === 'image' && qrCodeImageContainer.firstChild) {
                        const resp = await fetch(qrCodeImageContainer.firstChild.src);
                        blob = await resp.blob();
                    }
                    if (!blob) throw new Error('ç„¡æ³•å–å¾— QR Code åœ–ç‰‡è³‡æ–™');

                    await writable.write(blob);
                    await writable.close();

                    showMessage(generateMessageDiv, `QR Code (${suggestedName}) å·²æˆåŠŸå„²å­˜ã€‚`, 'success');
                    console.log("[Debug] File System Access API å„²å­˜å®Œæˆ");
                } catch (e) {
                    if (e.name === 'AbortError') {
                        console.log("[Debug] ä½¿ç”¨è€…å–æ¶ˆå„²å­˜");
                    } else {
                        console.error("å„²å­˜å¤±æ•—ï¼š", e);
                        showMessage(generateMessageDiv, 'å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'danger');
                    }
                }

            // fallback: å‚³çµ± <a download> + prompt()
            } else {
                console.log("[Debug] ä½¿ç”¨ <a download> fallback å„²å­˜");
                // 2. è©¢å•ä½¿ç”¨è€…æª”å
                const inputName = prompt('è«‹è¼¸å…¥è¦å„²å­˜çš„æª”åï¼ˆä¸å«å‰¯æª”åï¼‰', baseName);
                if (!inputName) {
                    console.log("[Debug] ä½¿ç”¨è€…å–æ¶ˆæª”åè¼¸å…¥");
                    return;
                }
                const filename = inputName.toLowerCase().endsWith('.png') ? inputName : inputName + '.png';

                // 3. ç”¢ç”Ÿ data URL
                let dataUrl;
                if (currentQrDataType === 'canvas' && qrCanvas) {
                    try {
                        dataUrl = qrCanvas.toDataURL('image/png');
                    } catch (e) {
                        console.error("å¾ Canvas åŒ¯å‡ºå¤±æ•—ï¼š", e);
                        showMessage(generateMessageDiv, 'ç„¡æ³•å¾ Canvas åŒ¯å‡º QR Codeã€‚', 'danger');
                        return;
                    }
                } else if (currentQrDataType === 'image' && qrCodeImageContainer.firstChild) {
                    dataUrl = qrCodeImageContainer.firstChild.src;
                } else {
                    showMessage(generateMessageDiv, 'æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ QR Code ä¾†æºã€‚', 'warning');
                    return;
                }

                // 4. è§¸ç™¼ä¸‹è¼‰
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage(generateMessageDiv, `QR Code (${filename}) å·²é–‹å§‹ä¸‹è¼‰ã€‚`, 'success');
                console.log("[Debug] <a download> fallback å„²å­˜å®Œæˆ");
            }
        }

         /**
         * è™•ç†è¤‡è£½ JSON æŒ‰éˆ•é»æ“Šäº‹ä»¶
         */
        function handleCopyJson() {
            if (!jsonDataDisplay.value) return;
            jsonDataDisplay.select();
            jsonDataDisplay.setSelectionRange(0, 99999); // For mobile devices
            try {
                // Use Clipboard API for modern browsers
                navigator.clipboard.writeText(jsonDataDisplay.value).then(() => {
                    console.log("[Debug] JSON copied to clipboard (Clipboard API).");
                    showMessage(generateMessageDiv, 'JSON å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚', 'success');
                }).catch(err => {
                     console.warn("[Debug] Clipboard API failed, falling back to execCommand:", err);
                     // Fallback for older browsers
                    if(document.execCommand('copy')) {
                        console.log("[Debug] JSON copied to clipboard (execCommand).");
                        showMessage(generateMessageDiv, 'JSON å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚', 'success');
                    } else {
                        throw new Error('execCommand failed');
                    }
                });
            } catch (err) {
                console.error('ç„¡æ³•è¤‡è£½ JSON:', err);
                showMessage(generateMessageDiv, 'è¤‡è£½ JSON å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–ä¸¦è¤‡è£½ã€‚', 'danger');
            } finally {
                 // Deselect text
                 window.getSelection()?.removeAllRanges();
            }
        }

        /**
         * è™•ç†ä½¿ç”¨é€£çµç”¢ç”Ÿ QR Code æŒ‰éˆ•é»æ“Šäº‹ä»¶
         */
        function handleGenerateLinkQr() {
            const url = cloudUrlInput.value.trim();
            console.log(`[Debug] Generating QR from link: ${url}`);
            if (!url) {
                showMessage(generateMessageDiv, 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›²ç«¯è³‡æ–™é€£çµã€‚', 'warning');
                cloudUrlInput.focus();
                return;
            }
            try {
                 // Basic URL validation
                 new URL(url);
                 displayQrCode(url, true); // Generate QR code with the URL
                 cloudModeSection.style.display = 'none'; // Hide cloud mode section
            } catch (error) {
                 console.error("[Debug] Invalid URL format:", error);
                 showMessage(generateMessageDiv, 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ URL æ ¼å¼ (ä¾‹å¦‚ https://...) ã€‚', 'danger');
                 cloudUrlInput.focus();
            }
        }


        /**
         * è§£æ QR Code è³‡æ–™ (å¯èƒ½æ˜¯å£“ç¸®å­—ä¸²æˆ– URL)
         * @param {string} decodedText - å¾ QR Code æƒæåˆ°çš„åŸå§‹å­—ä¸²
         * @returns {Promise<object>} - è§£æå¾Œçš„ JSON ç‰©ä»¶ Promise
         */
        async function parseQrData(decodedText) {
            console.log(`[Debug] Parsing QR Data: ${decodedText.substring(0, 100)}...`);
            if (decodedText.startsWith('http://') || decodedText.startsWith('https://')) {
                // --- Handle URL (Cloud Mode) ---
                console.log("[Debug] Detected URL, attempting to fetch JSON...");
                // Use a specific message element for scan tab if possible, otherwise use generateMessageDiv
                const messageElement = document.getElementById('scan-tab').classList.contains('active') ? scanMessageDiv : generateMessageDiv;
                showMessage(messageElement, 'åµæ¸¬åˆ° URLï¼Œæ­£åœ¨æ“·å–é›²ç«¯è³‡æ–™...', 'info');
                try {
                    // Use fetch API with appropriate headers
                    const response = await fetch(decodedText, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json, text/plain, */*' // Accept JSON or plain text
                        },
                        mode: 'cors' // Enable CORS requests
                    });

                    if (!response.ok) {
                        throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${response.status} ${response.statusText}`);
                    }

                    // Try parsing as JSON first
                    let jsonData;
                    try {
                        jsonData = await response.json();
                        console.log("[Debug] Successfully fetched and parsed JSON from URL.");
                    } catch (jsonError) {
                         console.warn("[Debug] Failed to parse response as JSON:", jsonError);
                         throw new Error('ç„¡æ³•å°‡ä¼ºæœå™¨å›æ‡‰è§£æç‚º JSON æ ¼å¼ã€‚');
                    }

                    showMessage(messageElement, 'å·²æˆåŠŸå¾é›²ç«¯è¼‰å…¥è³‡æ–™ã€‚', 'success');
                    return jsonData;
                } catch (error) {
                    console.error("å¾ URL æ“·å– JSON å¤±æ•—:", error);
                    // Ensure error is thrown so it can be caught by the caller
                    throw new Error(`å¾ URL æ“·å–è³‡æ–™å¤±æ•—: ${error.message}`);
                }
            } else {
                // --- Handle Compressed String (Direct Mode) ---
                console.log("[Debug] Detected non-URL data, attempting decompression...");
                 const messageElement = document.getElementById('scan-tab').classList.contains('active') ? scanMessageDiv : generateMessageDiv;
                try {
                    const decompressed = LZString.decompressFromBase64(decodedText);
                    if (!decompressed) {
                        console.error("[Debug] Decompression failed (result is null or empty).");
                        throw new Error('è§£å£“ç¸®å¤±æ•—ã€‚é€™å¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„èŒ¶è‘‰è³‡æ–™ QR Codeï¼Œæˆ–è€…è³‡æ–™å·²æå£ã€‚');
                    }
                    console.log("[Debug] Decompressed successfully:", decompressed.substring(0, 200) + '...');

                    const jsonData = JSON.parse(decompressed);
                    console.log("[Debug] JSON parsed successfully.");
                     // Don't show success message here, let the caller handle it after population/display
                    // showMessage(messageElement, 'QR Code è§£ç¢¼æˆåŠŸã€‚', 'success');
                    return jsonData;
                } catch (error) {
                    console.error("è§£å£“ç¸®æˆ–è§£æ JSON å¤±æ•—:", error);
                     // Check if it's a JSON parse error specifically
                     if (error instanceof SyntaxError) {
                         throw new Error(`è§£ç¢¼å¤±æ•—: è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æç‚º JSONã€‚ (${error.message})`);
                     } else {
                        throw new Error(`è§£ç¢¼å¤±æ•—: ${error.message}`);
                     }
                }
            }
        }

        /**
         * å°‡è§£æå¾Œçš„è³‡æ–™é¡¯ç¤ºåœ¨æƒæçµæœåˆ—è¡¨ä¸­
         * @param {object} data - è§£æå¾Œçš„ JSON ç‰©ä»¶
         */
        function displayScanResult(data) {
            console.log("[Debug] Displaying scan result:", data);
            scanResultList.innerHTML = ''; // Clear previous results
            let hasContent = false;

            // Create a map for faster lookup if needed, but fieldConfig is small enough
            const fieldMap = fieldConfig.reduce((map, field) => {
                map[field.id] = field;
                return map;
            }, {});

            // Iterate through the data received, using fieldConfig for labels and types
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    const field = fieldMap[key];
                    const value = data[key];

                    // Skip empty/null values and the base64 key itself (it's handled by productImageFile)
                    if (value === null || value === '' || key === 'productImageBase64') {
                        continue;
                    }

                    const label = field ? field.label : key; // Use config label or key as fallback
                    const type = field ? field.type : 'text'; // Get type from config

                    let displayValueHtml = '';
                    hasContent = true;

                    // Special handling for image (either Base64 or URL)
                    if (key === 'productImageUrl' && value) {
                         console.log(`[Debug] Displaying image from URL: ${value}`);
                         // Display link and image preview
                         displayValueHtml = `<a href="${value}" target="_blank" rel="noopener noreferrer">${value}</a><br>
                                             <img src="${value}" alt="å•†å“åœ–ç‰‡ (URL)" class="img-fluid rounded mt-2"
                                                  onerror="this.alt='ç„¡æ³•è¼‰å…¥åœ–ç‰‡'; this.style.display='block'; this.style.border='1px dashed red';">`; // Added onerror handler
                    } else if (type === 'textarea' && value) {
                         console.log(`[Debug] Displaying textarea: ${key}`);
                         // Use <pre> for textareas to preserve formatting
                         displayValueHtml = `<pre>${value}</pre>`;
                    } else if (type === 'url' && value && key !== 'productImageUrl') { // Handle other URLs as links
                         console.log(`[Debug] Displaying URL link: ${key}`);
                         displayValueHtml = `<a href="${value}" target="_blank" rel="noopener noreferrer">${value}</a>`;
                    }
                    else {
                        console.log(`[Debug] Displaying text: ${key} = ${value}`);
                        // Escape HTML to prevent XSS from text fields if necessary
                        // For simplicity here, we assume data is relatively safe or display as is.
                        // To escape: displayValueHtml = value.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        displayValueHtml = value; // Default display
                    }

                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';
                    listItem.innerHTML = `<strong>${label}:</strong> ${displayValueHtml}`;
                    scanResultList.appendChild(listItem);
                }
            }

             // Specifically check and display Base64 image if it exists, linked to the 'productImageFile' label
             if (data.productImageBase64) {
                 const field = fieldMap['productImageFile']; // Get the config for the file input
                 const label = field ? field.label : 'ä¸Šå‚³å•†å“åœ–ç‰‡'; // Use its label
                 hasContent = true;
                 const listItem = document.createElement('li');
                 listItem.className = 'list-group-item';
                 console.log(`[Debug] Displaying image from Base64 (length: ${data.productImageBase64.length}) linked to ${label}`);
                 listItem.innerHTML = `<strong>${label}:</strong><br><img src="${data.productImageBase64}" alt="å•†å“åœ–ç‰‡ (ä¾†è‡ªä¸Šå‚³)" class="img-fluid rounded mt-2">`;
                 scanResultList.appendChild(listItem);
             }


            if (hasContent) {
                scanResultDiv.style.display = 'block';
                scanResultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                 showMessage(scanMessageDiv, 'è³‡æ–™é¡¯ç¤ºå®Œç•¢ã€‚', 'success'); // Add final success message
            } else {
                scanResultDiv.style.display = 'none';
                showMessage(scanMessageDiv, 'QR Code ä¸­æ²’æœ‰æ‰¾åˆ°å¯é¡¯ç¤ºçš„è³‡æ–™ã€‚', 'warning');
            }
        }

         /**
         * å°‡è§£æå¾Œçš„è³‡æ–™å›å¡«åˆ°è¡¨å–®ä¸­
         * @param {object} data - è§£æå¾Œçš„ JSON ç‰©ä»¶
         */
        function populateForm(data) {
            console.log("[Debug] Populating form with data:", data);
            try {
                teaForm.reset(); // Clear form fields
                productImageBase64 = null; // Clear stored Base64
                // Clear file input preview and filename display
                const previewDiv = document.getElementById('productImageFilePreview');
                const fileNameSpan = document.getElementById('productImageFileName'); // Corrected ID
                const fileLabel = document.querySelector('label[for="productImageFile"]'); // The button label
                if (previewDiv) previewDiv.innerHTML = '';
                if (fileNameSpan) fileNameSpan.textContent = '';
                if (fileLabel) fileLabel.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-image me-1" viewBox="0 0 16 16"> <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/> <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/> </svg>
                    é¸æ“‡åœ–ç‰‡`; // Reset button text


                let populatedFields = 0;
                fieldConfig.forEach(field => {
                    const inputElement = document.getElementById(field.id);
                    if (inputElement) {
                        // Handle file input separately for preview
                        if (field.type === 'file') {
                            inputElement.value = ''; // Clear file input value
                            // Check if Base64 data exists in the loaded data
                            if (data.productImageBase64) {
                                console.log(`[Debug] Populating Base64 image preview (length: ${data.productImageBase64.length})`);
                                productImageBase64 = data.productImageBase64; // Store it globally for potential resubmission
                                if (previewDiv) {
                                    const img = document.createElement('img');
                                    img.src = productImageBase64;
                                    img.alt = 'è¼‰å…¥çš„åœ–ç‰‡';
                                    previewDiv.appendChild(img);
                                }
                                if (fileNameSpan) fileNameSpan.textContent = 'å·²è¼‰å…¥åœ–ç‰‡ (ä¾†è‡ª QR Code)'; // Use correct span ID
                                if (fileLabel) fileLabel.innerHTML = `
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill me-1" viewBox="0 0 16 16"> <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/> </svg>
                                    æ›´æ”¹åœ–ç‰‡`; // Change button text
                                populatedFields++;
                             } else if (data.productImageUrl) {
                                 // If only URL exists, maybe show a note? Or leave file input clear.
                                 console.log(`[Debug] Image URL found (${data.productImageUrl}), but no Base64. File input remains clear.`);
                                 if (fileNameSpan) fileNameSpan.textContent = 'åœ–ç‰‡ä½¿ç”¨ä¸‹æ–¹ç¶²å€'; // Use correct span ID
                             }
                        } else {
                             // Populate regular fields
                             if (data[field.id] !== undefined && data[field.id] !== null) {
                                 inputElement.value = data[field.id];
                                 // console.log(`[Debug] Populated field ${field.id} with value: ${data[field.id]}`); // Reduce log verbosity
                                 populatedFields++;
                             } else {
                                 inputElement.value = ''; // Ensure field is cleared if not in data
                             }
                        }
                    } else {
                        // This case might happen for the 'preview' type placeholder or if ID mismatch
                        if(field.type !== 'preview') {
                            console.warn(`[Debug] Input element not found for field ID: ${field.id}`);
                        }
                    }
                });

                console.log(`[Debug] Form population complete. ${populatedFields} fields populated.`);

                // Expand the first accordion section by default after populating
                const firstAccordionButton = teaFormAccordion.querySelector('.accordion-button');
                const firstCollapse = teaFormAccordion.querySelector('.accordion-collapse');
                if (firstAccordionButton && firstCollapse && firstAccordionButton.classList.contains('collapsed')) {
                    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(firstCollapse);
                    bsCollapse.show();
                     console.log("[Debug] Expanded first accordion section after population.");
                }

                // Final success message on the generate tab
                showMessage(generateMessageDiv, 'å·²æˆåŠŸå¾ QR Code è¼‰å…¥è³‡æ–™åˆ°è¡¨å–®ã€‚', 'success');
                // Switch back to the generate tab
                const bsGenerateTab = bootstrap.Tab.getOrCreateInstance(generateTab);
                bsGenerateTab.show();
                // Scroll to top smoothly
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                 console.error("[Error] Error during form population:", error);
                 showMessage(generateMessageDiv, `å¡«å……è¡¨å–®æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'danger');
            }
        }


        /**
         * QR Code æƒææˆåŠŸå›èª¿
         */
        async function onScanSuccess(decodedText, decodedResult) {
            if (!html5QrCode) {
                 console.warn("[Debug] Scan success callback triggered, but scanner instance is null. Ignoring.");
                 return; // Prevent processing if scanner was stopped
            }

            console.log(`[Debug] QR Scan Success! Raw Text: ${decodedText}`, decodedResult);
            showMessage(scanMessageDiv, `æƒææˆåŠŸï¼æ­£åœ¨è™•ç†è³‡æ–™...`, 'info');
            scanResultDiv.style.display = 'none'; // Hide previous results while processing

            // --- Stop Scanner ---
            const scannerToStop = html5QrCode;
            html5QrCode = null; // Nullify the global instance immediately

            try {
                await scannerToStop.stop();
                console.log("[Debug] QR Code scanning stopped successfully.");
                readerDiv.innerHTML = '<p class="text-center text-success p-3">æƒæå™¨å·²åœæ­¢ã€‚</p>';
            } catch (err) {
                 console.error("[Debug] Error stopping scanner, but continuing processing:", err);
                 readerDiv.innerHTML = '<p class="text-center text-warning p-3">æƒæå™¨åœæ­¢æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä½†å·²è®€å–è³‡æ–™ã€‚</p>';
            }
            // --- End Stop Scanner ---


            // --- Process Data ---
            try {
                const jsonData = await parseQrData(decodedText);
                displayScanResult(jsonData); // Display results on scan tab
            } catch (error) {
                 console.error("è™•ç†æƒæçµæœå¤±æ•—:", error);
                 showMessage(scanMessageDiv, `è™•ç†æƒæçµæœå¤±æ•—: ${error.message}`, 'danger');
                 scanResultDiv.style.display = 'none';
                 readerDiv.innerHTML += '<br><button class="btn btn-sm btn-primary mt-2" onclick="startScanner()">é‡æ–°æƒæ</button>'; // Added margin
            }
             // --- End Process Data ---
        }

        /**
         * QR Code æƒæéŒ¯èª¤å›èª¿ (Scanner errors, not decoding errors)
         */
        function onScanFailure(error) {
            // Ignore "No QR code found" which happens frequently
            if (error && error.message && !error.message.includes("NotFoundException")) {
                 console.warn(`[Debug] Non-critical scan error: ${error}`);
            }
        }


        /**
         * åˆå§‹åŒ–ä¸¦å•Ÿå‹•ç›¸æ©Ÿæƒæå™¨
         */
        function startScanner() {
             console.log("[Debug] Attempting to start scanner...");
             hideMessage(scanMessageDiv);
             scanResultDiv.style.display = 'none';
             scanResultList.innerHTML = '';
             readerDiv.innerHTML = ''; // Clear previous scanner UI/messages

             if (html5QrCode && html5QrCode.isScanning) {
                 console.warn("[Debug] Scanner is already running. Aborting new start request.");
                 return;
             }
              if (html5QrCode) {
                  console.log("[Debug] Cleaning up previous inactive scanner instance.");
                  html5QrCode = null;
              }

             readerDiv.style.display = 'block';

             try {
                 html5QrCode = new Html5Qrcode("reader", { verbose: false });
                 const config = {
                     fps: 10,
                     qrbox: (viewfinderWidth, viewfinderHeight) => {
                         let minEdgePercentage = 0.7;
                         let minEdgeSize = Math.min(viewfinderWidth, viewfinderHeight);
                         let qrboxSize = Math.floor(minEdgeSize * minEdgePercentage);
                         // console.log(`[Debug] Viewfinder: ${viewfinderWidth}x${viewfinderHeight}, QRBox size: ${qrboxSize}`); // Reduce logs
                         return { width: qrboxSize, height: qrboxSize };
                     },
                     rememberLastUsedCamera: true,
                     supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
                 };

                 showMessage(scanMessageDiv, 'æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...', 'info');

                 html5QrCode.start(
                     { facingMode: "environment" },
                     config,
                     onScanSuccess,
                     onScanFailure)
                 .then(() => {
                     console.log("[Debug] Scanner started successfully.");
                     if (document.getElementById('scan-tab').classList.contains('active')) {
                        showMessage(scanMessageDiv, 'ç›¸æ©Ÿå·²å•Ÿå‹•ï¼Œè«‹å°‡ QR Code å°æº–æƒææ¡†ã€‚', 'info');
                     }
                 })
                 .catch((err) => {
                     console.error("ç„¡æ³•å•Ÿå‹•æƒæå™¨:", err);
                      if (document.getElementById('scan-tab').classList.contains('active')) {
                        showMessage(scanMessageDiv, `ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿæƒæå™¨: ${err}. è«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™è¨­å®šï¼Œä¸¦é‡æ–°æ•´ç†é é¢å˜—è©¦ã€‚`, 'danger');
                        readerDiv.innerHTML = `<p class="text-center text-danger p-3">ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ <br><small>${err}</small></p>`;
                      }
                     html5QrCode = null;
                 });
             } catch (e) {
                 console.error("Error initializing Html5Qrcode:", e);
                  if (document.getElementById('scan-tab').classList.contains('active')) {
                    showMessage(scanMessageDiv, `åˆå§‹åŒ–æƒæå™¨å¤±æ•—: ${e}.`, 'danger');
                  }
                 html5QrCode = null;
             }
        }

         /**
         * åœæ­¢ç›¸æ©Ÿæƒæå™¨
         */
        async function stopScanner() {
             if (html5QrCode && html5QrCode.isScanning) {
                 console.log("[Debug] Attempting to stop scanner manually...");
                 try {
                     // Store promise before nullifying
                     const stopPromise = html5QrCode.stop();
                     html5QrCode = null; // Nullify immediately
                     await stopPromise; // Wait for stop to complete
                     console.log("[Debug] QR Code scanning stopped successfully via stopScanner().");
                 } catch (err) {
                     console.error("[Debug] Error stopping scanner manually:", err);
                     // UI might already be cleared by hide.bs.tab event
                 } finally {
                     // Ensure UI is cleared even if stop fails or wasn't scanning
                     readerDiv.innerHTML = '';
                     hideMessage(scanMessageDiv);
                     html5QrCode = null; // Ensure it's nullified
                 }
             } else {
                 // If instance exists but not scanning, or doesn't exist
                 console.log("[Debug] stopScanner() called but scanner was not active or found.");
                 readerDiv.innerHTML = '';
                 hideMessage(scanMessageDiv);
                 html5QrCode = null; // Ensure nullified
             }
        }


        /**
         * è™•ç†è¼‰å…¥ QR Code æª”æ¡ˆè¼¸å…¥äº‹ä»¶ (Populates Form) - Enhanced Error Handling
         */
        async function handleLoadQrFile(event) { // Added async
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            console.log(`[Debug] Loading QR Code from file: ${file.name}`);

            hideMessage(generateMessageDiv);
            showMessage(generateMessageDiv, 'æ­£åœ¨è®€å–åœ–ç‰‡ä¸¦æƒæ QR Code...', 'info');
            loadQrInput.disabled = true; // Disable input while processing

             // Use html5-qrcode to scan the file. Create a temporary instance.
             const fileScanner = new Html5Qrcode(readerDiv.id, { verbose: false });

             try {
                 const decodedText = await fileScanner.scanFile(file, /* showImage= */ false);
                 console.log("[Debug] Scanned successfully from file:", decodedText.substring(0,100) + "...");
                 showMessage(generateMessageDiv, 'åœ–ç‰‡æƒææˆåŠŸï¼Œæ­£åœ¨è§£æè³‡æ–™...', 'info'); // Update message

                 try {
                     const jsonData = await parseQrData(decodedText);
                     showMessage(generateMessageDiv, 'è³‡æ–™è§£ææˆåŠŸï¼Œæ­£åœ¨å¡«å…¥è¡¨å–®...', 'info'); // Update message
                     await populateForm(jsonData); // Wait for form population (though it's mostly synchronous)
                     // Success message is shown inside populateForm
                     console.log("[Debug] Load QR File process completed successfully.");

                 } catch (parseOrPopulateError) {
                     console.error("è™•ç†è¼‰å…¥çš„ QR è³‡æ–™å¤±æ•—:", parseOrPopulateError);
                     // Provide more specific error from parseQrData or populateForm
                     showMessage(generateMessageDiv, `è™•ç†è¼‰å…¥çš„ QR è³‡æ–™å¤±æ•—: ${parseOrPopulateError.message}`, 'danger');
                 }

             } catch (scanError) {
                 console.error("å¾æª”æ¡ˆæƒæå¤±æ•—:", scanError);
                 let errorMessage = 'ç„¡æ³•å¾åœ–ç‰‡ä¸­æƒæåˆ° QR Codeã€‚';
                 // Try to provide a more specific error message if available
                 if (scanError && scanError.message) {
                     if (scanError.message.includes("NotFoundException")) {
                          errorMessage = 'åœ–ç‰‡ä¸­æœªæ‰¾åˆ° QR Codeã€‚';
                     } else {
                          errorMessage = `æƒæåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤: ${scanError.message}`;
                     }
                 }
                 showMessage(generateMessageDiv, errorMessage, 'danger');
             } finally {
                  // Clean up temporary scanner resources if necessary
                  // fileScanner.clear(); // Check documentation if needed for file scan
                  loadQrInput.value = ''; // Reset file input so the same file can be selected again
                  loadQrInput.disabled = false; // Re-enable input
             }
        }


        // --- Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("[Debug] DOMContentLoaded event fired.");
            try {
                generateFormFields(); // Generate form on page load
            } catch (error) {
                console.error("Error generating form fields:", error);
                showMessage(generateMessageDiv, `åˆå§‹åŒ–è¡¨å–®å¤±æ•—: ${error}`, 'danger');
            }

            // Form submission
            if (teaForm) {
                teaForm.addEventListener('submit', handleFormSubmit);
            } else { console.error("TeaForm not found"); }

            // Save QR button
            if (saveQrButton) {
                saveQrButton.addEventListener('click', handleSaveQr);
            } else { console.error("SaveQrButton not found"); }

            // Load QR file input
            if (loadQrInput) {
                loadQrInput.addEventListener('change', handleLoadQrFile);
            } else { console.error("LoadQrInput not found"); }

             // Copy JSON button
             if (copyJsonButton) {
                copyJsonButton.addEventListener('click', handleCopyJson);
             } else { console.error("CopyJsonButton not found"); }

             // Generate QR from Link button
             if (generateLinkQrButton) {
                generateLinkQrButton.addEventListener('click', handleGenerateLinkQr);
             } else { console.error("GenerateLinkQrButton not found"); }


            // Tab switching logic for scanner activation/deactivation
            const scanTabElement = document.getElementById('scan-tab');
            const generateTabElement = document.getElementById('generate-tab');

            if (scanTabElement) {
                scanTabElement.addEventListener('shown.bs.tab', (event) => {
                    console.log("[Debug] Scan tab shown.");
                    startScanner();
                });
                 // Stop scanner when scan tab is *about* to be hidden
                 scanTabElement.addEventListener('hide.bs.tab', (event) => {
                     console.log("[Debug] Scan tab hide event.");
                     stopScanner(); // Use async function directly
                 });
            } else { console.error("ScanTab element not found"); }

            // No listener needed for generateTab shown, handled by scanTab hide.

            // Also stop scanner if user navigates away or closes tab
            window.addEventListener('beforeunload', stopScanner);

            console.log("[Debug] Event listeners attached.");
        });

    </script>

</body>
</html>
