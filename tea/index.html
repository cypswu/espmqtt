<!--
===============================================================================
  æª”æ¡ˆåç¨±ï¼šindex.html
  å°ˆæ¡ˆåç¨±ï¼šå“èŒ¶ QR Code ç®¡ç†ç³»çµ±
  ç‰ˆæœ¬è™Ÿç¢¼ï¼šv1.6.5 â”€ 2025-05-08 
===============================================================================

ã€åŠŸèƒ½æ‘˜è¦ã€‘
  Â· SPA å–®é ï¼šè¼¸å…¥ï¼æƒæï¼è¼‰å…¥ JSON â†’ ç”¢ç”Ÿèˆ‡é‚„åŸ QR
  Â· æ”¯æ´ PNG ä¸‹è¼‰ã€File System Access API å„²å­˜ã€é›²ç«¯ JSON æ¨¡å¼
  Â· ä¸‰åˆ†é ï¼šç”¢ç”Ÿï½œæƒæï½œä½¿ç”¨èªªæ˜ï¼›å³æ™‚é©—è­‰/Tooltip æå‡ UX

ã€Authors & Toolsã€‘
  â–¸ Author       : cypswu
  â–¸ Scaffolding  : Gemini 2.5 Pro
  â–¸ Refinement   : ChatGPT-o3

ã€ä¸»è¦ç›¸ä¾ã€‘
  â–¸ Bootstrap 5.3.2ã€€ã€€ã€€ (CSS / JS bundle)
  â–¸ Bootstrap Icons 1.11
  â–¸ QRious 4.0.2ã€€ã€€ã€€ã€€  (Canvas QR ç”¢ç”Ÿ)
  â–¸ html5-qrcode 2.3.8ã€€  (ç›¸æ©Ÿæƒæ)
  â–¸ LZ-String 1.4.4ã€€ã€€  (JSON å£“ç¸® / è§£å£“)

ã€ç€è¦½å™¨æ”¯æ´ã€‘
  Â· Chrome / Edge 96+ï¼ˆå®Œæ•´æ”¯æ´ File System Access APIï¼‰
  Â· Firefox 95+ã€€ã€€ã€€ï¼ˆè‡ªå‹•é™ç´šç‚º <a download> ä¸‹è¼‰ï¼‰
  Â· iOS / Android ä¸»æµç€è¦½å™¨çš†å¯æƒæèˆ‡è¼‰å…¥

ã€Licenseã€‘MIT

ã€ä¿®è¨‚ç´€éŒ„ã€‘
  â–¸ v1.6.5 â”€ 2025-05-08 
      - ä¸‹è¼‰ PNG å…§åµŒèŒ¶åï¼›ç•«é¢å³æ™‚é¡¯ç¤ºèŒ¶å
      - æª”åä¿ç•™ä¸­æ–‡ï¼Œåªéæ¿¾ç³»çµ±ä¿ç•™å­—
      - handleSaveQr() èˆ‡ fallback ä¸‹è¼‰æ”¹ç”¨ buildQrWithCaptionCanvas()
  â–¸ v1.6.4 â”€ 2025-05-04
      - ã€Œæƒæ QR Codeã€é ç±¤å¢åŠ ä¸€å€‹ã€Œç”±æ­¤è¼‰å…¥ JSON æª”æ¡ˆé¡¯ç¤ºã€çš„æŒ‰éˆ•
  â–¸ v1.6.2 â”€ 2025-05-02
      - é‡æ§‹è¨»è§£ï¼šå°‡å¤šé¤˜ console.log è¨»è§£ï¼Œä¿ç•™ warn/error
      - ç¨‹å¼æƒéï¼šç¢ºèªå£“ç¸®/è§£å£“ã€QR æµç¨‹èˆ‡ v1.6.1 ä¸€è‡´
  â–¸ v1.6.1 â”€ 2025-05-01
      - ã€Œä½¿ç”¨èªªæ˜ã€é ç±¤ï¼šæ–°å¢å®‰å…¨æ€§ã€FAQ
      - ä¸‹è¼‰æ©Ÿåˆ¶ï¼šFile System + <a download> é›™æ¨¡å¼
      - JSONï¼šparseQrData() æ”¯æ´ {v,d} è‡ªå‹•è§£å£“ï¼ŒCORS å¤±æ•—çµ¦æ‰‹å‹•ä¸‹è¼‰
  â–¸ v1.6.0 â”€ 2025-05-01
      - é¦–ç‰ˆå°å…¥ File System Access & é›²ç«¯ JSON æ¨¡å¼
===============================================================================
-->
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“èŒ¶ QR Code ç®¡ç†ç³»çµ±</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #5a7d2c;
            --secondary-color: #d4c3a0;
            --background-gradient: linear-gradient(to bottom right, #f8f5f0, #e9e0d1); /* Slightly adjusted gradient */
            --text-color: #333;
            --card-border-color: #e0d8c7;
            --accordion-button-bg: #f8f9fa;
            --accordion-button-active-bg: #e7f0e1;
        }

        body {
            font-family: 'Noto Serif TC', serif;
            background: var(--background-gradient);
            color: var(--text-color);
            padding-bottom: 70px; /* Increased padding */
        }

        h1, h2, h3, h4, h5, h6, .navbar-brand, .nav-link.active, .accordion-button:not(.collapsed) {
            font-family: 'Playfair Display', serif;
            color: var(--primary-color);
        }
        h1 {
            font-weight: 700;
        }

        .nav-tabs {
             border-bottom: 1px solid var(--card-border-color);
        }

        .nav-tabs .nav-link {
            color: var(--primary-color);
            border: 1px solid transparent; /* Add transparent border for consistent height */
             margin-bottom: -1px; /* Overlap border */
             border-top-left-radius: 0.375rem;
             border-top-right-radius: 0.375rem;
             padding: 0.75rem 1.25rem; /* Slightly larger padding */
        }

        .nav-tabs .nav-link.active {
            background-color: #fff; /* Make active tab background white */
            border-color: var(--card-border-color) var(--card-border-color) #fff; /* Match card border */
            font-weight: bold;
            color: var(--primary-color);
        }
         .nav-tabs .nav-link:hover:not(.active) {
             border-color: transparent transparent var(--card-border-color) transparent;
             background-color: #f8f5f0; /* Slight hover effect */
         }

        .tab-content {
            padding-top: 1.5rem; /* Add space below tabs */
        }

        .accordion-item {
            border: 1px solid var(--card-border-color);
            margin-bottom: 0.5rem; /* Add space between items */
            border-radius: 0.375rem; /* Rounded corners for items */
            overflow: hidden; /* Ensure children conform to rounded corners */
        }
        .accordion-item:first-of-type {
             border-top-left-radius: 0.375rem;
             border-top-right-radius: 0.375rem;
        }
         .accordion-item:last-of-type {
             border-bottom-left-radius: 0.375rem;
             border-bottom-right-radius: 0.375rem;
             margin-bottom: 0;
         }

        .accordion-button {
            background-color: var(--accordion-button-bg);
            color: var(--text-color);
            font-weight: bold; /* Make section titles bolder */
            border-bottom: 1px solid var(--card-border-color); /* Separator line */
        }
         .accordion-item:last-of-type .accordion-button.collapsed {
             border-bottom: 0; /* Remove border if last item and collapsed */
         }

        .accordion-button:not(.collapsed) {
            background-color: var(--accordion-button-active-bg);
            color: var(--primary-color); /* Use primary color when active */
            box-shadow: inset 0 -1px 0 var(--card-border-color); /* Keep bottom border */
        }

        .accordion-button:focus {
            box-shadow: 0 0 0 0.2rem rgba(90, 125, 44, 0.25); /* Primary color focus */
            z-index: 3; /* Ensure focus outline is visible */
        }
        .accordion-body {
            background-color: #fff; /* White background for content */
        }

        .btn {
             border-radius: 0.375rem;
             padding: 0.5rem 1rem; /* Consistent padding */
             font-weight: 500; /* Slightly bolder text */
             transition: all 0.2s ease-in-out; /* Smoother transitions */
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #486423;
            border-color: #486423;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #c3b28f;
            border-color: #c3b28f;
            transform: translateY(-1px);
             box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
         .btn-success { /* Style save button */
             background-color: #28a745;
             border-color: #28a745;
         }
         .btn-success:hover {
             background-color: #218838;
             border-color: #1e7e34;
             transform: translateY(-1px);
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
         }
         .btn-outline-secondary {
             color: var(--primary-color);
             border-color: var(--primary-color);
         }
         .btn-outline-secondary:hover {
             background-color: var(--accordion-button-active-bg);
             color: var(--primary-color);
         }


        .card {
            border: 1px solid var(--card-border-color);
            border-radius: 0.5rem;
            box-shadow: 0 6px 12px rgba(0,0,0,0.08); /* Slightly softer shadow */
            background-color: #fff; /* Ensure card background is white */
        }
        .card-body {
            padding: 1.5rem; /* More padding in cards */
        }

        .form-control, .form-select {
            border-radius: 0.375rem;
            border: 1px solid #ced4da;
        }
        .form-control:focus, .form-select:focus {
             border-color: #a8c589; /* Primary color related focus */
             box-shadow: 0 0 0 0.2rem rgba(90, 125, 44, 0.25);
        }
        .form-label {
            margin-bottom: 0.5rem;
            font-weight: 500; /* Slightly bolder labels */
        }

        #qrCodeResult img,
        #qrCodeResult canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid var(--card-border-color);
            border-radius: 0.375rem;
            margin-top: 1rem;
            background-color: white; /* Ensure QR code background is white */
            padding: 10px; /* Add padding around QR code */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        #reader {
            width: 100%; /* Make reader take full width of container */
            max-width: 400px; /* Limit max width */
            margin: 1rem auto; /* Center and add margin */
            border: 2px dashed var(--secondary-color); /* Dashed border */
            border-radius: 0.5rem;
            overflow: hidden; /* Ensure rounded corners */
            background-color: #f8f9fa; /* Light background for reader area */
            min-height: 200px; /* Ensure reader area has some height initially */
            display: flex; /* Use flexbox for centering placeholder */
            align-items: center;
            justify-content: center;
        }
        #reader video { /* Style the video element if possible */
             display: block;
             width: 100%;
             height: auto;
        }


        .list-group-item {
            word-break: break-word; /* Avoid long string overflow */
            padding: 0.75rem 1.25rem;
            border-color: var(--card-border-color); /* Match card border */
            background-color: #fff; /* Ensure white background */
        }
        .list-group-item:first-child {
             border-top-left-radius: 0; /* Remove radius if inside card */
             border-top-right-radius: 0;
        }
        .list-group-item:last-child {
             border-bottom-left-radius: 0;
             border-bottom-right-radius: 0;
        }

        .list-group-item strong {
             color: var(--primary-color);
             margin-right: 0.5em; /* Space after label */
        }

        .list-group-item img {
            max-width: 100%;
            height: auto;
            max-height: 250px; /* Increased max height */
            margin-top: 8px;
            border-radius: 0.375rem;
            border: 1px solid var(--card-border-color);
            display: block; /* Ensure image is block level */
        }
        .list-group-item pre { /* Style for textarea display */
            white-space: pre-wrap;
            word-wrap: break-word; /* Ensure long words wrap */
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            background-color: #f8f9fa; /* Slight background for pre */
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-top: 5px;
        }

        /* Hide default file input */
        input[type="file"] {
            display: none;
        }
        /* Custom file upload button style */
        .custom-file-upload {
            border: 1px solid var(--primary-color);
            display: inline-block;
            padding: 0.375rem 0.75rem; /* Match form control padding */
            cursor: pointer;
            background-color: #fff;
            color: var(--primary-color);
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
            margin-right: 5px; /* Space next to filename */
        }
        .custom-file-upload:hover {
            background-color: var(--accordion-button-active-bg);
        }
        .file-name-display {
            font-style: italic;
            color: #6c757d;
            font-size: 0.9em;
            word-break: break-all; /* Break long filenames */
        }
        #productImageFilePreview img {
             max-width: 100%; /* Allow image to scale */
             max-height: 200px;
             margin-top: 10px;
             border-radius: 0.375rem;
             border: 1px solid var(--card-border-color);
        }
        .alert {
            border-radius: 0.375rem;
            padding: 1rem 1.25rem;
        }
        /* Removed debug-info class as console logs are commented */
    </style>
</head>
<body>
    <div class="container mt-4 mb-5">
        <header class="text-center mb-5">
            <h1 class="display-5">å“èŒ¶ QR Code ç®¡ç†ç³»çµ±</h1>
        </header>

        <ul class="nav nav-tabs mb-4" id="teaTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="generate-tab" data-bs-toggle="tab" data-bs-target="#generateTabPane" type="button" role="tab" aria-controls="generateTabPane" aria-selected="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-qr-code-scan me-1" viewBox="0 0 16 16"><path d="M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5zM.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7 2H2v5h5V2ZM3 3h3v3H3V3Zm2 8H4v1h1v-1Z"/><path d="M7 9H2v5h5V9Zm-4 1h3v3H3v-3Zm8-6h1v1h-1V4Z"/><path d="M9 2h5v5H9V2Zm1 1v3h3V3h-3ZM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8H8Zm2 2H9V9h1v1Zm4 2h-1v1h-2v1h3v-2Zm-4 2v-1H8v1h2Z"/><path d="M12 9h2V8h-2v1Z"/></svg>
                    ç”¢ç”Ÿ QR Code
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="scan-tab" data-bs-toggle="tab" data-bs-target="#scanTabPane" type="button" role="tab" aria-controls="scanTabPane" aria-selected="false">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-fill me-1" viewBox="0 0 16 16"> <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/> <path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1m9-1a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0"/> </svg>
                    æƒæ QR Code
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#helpTabPane" type="button" role="tab" aria-controls="helpTabPane" aria-selected="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle me-1" viewBox="0 0 16 16"> <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1m0 1a6 6 0 1 1 0 12A6 6 0 0 1 8 2m.93 4.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.194.897c-.194.897.105 1.319.808 1.319.545 0 .934-.252 1.019-.598l.088-.416c.063-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287.082-.38-.45-.083c-.294-.07-.352-.176-.288-.469l.194-.897c.194-.897-.105-1.319-.808-1.319-.545 0-.934.252-1.019.598l-.088.416c-.063-.293-.006.399.287.47l.451.081-.082.381z"/> <circle cx="8" cy="4.5" r="1"/> </svg>
                    ä½¿ç”¨èªªæ˜
                </button>
            </li>
        </ul>

        <div class="tab-content" id="teaTabsContent">
            <div class="tab-pane fade show active" id="generateTabPane" role="tabpanel" aria-labelledby="generate-tab" tabindex="0">
                <div class="card mb-4">
                    <div class="card-body">
                        <form id="teaForm">
                            <div class="accordion" id="teaFormAccordion">
                                </div>

                            <div class="d-flex justify-content-between align-items-center mt-4 flex-wrap gap-3">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill me-1" viewBox="0 0 16 16"> <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"/> </svg>
                                    ç”¢ç”Ÿ QR Code
                                </button>
                                <div>
                                    <label for="loadQrInput" class="btn btn-secondary custom-file-upload">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16"> <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/> <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/> </svg>
                                        è¼‰å…¥ QR Code
                                    </label>
                                    <input type="file" id="loadQrInput" accept="image/png, image/jpeg, image/gif">

                                    <label for="loadJsonInput" class="btn btn-secondary custom-file-upload ms-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-arrow-up me-1" viewBox="0 0 16 16"> <path d="M8.5 11.5a.5.5 0 0 1-1 0V7.707L6.354 8.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 7.707z"/> <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/> </svg>
                                        è¼‰å…¥ JSON
                                    </label>
                                    <input type="file" id="loadJsonInput" accept=".json" style="display:none;" >
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="qrCodeResult" class="mt-4 text-center" style="display: none;">
                     <div class="card">
                         <div class="card-body">
                             <h3 class="h5 mb-3">ç”¢ç”Ÿçš„ QR Code:</h3>
                             <canvas id="qrCanvas" width="420" height="420"></canvas>
                             <p id="qrTeaName" class="fw-bold mt-2"></p>
                             <div id="qrCodeImageContainer"></div> <button id="saveQrButton" class="btn btn-success mt-3">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16"> <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/> <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/> </svg>
                                 å„²å­˜ QR Code
                             </button>
                         </div>
                     </div>
                </div>

                <div id="cloudModeSection" class="mt-4 card" style="display: none;">
                    <div class="card-body">
                        <h3 class="h5 text-warning mb-3">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill me-1" viewBox="0 0 16 16"> <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/> </svg>
                            è³‡æ–™é‡éå¤§ï¼Œè«‹ä½¿ç”¨é›²ç«¯æ¨¡å¼
                        </h3>
                        <p class="mb-2">å£“ç¸®å¾Œçš„è³‡æ–™å¤§å°è¶…é QR Code å®¹é‡ä¸Šé™ (<span id="compressedSizeInfo"></span> bytes)ã€‚</p>
                        <p>è«‹å°‡ä¸‹æ–¹ JSON è³‡æ–™è¤‡è£½ä¸¦å„²å­˜åˆ°æ‚¨é¸æ“‡çš„é›²ç«¯ç©ºé–“ï¼ˆä¾‹å¦‚ï¼š<a href="https://gist.github.com/" target="_blank" rel="noopener noreferrer">GitHub Gist</a>, <a href="https://pastebin.com/" target="_blank" rel="noopener noreferrer">Pastebin</a> ç­‰ï¼Œ**è«‹ç¢ºä¿è¨­ç‚ºå…¬é–‹æˆ–æ“æœ‰é€£çµè€…å¯è®€**ï¼‰ï¼Œç„¶å¾Œå°‡ç”¢ç”Ÿçš„**åŸå§‹è³‡æ–™é€£çµ (Raw URL)** è²¼å›ä¸‹æ–¹ã€‚</p>
                        <div class="mb-3">
                            <label for="jsonDataDisplay" class="form-label">å®Œæ•´ JSON è³‡æ–™:</label>
                            <textarea id="jsonDataDisplay" class="form-control" rows="6" readonly style="height:200px; overflow:auto;"></textarea>
                            <button id="copyJsonButton" class="btn btn-sm btn-outline-secondary mt-2">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard me-1" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/> </svg>
                                è¤‡è£½ JSON
                            </button>
                            <button id="downloadJsonButton" class="btn btn-sm btn-outline-secondary mt-2 ms-2">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/>
                              </svg>
                              ä¸‹è¼‰ JSON (å£“ç¸®æ ¼å¼)
                            </button>
                        </div>
                        <div class="mb-3">
                            <label for="cloudUrlInput" class="form-label">è²¼ä¸Šæ‚¨çš„é›²ç«¯è³‡æ–™é€£çµ (Raw URL):</label>
                            <input type="url" id="cloudUrlInput" class="form-control" placeholder="ä¾‹å¦‚ï¼šhttps://gist.githubusercontent.com/.../raw/...">
                        </div>
                        <button id="generateLinkQrButton" class="btn btn-primary">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link-45deg me-1" viewBox="0 0 16 16"> <path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1 1 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4 4 0 0 1-.128-1.287z"/> <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243z"/> </svg>
                            ä½¿ç”¨é€£çµç”¢ç”Ÿ QR Code
                        </button>
                    </div>
                </div>

                <div id="generateMessage" class="alert mt-4 d-none" role="alert"></div>
            </div>

            <div class="tab-pane fade" id="scanTabPane" role="tabpanel" aria-labelledby="scan-tab" tabindex="0">
                 <div class="card mb-4">
                     <div class="card-body text-center">
                        <h3 class="h5 mb-3">æƒæ QR Code</h3>
                        <p class="text-muted">å°‡ QR Code ç½®æ–¼ä¸‹æ–¹æƒæå€åŸŸå…§</p>
                        <div id="reader">
                            <p class="text-muted small">æƒæå™¨æº–å‚™ä¸­...</p>
                        </div>
                         <div id="scanMessage" class="alert alert-info mt-3 d-none" role="alert">
                            æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...
                        </div>

                        <div class="mt-3">
                             <label for="loadJsonInputScan" class="btn btn-outline-secondary btn-sm">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-arrow-up-fill me-1" viewBox="0 0 16 16">
                                   <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0M9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1M6.354 9.854a.5.5 0 0 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 8.207V12.5a.5.5 0 0 1-1 0V8.207z"/>
                                 </svg>
                                 ç”±æ­¤è¼‰å…¥ JSON æª”æ¡ˆé¡¯ç¤º
                             </label>
                             <input type="file" id="loadJsonInputScan" accept=".json" style="display:none;">
                         </div>
                         </div>
                 </div>

                 <div id="scanResult" class="mt-4 card" style="display: none;">
                     <div class="card-body">
                        <h3 class="h5 mb-3">æƒæ/è¼‰å…¥çµæœ:</h3>
                        <ul id="scanResultList" class="list-group list-group-flush">
                        </ul>
                     </div>
                 </div>

            </div>
            
            <div class="tab-pane fade" id="helpTabPane" role="tabpanel" aria-labelledby="help-tab" tabindex="0">
                <div class="p-3">

                  <h4 class="mb-3">ğŸ› ï¸ åŠŸèƒ½å¿«é€Ÿå°è¦½</h4>
                  <ol class="ps-3">
                    <li><strong>å¡«å¯«è¡¨å–® â†’ ç”¢ç”Ÿ QR</strong>
                        <ul>
                          <li>è¼¸å…¥èŒ¶è‘‰æˆ–å•†å“è³‡æ–™ã€å¯é¸åœ–ç‰‡ã€‚</li>
                          <li>æŒ‰ <kbd>ç”¢ç”Ÿ QR</kbd>ï¼š<br>
                              â–¸ è³‡æ–™é‡åœ¨ QR å®¹é‡å…§ â†’ ç›´æ¥ç”¢ç”Ÿ <em>å–®å¼µ</em> QR (å…§åµŒå£“ç¸®è³‡æ–™)ã€‚<br>
                              â–¸ è¶…å‡ºå®¹é‡ â†’ é€²å…¥ã€Œé›²ç«¯æ¨¡å¼ã€ï¼Œé¡¯ç¤ºåŸå§‹ JSONï¼Œä¸¦å¼•å°æ‚¨ä¸Šå‚³åˆ°é›²ç«¯ï¼ˆPastebinã€Gistâ€¦ï¼‰ï¼Œå†å°‡é›²ç«¯é€£çµè²¼å›ç”¢ç”Ÿ QRã€‚</li>
                        </ul>
                    </li>

                    <li><strong>è¤‡è£½ï¼ä¸‹è¼‰ JSON</strong>
                        <ul>
                          <li><kbd>è¤‡è£½ JSON</kbd>ï¼šå°‡è¡¨å–®å…§å®¹è½‰æ›çš„ <em>åŸå§‹æ˜ç¢¼</em> JSON è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼ˆç”¨æ–¼é›²ç«¯æ¨¡å¼ä¸Šå‚³ï¼‰ã€‚</li>
                          <li><kbd>ä¸‹è¼‰ JSON (å£“ç¸®æ ¼å¼)</kbd>ï¼šä¸‹è¼‰ <em>å£“ç¸®å¾Œ</em> çš„æœ€å° JSONï¼ˆçµæ§‹ <code>{v:1,d:"â€¦"}</code>ï¼‰ï¼Œæ­¤æ ¼å¼ä¹Ÿå¯é€éã€Œè¼‰å…¥ JSONã€é‚„åŸã€‚</li>
                        </ul>
                    </li>

                    <li><strong>æƒæ QR æˆ–è¼‰å…¥æª”æ¡ˆé‚„åŸ</strong>
                        <ul>
                          <li><strong>æƒæ QRï¼š</strong>æ”¯æ´<br>
                              â–¸ å…§åµŒå£“ç¸®å­—ä¸²<br>
                              â–¸ å…§åµŒ <code>{v:1,d:"â€¦"}</code> æœ€å° JSON<br>
                              â–¸ æŒ‡å‘é›²ç«¯ JSON çš„ <code>http / https</code> é€£çµã€‚</li>
                          <li><strong>è¼‰å…¥ QR Code (åœ–ç‰‡æª”)ï¼š</strong> é»æ“Š <kbd>è¼‰å…¥ QR Code</kbd> é¸æ“‡åœ–ç‰‡æª”ï¼Œç¨‹å¼æœƒè‡ªå‹•æƒæä¸¦å°‡è³‡æ–™å¡«å…¥ã€Œç”¢ç”Ÿã€é ç±¤çš„è¡¨å–®ã€‚</li>
                          <li><strong>è¼‰å…¥ JSON (æª”æ¡ˆ)ï¼š</strong> é»æ“Š <kbd>è¼‰å…¥ JSON</kbd> é¸æ“‡ <code>.json</code> æª”æ¡ˆï¼ˆæ”¯æ´åŸå§‹æ˜ç¢¼æˆ– <code>{v:1,d:"â€¦"}</code> å£“ç¸®æ ¼å¼ï¼‰ï¼Œç¨‹å¼æœƒå°‡è³‡æ–™å¡«å…¥ã€Œç”¢ç”Ÿã€é ç±¤çš„è¡¨å–®ã€‚</li>
                          <li><strong>é›²ç«¯é€£çµè™•ç†ï¼š</strong> è‹¥æƒæåˆ° URLï¼Œç¨‹å¼æœƒå˜—è©¦è‡ªå‹•æŠ“å–ã€‚è‹¥ç„¡æ³•é€£ç·š / CORS å—é˜» â†’ ä»‹é¢æœƒé¡¯ç¤ºä¸‹è¼‰é€£çµï¼Œè«‹å…ˆå­˜æª”ï¼Œå†ç”¨ <kbd>è¼‰å…¥ JSON</kbd> æŒ‰éˆ•åŒ¯å…¥ã€‚</li>
                        </ul>
                    </li>
                  </ol>

                  <hr>

                  <h4 class="mb-3">ğŸ”’ å®‰å…¨æ€§èˆ‡éš±ç§</h4>
                  <ul class="list-unstyled ps-3">
                    <li>âœ… <strong>æœ¬åœ°è™•ç†ï¼š</strong>è¡¨å–®è³‡æ–™ã€å£“ç¸®ï¼è§£å£“ã€QR ç”¢ç”Ÿèˆ‡æƒæå‡åœ¨ç€è¦½å™¨å…§åŸ·è¡Œï¼Œä¸ä¸Šå‚³åˆ°ä¼ºæœå™¨ã€‚</li>
                    <li>âœ… <strong>åœ–ç‰‡ Base64 åµŒå…¥ï¼š</strong>åœ–ç‰‡è½‰ Base64 å¾Œå¯«å…¥ JSONï¼Œå¯é›¢ç·šé¡¯ç¤ºï¼›è‹¥æ“”å¿ƒé«”ç©ï¼Œå¯æ”¹ç”¨å¤–éƒ¨ URLã€‚</li>
                    <li>âš ï¸ <strong>é›²ç«¯æ¨¡å¼ï¼š</strong>åªæœ‰æ‚¨ <em>è‡ªè¡Œ</em> ä¸Šå‚³ JSON è‡³ç¬¬ä¸‰æ–¹ï¼ˆGistã€Pastebin ç­‰ï¼‰æ™‚ï¼Œè³‡æ–™æ‰æœƒé›¢é–‹æœ¬æ©Ÿã€‚è«‹æ³¨æ„æ‚¨æ‰€é¸ç”¨é›²ç«¯æœå‹™çš„éš±ç§æ”¿ç­–ã€‚</li>
                    <li>âœ… <strong>å£“ç¸®éš±ç¢¼ï¼š</strong>å£“ç¸®ï¼‹Base64 å¾Œçš„å­—ä¸²ç„¡æ³•ç›´æ¥é–±è®€ï¼Œå¯é™ä½èª¤æ›å…‰é¢¨éšªï¼Œä½†éåŠ å¯†ã€‚</li>
                    <li>âœ… <strong>åŸå§‹ç¢¼å¯æª¢é–±ï¼š</strong>æ•´é ç‚ºå–®æª”å‰ç«¯ï¼Œç„¡ä»»ä½•éš±è— APIï¼›å¯é›¢ç·šä¿å­˜å¾Œä½¿ç”¨ã€‚</li>
                  </ul>

                  <hr>

                  <h4 class="mb-3">â“ å¸¸è¦‹å•é¡Œ (FAQ)</h4>
                  <dl>
                    <dt>Q. ç‚ºä½•ã€Œè³‡æ–™éå¤§ã€æœƒè·³åˆ°é›²ç«¯æ¨¡å¼ï¼Ÿ</dt>
                    <dd>QR Code æœ€å¤§å®¹é‡ç´„ 2,953 bytesï¼ˆVersion 40-Mï¼‰ã€‚è¶…éå¾ŒæƒææˆåŠŸç‡ä½ï¼Œæ”¹ç”¨é›²ç«¯ JSON é€£çµæœ€ç©©å®šã€‚</dd>

                    <dt>Q. æƒæå¾Œåªçœ‹åˆ° <code>{v:1,d:"â€¦"}</code> ï¼Ÿ</dt>
                    <dd>é‚£æ˜¯å£“ç¸®åŒ…ã€‚è‹¥è‡ªå‹•è§£å£“å¤±æ•—ï¼ˆä¾‹å¦‚æ‰‹å‹•è¤‡è£½è²¼ä¸Šï¼‰ï¼Œå¯å°‡å…¶å­˜æˆ <code>.json</code> æª” â†’ æŒ‰ <kbd>è¼‰å…¥ JSON</kbd> é‚„åŸã€‚</dd>

                    <dt>Q. ä¸‹è¼‰çš„ JSON æª”æ¡ˆå¤§å°æ¯”åŸå§‹ JSON å¤§ï¼Ÿ</dt>
                    <dd>ä¸‹è¼‰çš„ <code>{v:1,d:"..."}</code> æ ¼å¼ JSON æª”ï¼Œå…¶ <code>d</code> éƒ¨åˆ†æ˜¯ Base64 ç·¨ç¢¼ï¼Œæœƒæ¯”åŸå§‹äºŒé€²ä½å£“ç¸®è³‡æ–™å¤§ç´„ 33%ã€‚ä½† QR Code å…§éƒ¨å„²å­˜çš„æ˜¯æ›´ç·Šæ¹Šçš„äºŒé€²ä½è³‡æ–™ï¼Œä¸¦ç„¡æ­¤è†¨è„¹å•é¡Œã€‚</dd>

                    <dt>Q. é€™å€‹å·¥å…·å¯ä»¥é›¢ç·šç”¨å—ï¼Ÿ</dt>
                    <dd>å¯ä»¥ã€‚å°‡æ­¤ <code>index.html</code> æª”æ¡ˆå„²å­˜åˆ°æ‚¨çš„é›»è…¦ï¼Œç›´æ¥ç”¨ç€è¦½å™¨æ‰“é–‹å³å¯ã€‚æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼ˆç”¢ç”Ÿã€å£“ç¸®ã€è§£å£“ã€æƒææª”æ¡ˆã€è¼‰å…¥æª”æ¡ˆï¼‰çš†å¯é›¢ç·šé‹ä½œã€‚å”¯ç¨ã€Œç›¸æ©Ÿæƒæã€å’Œã€ŒæŠ“å–é›²ç«¯ URLã€éœ€è¦ç¶²è·¯é€£ç·šå’Œç€è¦½å™¨æ¬Šé™ã€‚</dd>
                  </dl>

                  <hr>

                  <h4 class="mb-3">ğŸ†˜ ç–‘é›£æ’è§£</h4>
                  <ul>
                    <li><strong>æƒä¸åˆ° QRï¼š</strong>ç¢ºå®šç›¸æ©Ÿå°ç„¦ã€ç’°å¢ƒå…‰å……è¶³ï¼›è‹¥åœ–æ¡ˆéå¯†ï¼Œå˜—è©¦æŠŠè¢å¹•äº®åº¦èª¿é«˜æˆ–æ‰“å°æ”¾å¤§ã€‚</li>
                    <li><strong>Fetch å¤±æ•— (CORS)ï¼š</strong>ç€è¦½å™¨åŸºæ–¼å®‰å…¨ç­–ç•¥é˜»æ“‹è·¨åŸŸè«‹æ±‚ï¼›è«‹é»æ“Šæƒæçµæœè¨Šæ¯ä¸­çš„ã€Œä¸‹è¼‰æª”æ¡ˆã€é€£çµï¼Œæ‰‹å‹•ä¸‹è¼‰å¾Œå†ä½¿ç”¨ <kbd>è¼‰å…¥ JSON</kbd> åŒ¯å…¥ã€‚</li>
                    <li><strong>åœ–ç‰‡éå¤§ï¼š</strong>å»ºè­°å° JPG/PNG å…ˆå£“ç¸®è‡³ <em>&lt;300 kB</em>ï¼Œæˆ–æ”¹ç”¨å¤–éƒ¨åœ–ç‰‡ URL ä»¥æ¸›å° QR Code è³‡æ–™é‡ã€‚Base64 åœ–ç‰‡æœƒé¡¯è‘—å¢åŠ  JSON å¤§å°ã€‚</li>
                    <li><strong>ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š</strong>è«‹æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦å·²æˆäºˆæ­¤é é¢ç›¸æ©Ÿæ¬Šé™ã€‚å¯èƒ½éœ€è¦é‡æ–°æ•´ç†é é¢æˆ–åœ¨ç€è¦½å™¨è¨­å®šä¸­èª¿æ•´ã€‚</li>
                  </ul>

                  <p class="text-muted small mt-4">
                    æœ€å¾Œæ›´æ–°ï¼š2025-05-04â€ƒ|â€ƒÂ© 2025 <em>cypswu</em>
                  </p>

                </div>
                </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script>
        // --- Configuration ---
        const fieldConfig = [
            // åŸºæœ¬è³‡è¨Š (Basic)
            { id: 'teaName', label: 'å“å', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼šé˜¿é‡Œå±±é‡‘è±', type: 'text', col: 'col-md-6' },
            { id: 'teaType', label: 'èŒ¶é¡', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼šçƒé¾èŒ¶', type: 'text', col: 'col-md-6' },
            { id: 'cultivar', label: 'å“ç¨®', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼šé‡‘è± (å°èŒ¶12è™Ÿ)', type: 'text', col: 'col-md-6' },
            { id: 'originRegion', label: 'ç”¢åœ°', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼šå°ç£å˜‰ç¾©ç¸£é˜¿é‡Œå±±é„‰', type: 'text', col: 'col-md-6' },
            { id: 'producer', label: 'ç”Ÿç”¢è€…/èŒ¶å» ', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼šXXèŒ¶æ¥­', type: 'text', col: 'col-md-6' },
            { id: 'altitude', label: 'æµ·æ‹” (å…¬å°º)', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼š1200', type: 'number', col: 'col-md-6' },
            { id: 'harvestDate', label: 'æ¡æ”¶æ—¥æœŸ', section: 'basic', placeholder: '', type: 'date', col: 'col-md-6' },
            { id: 'harvestSeason', label: 'æ¡æ”¶å­£ç¯€', section: 'basic', placeholder: 'ä¾‹å¦‚ï¼šæ˜¥å­£', type: 'text', col: 'col-md-6' },
            // å¸¸ç”¨è³‡è¨Š (Common)
            { id: 'grade', label: 'ç­‰ç´š', section: 'common', placeholder: 'ä¾‹å¦‚ï¼šç‰¹ç´š', type: 'text', col: 'col-md-4' },
            { id: 'batchNo', label: 'æ‰¹è™Ÿ', section: 'common', placeholder: 'ä¾‹å¦‚ï¼š202405A', type: 'text', col: 'col-md-4' },
            { id: 'netWeight', label: 'æ·¨é‡ (å…‹/å…©)', section: 'common', placeholder: 'ä¾‹å¦‚ï¼š2å…©', type: 'text', col: 'col-md-4' },
            { id: 'teaMaster', label: 'è£½èŒ¶å¸«', section: 'common', placeholder: 'ä¾‹å¦‚ï¼šç‹å°æ˜', type: 'text', col: 'col-md-4' },
            { id: 'packagingDate', label: 'åŒ…è£æ—¥æœŸ', section: 'common', placeholder: '', type: 'date', col: 'col-md-4' },
            { id: 'shelfLife', label: 'ä¿å­˜æœŸé™', section: 'common', placeholder: 'ä¾‹å¦‚ï¼š2å¹´', type: 'text', col: 'col-md-4' },
            { id: 'flavorNotes', label: 'é¢¨å‘³æè¿°', section: 'common', placeholder: 'ä¾‹å¦‚ï¼šå¸¶æœ‰å¥¶é¦™ã€èŠ±é¦™ï¼Œå£æ„Ÿæ»‘é †', type: 'textarea', col: 'col-md-6' },
            { id: 'brewGuide', label: 'æ²–æ³¡å»ºè­°', section: 'common', placeholder: 'ä¾‹å¦‚ï¼šæ°´æº«95Â°Cï¼Œç¬¬ä¸€æ³¡60ç§’...', type: 'textarea', col: 'col-md-6' },
            { id: 'storagePack', label: 'ä¿å­˜æ–¹å¼/åŒ…è£', section: 'common', placeholder: 'ä¾‹å¦‚ï¼šçœŸç©ºåŒ…è£ï¼Œå­˜æ”¾æ–¼é™°æ¶¼ä¹¾ç‡¥è™•', type: 'text', col: 'col-md-6' },
            { id: 'certification', label: 'èªè­‰æ¨™ç« ', section: 'common', placeholder: 'ä¾‹å¦‚ï¼šSGS èªè­‰ã€æœ‰æ©Ÿèªè­‰', type: 'text', col: 'col-md-6' },
            { id: 'priceTWD', label: 'åƒè€ƒå”®åƒ¹ (TWD)', section: 'common', placeholder: 'ä¾‹å¦‚ï¼š800', type: 'text', col: 'col-md-4' },
            { id: 'barcode', label: 'å•†å“æ¢ç¢¼', section: 'common', placeholder: 'ä¾‹å¦‚ï¼š471xxxxxxxxxx', type: 'text', col: 'col-md-4' },
            { id: 'productImageUrl', label: 'å•†å“åœ–ç‰‡ç¶²å€', section: 'common', placeholder: 'https://...', type: 'url', col: 'col-md-12' },
            { id: 'productImageFile', label: 'ä¸Šå‚³å•†å“åœ–ç‰‡', section: 'common', type: 'file', col: 'col-md-6' }, // Keep col-md-6 for layout
            { id: 'productImageFilePreview', label: '', section: 'common', type: 'preview', col: 'col-md-6' }, // Placeholder for preview area positioning
            { id: 'notes', label: 'å‚™è¨»', section: 'common', placeholder: 'å…¶ä»–è£œå……è³‡è¨Š', type: 'textarea', col: 'col-md-12' },
            // é€²éšè³‡è¨Š (Advance)
            { id: 'gardenArea', label: 'èŒ¶åœ’é¢ç©', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼š5å…¬é ƒ', type: 'text', col: 'col-md-4' },
            { id: 'farmingMethod', label: 'è€•ä½œæ–¹å¼', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šæœ‰æ©Ÿè¾²æ³•ã€è‡ªç„¶è¾²æ³•', type: 'text', col: 'col-md-4' },
            { id: 'fermentation', label: 'ç™¼é…µç¨‹åº¦ (%)', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼š20', type: 'text', col: 'col-md-4' },
            { id: 'roastLevel', label: 'ç„™ç«ç¨‹åº¦', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šè¼•ç„™ç«ã€ä¸­ç„™ç«', type: 'text', col: 'col-md-4' },
            { id: 'treeAge', label: 'èŒ¶æ¨¹æ¨¹é½¡', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼š30å¹´', type: 'text', col: 'col-md-4' },
            { id: 'liquorColor', label: 'èŒ¶æ¹¯è‰²æ¾¤', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šé‡‘é»ƒæ˜äº®', type: 'text', col: 'col-md-4' },
            { id: 'leafAppearance', label: 'è‘‰åº•å¤–è§€', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šè‘‰ç‰‡å®Œæ•´ï¼Œè‘‰ç·£é‘²ç´…é‚Š', type: 'text', col: 'col-md-6' },
            { id: 'climate', label: 'æ°£å€™æ¢ä»¶', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šé›²éœ§ç¹šç¹ï¼Œæ—¥å¤œæº«å·®å¤§', type: 'text', col: 'col-md-6' },
            { id: 'clarity', label: 'èŒ¶æ¹¯æ¾„æ¸…åº¦', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šæ¸…æ¾ˆé€äº®', type: 'text', col: 'col-md-4' },
            { id: 'brokenRate', label: 'ç¢æœ«ç‡ (%)', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼š< 5', type: 'text', col: 'col-md-4' },
            { id: 'moisture', label: 'å«æ°´é‡ (%)', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼š< 7', type: 'text', col: 'col-md-4' },
            { id: 'phValue', label: 'pHå€¼', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼š5.5', type: 'number', step: '0.1', col: 'col-md-6' },
            { id: 'caffeine', label: 'å’–å•¡å› å«é‡', section: 'advance', placeholder: 'ä¾‹å¦‚ï¼šä¸­ç­‰', type: 'text', col: 'col-md-6' },
            // å°ˆå®¶è³‡è¨Š (Expert)
            { id: 'pesticideReport', label: 'è¾²è—¥æª¢æ¸¬å ±å‘Š', section: 'expert', placeholder: 'ä¾‹å¦‚ï¼šSGS æª¢æ¸¬é€£çµæˆ–æ‘˜è¦', type: 'textarea', col: 'col-md-12' },
            { id: 'equipment', label: 'ä½¿ç”¨è¨­å‚™', section: 'expert', placeholder: 'ä¾‹å¦‚ï¼šç‰¹æ®Šè£½èŒ¶è¨­å‚™èªªæ˜', type: 'textarea', col: 'col-md-12' },
            { id: 'awards', label: 'å¾—çç´€éŒ„', section: 'expert', placeholder: 'ä¾‹å¦‚ï¼š2023å¹´ XX æ¯”è³½é‡‘ç', type: 'textarea', col: 'col-md-12' },
        ];

        const sections = {
            basic: { title: 'åŸºæœ¬è³‡è¨Š', fields: [], element: null },
            common: { title: 'å¸¸ç”¨è³‡è¨Š', fields: [], element: null },
            advance: { title: 'é€²éšè³‡è¨Š', fields: [], element: null },
            expert: { title: 'å°ˆå®¶è³‡è¨Š', fields: [], element: null },
        };

        const MAX_QR_LENGTH = 2953; // QR Code Version 40, Level M max bytes (approx for alphanumeric)

        // --- DOM Elements ---
        const teaForm = document.getElementById('teaForm');
        const teaFormAccordion = document.getElementById('teaFormAccordion');
        const qrCodeResultDiv = document.getElementById('qrCodeResult');
        const qrCanvas = document.getElementById('qrCanvas');
        const qrCodeImageContainer = document.getElementById('qrCodeImageContainer');
        const saveQrButton = document.getElementById('saveQrButton');
        const loadQrInput = document.getElementById('loadQrInput');
        const loadJsonInput = document.getElementById('loadJsonInput');
        const generateMessageDiv = document.getElementById('generateMessage');
        const scanMessageDiv = document.getElementById('scanMessage');
        const scanResultDiv = document.getElementById('scanResult');
        const scanResultList = document.getElementById('scanResultList');
        const readerDiv = document.getElementById('reader');
        const generateTab = document.getElementById('generate-tab');
        const scanTab = document.getElementById('scan-tab');
        const loadJsonInputScan = document.getElementById('loadJsonInputScan');
        const cloudModeSection = document.getElementById('cloudModeSection');
        const jsonDataDisplay = document.getElementById('jsonDataDisplay');
        const copyJsonButton = document.getElementById('copyJsonButton');
        const downloadJsonButton = document.getElementById('downloadJsonButton');
        const cloudUrlInput = document.getElementById('cloudUrlInput');
        const generateLinkQrButton = document.getElementById('generateLinkQrButton');
        const compressedSizeInfo = document.getElementById('compressedSizeInfo');

        let html5QrCode = null; // Scanner instance
        let currentQrData = null; // To store data for saving QR
        let currentQrDataType = 'canvas'; // 'canvas', 'image' (Currently always canvas)
        let productImageBase64 = null; // To store uploaded image data as base64 string

        // --- Utility Functions ---

        /**
         * é¡¯ç¤ºè¨Šæ¯
         * @param {HTMLElement} element - é¡¯ç¤ºè¨Šæ¯çš„å…ƒç´ 
         * @param {string} message - è¨Šæ¯å…§å®¹ (å…è¨± HTML)
         * @param {string} type - è¨Šæ¯é¡å‹ (success, danger, warning, info)
         */
        function showMessage(element, message, type = 'info') {
            element.className = `alert alert-${type} mt-3`; // Keep margin
            element.innerHTML = message; // Use innerHTML to allow basic formatting (like links)
            element.style.display = 'block';
            // console.log(`[Message ${type}]: ${message.replace(/<[^>]*>/g, '')}`); // Log plain text version
        }

        /**
         * éš±è—è¨Šæ¯
         * @param {HTMLElement} element - éš±è—è¨Šæ¯çš„å…ƒç´ 
         */
        function hideMessage(element) {
            element.style.display = 'none';
            element.textContent = '';
        }

        /**
         * å°‡ File ç‰©ä»¶è®€å–ç‚º Base64 å­—ä¸² (Data URL)
         * @param {File} file - è¦è®€å–çš„æª”æ¡ˆ
         * @returns {Promise<string>} - Base64 Data URL å­—ä¸²çš„ Promise
         */
        function readFileAsBase64(file) {
             // console.log(`[Debug] Reading file: ${file.name}, size: ${file.size}, type: ${file.type}`);
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                     // console.log("[Debug] File read successfully as Base64.");
                    resolve(reader.result); // reader.result contains the Data URL (e.g., "data:image/jpeg;base64,...")
                }
                reader.onerror = (error) => {
                     console.error("[Error] File reading error:", error);
                    reject(error);
                }
                reader.readAsDataURL(file);
            });
        }

        // --- Core Application Logic ---

        /**
         * æ ¹æ“š fieldConfig å‹•æ…‹ç”¢ç”Ÿè¡¨å–®æ¬„ä½å’Œ Accordion
         */
        function generateFormFields() {
            // console.log("[Debug] Generating form fields...");
            // 1. å°‡æ¬„ä½åˆ†é…åˆ°å„å€‹ section
            fieldConfig.forEach(field => {
                if (sections[field.section] && field.type !== 'preview') { // Exclude preview placeholders
                    sections[field.section].fields.push(field);
                }
            });

            // 2. ç‚ºæ¯å€‹ section ç”¢ç”Ÿ Accordion Item
            Object.keys(sections).forEach((key, index) => {
                const section = sections[key];
                if (section.fields.length === 0) return; // Skip sections with no fields

                const accordionItemId = `accordion-${key}`;
                const headerId = `header-${key}`;
                const collapseId = `collapse-${key}`;

                const accordionItem = document.createElement('div');
                accordionItem.className = 'accordion-item';
                sections[key].element = accordionItem; // Store reference

                const accordionHeader = document.createElement('h2');
                accordionHeader.className = 'accordion-header';
                accordionHeader.id = headerId;

                const accordionButton = document.createElement('button');
                accordionButton.className = `accordion-button ${index === 0 ? '' : 'collapsed'}`; // First section expanded by default
                accordionButton.type = 'button';
                accordionButton.dataset.bsToggle = 'collapse';
                accordionButton.dataset.bsTarget = `#${collapseId}`;
                accordionButton.ariaExpanded = index === 0 ? 'true' : 'false';
                accordionButton.ariaControls = collapseId;
                accordionButton.textContent = section.title;

                accordionHeader.appendChild(accordionButton);

                const accordionCollapse = document.createElement('div');
                accordionCollapse.id = collapseId;
                accordionCollapse.className = `accordion-collapse collapse ${index === 0 ? 'show' : ''}`;
                accordionCollapse.ariaLabelledby = headerId;
                // accordionCollapse.dataset.bsParent = '#teaFormAccordion'; // Removed to allow multiple open

                const accordionBody = document.createElement('div');
                accordionBody.className = 'accordion-body';

                const row = document.createElement('div');
                row.className = 'row g-3'; // g-3 for gutters

                // 3. åœ¨ Accordion Body ä¸­ç”¢ç”Ÿæ¬„ä½
                section.fields.forEach(field => {
                    const colDiv = document.createElement('div');
                    colDiv.className = field.col || 'col-12';

                    const label = document.createElement('label');
                    label.htmlFor = field.id;
                    label.className = 'form-label';
                    label.textContent = field.label;

                    let inputElement;
                    if (field.type === 'textarea') {
                        inputElement = document.createElement('textarea');
                        inputElement.rows = 3;
                        inputElement.id = field.id;
                        inputElement.name = field.id;
                        inputElement.className = 'form-control';
                        if (field.placeholder) inputElement.placeholder = field.placeholder;
                        colDiv.appendChild(label);
                        colDiv.appendChild(inputElement);

                    } else if (field.type === 'file') {
                        inputElement = document.createElement('input'); // The hidden actual input
                        inputElement.type = 'file';
                        inputElement.accept = 'image/*';
                        inputElement.id = field.id;
                        inputElement.name = field.id; // Important for FormData

                        const fileLabelButton = document.createElement('label'); // The visible button
                        fileLabelButton.htmlFor = field.id;
                        fileLabelButton.className = 'btn btn-sm custom-file-upload'; // Use custom class
                        fileLabelButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-image me-1" viewBox="0 0 16 16"> <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/> <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/> </svg>
                            é¸æ“‡åœ–ç‰‡`;

                        const fileNameSpan = document.createElement('span'); // To display filename
                        fileNameSpan.id = `${field.id}Name`; // ID for filename display
                        fileNameSpan.className = 'file-name-display ms-2'; // Add margin start

                        const previewDiv = document.createElement('div'); // Preview container
                        previewDiv.id = `${field.id}Preview`;
                        previewDiv.className = 'mt-2'; // Add margin top

                        colDiv.appendChild(label);
                        colDiv.appendChild(document.createElement('br')); // Line break for better layout
                        colDiv.appendChild(fileLabelButton);
                        colDiv.appendChild(fileNameSpan);
                        colDiv.appendChild(inputElement); // Append hidden input
                        colDiv.appendChild(previewDiv); // Append preview container

                        // Event listener for file selection
                        inputElement.addEventListener('change', async (event) => {
                           const file = event.target.files[0];
                           previewDiv.innerHTML = ''; // Clear previous preview
                           fileNameSpan.textContent = ''; // Clear filename
                           productImageBase64 = null; // Clear stored base64
                           if (file) {
                                fileNameSpan.textContent = file.name; // Show filename
                                try {
                                    productImageBase64 = await readFileAsBase64(file);
                                    // console.log(`[Debug] Read Base64 for preview, length: ${productImageBase64.length}`);
                                    const img = document.createElement('img');
                                    img.src = productImageBase64;
                                    img.alt = 'åœ–ç‰‡é è¦½';
                                    // Styles moved to CSS (#productImageFilePreview img)
                                    previewDiv.appendChild(img);
                                } catch (error) {
                                    console.error("ç„¡æ³•è®€å–æª”æ¡ˆ:", error);
                                    showMessage(generateMessageDiv, 'ç„¡æ³•è®€å–åœ–ç‰‡æª”æ¡ˆã€‚', 'danger');
                                    fileNameSpan.textContent = 'è®€å–å¤±æ•—';
                                }
                           }
                        });

                    } else { // Handles text, number, date, url etc.
                        inputElement = document.createElement('input');
                        inputElement.type = field.type;
                         if (field.step) inputElement.step = field.step;
                        inputElement.id = field.id;
                        inputElement.name = field.id;
                        inputElement.className = 'form-control';
                        if (field.placeholder) inputElement.placeholder = field.placeholder;
                        colDiv.appendChild(label);
                        colDiv.appendChild(inputElement);
                    }

                    row.appendChild(colDiv);
                });

                accordionBody.appendChild(row);
                accordionCollapse.appendChild(accordionBody);
                accordionItem.appendChild(accordionHeader);
                accordionItem.appendChild(accordionCollapse);
                teaFormAccordion.appendChild(accordionItem);
            });
            // console.log("[Debug] Form fields generated.");
        }

        /**
         * å°‡ QR Canvas èˆ‡èŒ¶ååˆä½µè¼¸å‡ºæˆæ–° Canvas
         * @param {HTMLCanvasElement} srcCanvas - æ—¢æœ‰çš„ QR Canvas
         * @param {string} caption   - è¦é¡¯ç¤ºçš„èŒ¶å
         * @returns {HTMLCanvasElement}
         */
        function buildQrWithCaptionCanvas(srcCanvas, caption) {
          const fontSize   = 24;           // å­—é«”å¤§å° (px)
          const paddingTop = 12;           // æ–‡å­—èˆ‡ QR çš„é–“è·
          const extraH     = caption ? fontSize + paddingTop * 2 : 0;

          const c = document.createElement('canvas');
          c.width  = srcCanvas.width;
          c.height = srcCanvas.height + extraH;

          const ctx = c.getContext('2d');
          ctx.fillStyle = '#fff';
          ctx.fillRect(0, 0, c.width, c.height);        // ç™½åº•
          ctx.drawImage(srcCanvas, 0, 0);               // ç•« QR

          if (caption) {
            ctx.font = `bold ${fontSize}px "Noto Sans", sans-serif`;
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText(caption, c.width / 2, srcCanvas.height + paddingTop);
          }
          return c;
        }
        
        /**
         * ç”¢ç”Ÿ QR Code (ä½¿ç”¨ Canvas)
         * @param {string} data - è¦ç·¨ç¢¼çš„è³‡æ–™ (å£“ç¸®å¾Œçš„ Base64 å­—ä¸²æˆ– URL)
         * @param {boolean} isUrl - æ¨™ç¤º data æ˜¯å¦ç‚º URL (ç›®å‰ä¸»è¦å½±éŸ¿ log)
         */
        function displayQrCode(data, isUrl = false) {
            hideMessage(generateMessageDiv);
            cloudModeSection.style.display = 'none';
            qrCodeImageContainer.innerHTML = ''; // Clear previous image QR (if any)
            qrCanvas.style.display = 'none'; // Hide canvas initially

            // console.log(`[Debug] Generating QR Code. Is URL: ${isUrl}, Data: ${isUrl ? data : data.substring(0, 50) + '...'}`);

            try {
                currentQrData = data; // Store data for saving
                currentQrDataType = 'canvas'; // Always use canvas for generation

                qrCanvas.style.display = 'block';
                new QRious({
                    element: qrCanvas,
                    value: data,
                    size: 420, // Match canvas dimensions
                    level: 'M', // Error correction level (L, M, Q, H)
                    padding: 20, // Padding around the QR code (pixels)
                    background: 'white',
                    foreground: 'black'
                });

                qrCodeResultDiv.style.display = 'block';
                // æ›´æ–°ç•«é¢ä¸Šçš„èŒ¶å
                const captionEl = document.getElementById('qrTeaName');
                if (captionEl) {
                  const teaNameTxt = document.getElementById('teaName')?.value.trim();
                  if (teaNameTxt) {
                      captionEl.textContent = teaNameTxt;
                      captionEl.style.display = 'block';
                  } else {
                      captionEl.style.display = 'none';
                  }
                }
                qrCodeResultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                // console.log("[Debug] QR Code generated successfully on canvas.");

            } catch (error) {
                console.error("QR Code ç”¢ç”Ÿå¤±æ•—:", error);
                showMessage(generateMessageDiv, `QR Code ç”¢ç”Ÿå¤±æ•—: ${error.message}`, 'danger');
                qrCodeResultDiv.style.display = 'none';
            }
        }

        /**
         * è™•ç†è¡¨å–®æäº¤äº‹ä»¶
         */
        async function handleFormSubmit(event) {
            event.preventDefault();
            // console.log("[Debug] Form submitted.");
            hideMessage(generateMessageDiv);
            qrCodeResultDiv.style.display = 'none';
            cloudModeSection.style.display = 'none';

            const formData = new FormData(teaForm);
            const teaData = {};

            // æ”¶é›†è¡¨å–®æ•¸æ“š
            fieldConfig.forEach(field => {
                if (field.type !== 'file' && field.type !== 'preview') { // Exclude file input and preview placeholder
                    const value = formData.get(field.id);
                    if (value !== null && value !== '') { // Only store non-empty values
                       teaData[field.id] = value;
                       // console.log(`[Debug] Form Data: ${field.id} = ${value}`);
                    }
                }
            });

            // è™•ç†åœ–ç‰‡ï¼šå„ªå…ˆä½¿ç”¨ä¸Šå‚³çš„æª”æ¡ˆ (Base64 Data URL)
            if (productImageBase64) {
                teaData.productImageBase64 = productImageBase64; // Store the Base64 Data URL
                // console.log(`[Debug] Using uploaded image Base64 (length: ${productImageBase64.length})`);
                // If Base64 exists, remove the URL field value to avoid redundancy
                if (teaData.productImageUrl) {
                    // console.log(`[Debug] Removing productImageUrl (${teaData.productImageUrl}) because Base64 exists.`);
                    delete teaData.productImageUrl;
                    const urlInput = document.getElementById('productImageUrl');
                    if(urlInput) urlInput.value = ''; // Clear the input field visually
                }
            } else if (teaData.productImageUrl) {
                // console.log(`[Debug] Using productImageUrl: ${teaData.productImageUrl}`);
                // Keep the URL if no Base64 is present
            }

            // Remove potentially empty placeholder fields if needed (e.g., productImageFile)
            delete teaData.productImageFile; // This field itself doesn't hold the value

            if (Object.keys(teaData).length === 0) {
                showMessage(generateMessageDiv, 'è«‹è‡³å°‘å¡«å¯«ä¸€é …è³‡è¨Šã€‚', 'warning');
                return;
            }

            try {
                const jsonString = JSON.stringify(teaData);
                // console.log("[Debug] Original JSON String:", jsonString.substring(0, 200) + '...'); // Log beginning

                const compressedData = LZString.compressToBase64(jsonString);
                const compressedLength = compressedData.length;
                // console.log("[Debug] Compressed Base64:", compressedData.substring(0, 100) + '...'); // Log beginning
                // console.log("[Debug] Compressed Length:", compressedLength);

                if (compressedLength <= MAX_QR_LENGTH) {
                    // --- Direct Mode ---
                    // console.log("[Debug] Data fits in QR Code (Direct Mode).");
                    displayQrCode(compressedData, false);
                } else {
                    // --- Cloud Mode ---
                    // console.log("[Debug] Data too large for QR Code (Cloud Mode).");
                    compressedSizeInfo.textContent = compressedLength; // Show compressed size
                    showMessage(generateMessageDiv, `è³‡æ–™é‡éå¤§ (${compressedLength} > ${MAX_QR_LENGTH} bytes)ï¼Œè«‹ä½¿ç”¨é›²ç«¯æ¨¡å¼ã€‚`, 'warning');
                    jsonDataDisplay.value = jsonString; // Display full JSON for copying
                    cloudUrlInput.value = ''; // Clear URL input
                    cloudModeSection.style.display = 'block';
                    qrCodeResultDiv.style.display = 'none';
                    cloudModeSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }

            } catch (error) {
                console.error("è™•ç†è¡¨å–®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                showMessage(generateMessageDiv, `è™•ç†è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'danger');
            }
        }

        /**
         * è™•ç†å„²å­˜ QR Code æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼ˆçµåˆ File System Access API èˆ‡ <a download> fallbackï¼‰
         */
        async function handleSaveQr() {
            if (!currentQrData) {
                showMessage(generateMessageDiv, 'æ²’æœ‰å¯å„²å­˜çš„ QR Codeã€‚', 'warning');
                return;
            }
            // console.log("[Debug] é–‹å§‹å„²å­˜ QR Code...");

            // 1. å»ºè­°æª”åï¼ˆä¾†è‡ªèŒ¶åï¼‰
            const teaName = document.getElementById('teaName')?.value.trim();
            const baseName = `tea_${teaName ? teaName.replace(/[\\/:*?"<>|]/g, '') : 'unknown'}`;
            const suggestedName = baseName + '.png';

            // å¦‚æœæ”¯æ´ File System Access APIï¼Œå°±ç”¨åŸç”Ÿå°è©±æ¡†
            if (window.showSaveFilePicker) {
                try {
                    // console.log("[Debug] ä½¿ç”¨ File System Access API å„²å­˜");
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName,
                        types: [{
                            description: 'PNG åœ–ç‰‡',
                            accept: { 'image/png': ['.png'] }
                        }]
                    });
                    const writable = await fileHandle.createWritable();

                    // å–å¾— Blob (Always from canvas in current implementation)
                    const composite = buildQrWithCaptionCanvas(qrCanvas, teaName);
                    let blob = await new Promise(res => composite.toBlob(res, 'image/png'));                    
                    // else if (currentQrDataType === 'image' && qrCodeImageContainer.firstChild) { // Fallback if image was used
                    //     const resp = await fetch(qrCodeImageContainer.firstChild.src);
                    //     blob = await resp.blob();
                    // }

                    if (!blob) throw new Error('ç„¡æ³•å–å¾— QR Code åœ–ç‰‡è³‡æ–™');

                    await writable.write(blob);
                    await writable.close();

                    showMessage(generateMessageDiv, `QR Code (${fileHandle.name}) å·²æˆåŠŸå„²å­˜ã€‚`, 'success');
                    // console.log("[Debug] File System Access API å„²å­˜å®Œæˆ");
                } catch (e) {
                    if (e.name === 'AbortError') {
                        // console.log("[Debug] ä½¿ç”¨è€…å–æ¶ˆå„²å­˜");
                        // No message needed if user cancelled
                    } else {
                        console.error("å„²å­˜å¤±æ•— (File System API)ï¼š", e);
                        showMessage(generateMessageDiv, 'å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–å˜—è©¦å…¶ä»–ç€è¦½å™¨ã€‚', 'danger');
                    }
                }

            // fallback: å‚³çµ± <a download> + prompt()
            } else {
                // console.log("[Debug] ä½¿ç”¨ <a download> fallback å„²å­˜");
                // 2. è©¢å•ä½¿ç”¨è€…æª”å
                const inputName = prompt('è«‹è¼¸å…¥è¦å„²å­˜çš„æª”åï¼ˆä¸å«å‰¯æª”åï¼‰', baseName);
                if (!inputName) {
                    // console.log("[Debug] ä½¿ç”¨è€…å–æ¶ˆæª”åè¼¸å…¥");
                    return;
                }
                const filename = inputName.endsWith('.png') ? inputName : inputName + '.png';

                // 3. ç”¢ç”Ÿ data URL (Always from canvas)
                let dataUrl;
                if (currentQrDataType === 'canvas' && qrCanvas) {
                    try {
                        dataUrl = buildQrWithCaptionCanvas(qrCanvas, teaName).toDataURL('image/png');
                    } catch (e) {
                        console.error("å¾ Canvas åŒ¯å‡ºå¤±æ•—ï¼š", e);
                        showMessage(generateMessageDiv, 'ç„¡æ³•å¾ Canvas åŒ¯å‡º QR Codeã€‚', 'danger');
                        return;
                    }
                // } else if (currentQrDataType === 'image' && qrCodeImageContainer.firstChild) { // Fallback
                //     dataUrl = qrCodeImageContainer.firstChild.src;
                } else {
                    showMessage(generateMessageDiv, 'æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ QR Code ä¾†æºã€‚', 'warning');
                    return;
                }

                // 4. è§¸ç™¼ä¸‹è¼‰
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage(generateMessageDiv, `QR Code (${filename}) å·²é–‹å§‹ä¸‹è¼‰ã€‚`, 'success');
                // console.log("[Debug] <a download> fallback å„²å­˜å®Œæˆ");
            }
        }

        /**
         * è™•ç†è¤‡è£½ JSON æŒ‰éˆ•é»æ“Šäº‹ä»¶ (Copies raw JSON from textarea)
         */
        function handleCopyJson() {
            if (!jsonDataDisplay.value) return;
            jsonDataDisplay.select();
            jsonDataDisplay.setSelectionRange(0, 99999); // For mobile devices
            try {
                // Use Clipboard API for modern browsers
                navigator.clipboard.writeText(jsonDataDisplay.value).then(() => {
                    // console.log("[Debug] JSON copied to clipboard (Clipboard API).");
                    showMessage(generateMessageDiv, 'åŸå§‹ JSON å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚', 'success');
                }).catch(err => {
                     // console.warn("[Debug] Clipboard API failed, falling back to execCommand:", err);
                     // Fallback for older browsers (less reliable)
                    if(document.execCommand('copy')) {
                        // console.log("[Debug] JSON copied to clipboard (execCommand).");
                        showMessage(generateMessageDiv, 'åŸå§‹ JSON å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚', 'success');
                    } else {
                        throw new Error('execCommand failed');
                    }
                });
            } catch (err) {
                console.error('ç„¡æ³•è¤‡è£½ JSON:', err);
                showMessage(generateMessageDiv, 'è¤‡è£½ JSON å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–ä¸¦è¤‡è£½ã€‚', 'danger');
            } finally {
                 // Deselect text after attempt
                 window.getSelection()?.removeAllRanges();
            }
        }

        /**
         * è™•ç†ä¸‹è¼‰ JSON æŒ‰éˆ•é»æ“Šäº‹ä»¶ (Downloads compressed {v,d} format)
         */
        async function handleDownloadJson() {
          if (!jsonDataDisplay.value) {
            showMessage(generateMessageDiv, 'æ²’æœ‰å¯ä¸‹è¼‰çš„ JSON è³‡æ–™ (è«‹å…ˆç”¢ç”Ÿ QR Code æˆ–è§¸ç™¼é›²ç«¯æ¨¡å¼)ã€‚', 'warning');
            return;
          }

          // 1. å»ºè­°æª”åï¼ˆå¾èŒ¶åæˆ–å›ºå®šå‰ç¶´ç”¢ç”Ÿï¼‰
          const teaName    = document.getElementById('teaName')?.value.trim();
          const baseName   = `tea_${teaName ? teaName.replace(/[\\/:*?"<>|]/g, '') : 'unknown'}`;
          const suggestedName = baseName + '.json';

          // 2. Blob æº–å‚™: å–å› textarea çš„åŸå§‹ JSONï¼Œå£“ç¸®ä¸¦åŒ… minimal JSONï¼ˆåŠ ç‰ˆæœ¬è™Ÿ vï¼‰
          const rawJson = jsonDataDisplay.value;
          let payload;
          try {
              const compressed = LZString.compressToBase64(rawJson);
              payload = JSON.stringify({ v: 1, d: compressed });
          } catch (e) {
              console.error("å£“ç¸® JSON å¤±æ•—:", e);
              showMessage(generateMessageDiv, 'å£“ç¸® JSON è³‡æ–™å¤±æ•—ã€‚', 'danger');
              return;
          }

          const blob = new Blob([payload], { type: 'application/json;charset=utf-8' }); // Specify charset

          // 3. å¦‚æœæ”¯æ´ File System Access APIï¼Œå°±ç”¨åŸç”Ÿå„²å­˜å°è©±æ¡†
          if (window.showSaveFilePicker) {
            try {
              const handle = await window.showSaveFilePicker({
                suggestedName,
                types: [{
                  description: 'JSON æª”æ¡ˆ',
                  accept: { 'application/json': ['.json'] }
                }]
              });
              const writable = await handle.createWritable();
              await writable.write(blob);
              await writable.close();
              showMessage(generateMessageDiv, `å£“ç¸®æ ¼å¼ JSON (${handle.name}) å·²æˆåŠŸå„²å­˜ã€‚`, 'success');
              // console.log("[Debug] JSON saved via File System Access API");
              return;
            } catch (e) {
              if (e.name === 'AbortError') {
                // console.log("[Debug] ä½¿ç”¨è€…å–æ¶ˆå„²å­˜");
                return; // No message needed
              }
              console.error("å„²å­˜ JSON å¤±æ•— (File System API)ï¼š", e);
              showMessage(generateMessageDiv, 'JSON å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'danger');
              return;
            }
          }

          // 4. fallbackï¼šprompt å–æª”å + <a download>
          // console.log("[Debug] ä½¿ç”¨ <a download> fallback å„²å­˜ JSON");
          const inputName = prompt('è«‹è¼¸å…¥è¦å„²å­˜çš„æª”åï¼ˆä¸å«å‰¯æª”åï¼‰', baseName);
          if (!inputName) {
            // console.log("[Debug] ä½¿ç”¨è€…å–æ¶ˆæª”åè¼¸å…¥");
            return;
          }
          const filename = inputName.endsWith('.json') ? inputName : inputName + '.json';

          const url = URL.createObjectURL(blob);
          const a   = document.createElement('a');
          a.href    = url;
          a.download= filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url); // Clean up object URL

          showMessage(generateMessageDiv, `å£“ç¸®æ ¼å¼ JSON (${filename}) å·²é–‹å§‹ä¸‹è¼‰ã€‚`, 'success');
          // console.log("[Debug] JSON downloaded via <a download> fallback");
        }

        /**
         * è™•ç†ä½¿ç”¨é€£çµç”¢ç”Ÿ QR Code æŒ‰éˆ•é»æ“Šäº‹ä»¶
         */
        function handleGenerateLinkQr() {
            const url = cloudUrlInput.value.trim();
            // console.log(`[Debug] Generating QR from link: ${url}`);
            if (!url) {
                showMessage(generateMessageDiv, 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›²ç«¯è³‡æ–™é€£çµã€‚', 'warning');
                cloudUrlInput.focus();
                return;
            }
            try {
                 // Basic URL validation (checks format, not reachability)
                 new URL(url);
                 displayQrCode(url, true); // Generate QR code with the URL itself
                 cloudModeSection.style.display = 'none'; // Hide cloud mode section after generating
            } catch (error) {
                 // console.error("[Debug] Invalid URL format:", error);
                 showMessage(generateMessageDiv, 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ URL æ ¼å¼ (ä¾‹å¦‚ https://...) ã€‚', 'danger');
                 cloudUrlInput.focus();
            }
        }


        /**
         * è§£æ QR Code è³‡æ–™ (å¯èƒ½æ˜¯å£“ç¸®å­—ä¸²ã€æœ€å° JSON æ ¼å¼æˆ– URL)
         * @param {string} decodedText - å¾ QR Code æƒæåˆ°çš„åŸå§‹å­—ä¸²
         * @returns {Promise<object>} - è§£æå¾Œçš„ JSON ç‰©ä»¶ Promise
         */
        async function parseQrData(decodedText) {
            // console.log(`[Debug] Parsing QR Data: ${decodedText.substring(0, 100)}...`);
            const activeTabMessageDiv = document.getElementById('scan-tab').classList.contains('active')
                                      ? scanMessageDiv : generateMessageDiv;

            // 1. å˜—è©¦ minimal-JSON æ ¼å¼ {v:1, d:"..."} (ç›´æ¥å…§åµŒ)
            try {
                const maybeJson = JSON.parse(decodedText);
                if (maybeJson && typeof maybeJson === 'object' && maybeJson.v === 1 && typeof maybeJson.d === 'string') {
                    // console.log('[Debug] Detected embedded minimal-JSON payload, decompressing...');
                    const jsonStr = LZString.decompressFromBase64(maybeJson.d);
                    if (!jsonStr) throw new Error('å¾ minimal-JSON è§£å£“å¤±æ•— (çµæœç‚ºç©º)');
                    return JSON.parse(jsonStr); // Return the final data object
                }
            } catch (_) {
                // Not embedded minimal-JSON, continue to next checks
            }

            // 2. URL æ¨¡å¼ (http:// or https://)
            if (decodedText.startsWith('http://') || decodedText.startsWith('https://')) {
                // console.log('[Debug] Detected URL, attempting to fetch JSON...');
                showMessage(activeTabMessageDiv, 'åµæ¸¬åˆ° URLï¼Œæ­£åœ¨æ“·å–é›²ç«¯è³‡æ–™...', 'info');
                try {
                    const response = await fetch(decodedText, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json, text/plain, */*' },
                        mode: 'cors', // Important for cross-origin requests
                        // Add timeout? Maybe not needed as browser handles it.
                    });

                    if (!response.ok) {
                        // Try to get more info from response if possible
                        let errorText = `ä¼ºæœå™¨éŒ¯èª¤: ${response.status} ${response.statusText}`;
                        try {
                            const bodyText = await response.text();
                            if (bodyText) errorText += ` - ${bodyText.substring(0, 100)}`;
                        } catch (e) {/* Ignore body read error */}
                        throw new Error(errorText);
                    }

                    const contentType = response.headers.get("content-type");
                    // Check if content type indicates non-JSON data (like HTML)
                    if (contentType && (contentType.includes("text/html") || contentType.includes("application/xml"))) {
                         console.warn(`[Warning] Received non-JSON content type: ${contentType}. URL might be wrong.`);
                         // Throw a specific error for HTML content
                         throw new Error("Expected JSON, but received HTML/XML content.");
                    }

                    // Attempt to parse as JSON
                    const fetchedData = await response.json(); // This will throw SyntaxError if not JSON
                    // console.log('[Debug] Successfully fetched JSON from URL:', fetchedData);

                    // Check if the *fetched* data is minimal-JSON {v,d}
                    if (fetchedData && typeof fetchedData === 'object' && fetchedData.v === 1 && typeof fetchedData.d === 'string') {
                      // console.log('[Debug] Fetched data is minimal-JSON payload, decompressing...');
                      const str = LZString.decompressFromBase64(fetchedData.d);
                      if (!str) throw new Error('å¾ URL çš„ minimal-JSON è§£å£“å¾Œç‚ºç©º');
                      showMessage(activeTabMessageDiv, 'å·²æˆåŠŸå¾é›²ç«¯è¼‰å…¥ä¸¦è§£å£“è³‡æ–™ã€‚', 'success');
                      return JSON.parse(str); // Return the final data object
                    } else {
                      // Assume fetched data is the final raw JSON object
                      showMessage(activeTabMessageDiv, 'å·²æˆåŠŸå¾é›²ç«¯è¼‰å…¥è³‡æ–™ã€‚', 'success');
                      return fetchedData;
                    }
                } catch (error) {
                    console.error('å¾ URL æ“·å–æˆ–è™•ç† JSON å¤±æ•—:', error);
                    
                    let userMessage = `ç„¡æ³•è‡ªå‹•æ“·å–è³‡æ–™ã€‚è«‹æ‰‹å‹•ä¸‹è¼‰æª”æ¡ˆä¸¦ä½¿ç”¨ã€Œè¼‰å…¥ JSONã€ï¼š`; // Default message

                    // Improve error message based on error type
                    const isCorsError = error instanceof TypeError && error.message.toLowerCase().includes('fetch');
                    const isSyntaxError = error instanceof SyntaxError;
                    const receivedHtmlError = error.message && (error.message.includes("Expected JSON, but received HTML/XML content.") || error.message.includes("token '<'"));

                    if (isCorsError) {
                        userMessage = `ç„¡æ³•è‡ªå‹•æ“·å–è³‡æ–™ (å¯èƒ½ç‚º CORS è·¨åŸŸé™åˆ¶)ã€‚è«‹æ‰‹å‹•ä¸‹è¼‰æª”æ¡ˆä¸¦ä½¿ç”¨ã€Œè¼‰å…¥ JSONã€ï¼š`;
                    } else if (receivedHtmlError || isSyntaxError) {
                        userMessage = `ç„¡æ³•è‡ªå‹•æ“·å–è³‡æ–™ï¼šé€£çµæœªæŒ‡å‘æœ‰æ•ˆçš„ JSON æª”æ¡ˆ (å¯èƒ½ç‚º HTML é é¢æˆ–å…¶ä»–æ ¼å¼)ã€‚è«‹æª¢æŸ¥é€£çµæˆ–æ‰‹å‹•ä¸‹è¼‰æª”æ¡ˆä¸¦ä½¿ç”¨ã€Œè¼‰å…¥ JSONã€ï¼š`;
                    } else if (error.message) { // Use the original error message for other network/server issues
                         userMessage = `ç„¡æ³•è‡ªå‹•æ“·å–è³‡æ–™ (${error.message})ã€‚è«‹æ‰‹å‹•ä¸‹è¼‰æª”æ¡ˆä¸¦ä½¿ç”¨ã€Œè¼‰å…¥ JSONã€ï¼š`;
                    }

                    // Always show the download link attempt
                    // Ensure the link HTML is correctly formed
                    const downloadLinkHtml = `<a href="${decodedText}" target="_blank" rel="noopener noreferrer" class="alert-link">é»æ­¤å˜—è©¦ä¸‹è¼‰æª”æ¡ˆ</a>`;
                    showMessage(activeTabMessageDiv, `${userMessage} ${downloadLinkHtml}`, 'warning');
                      
                    // Signal upstream to potentially skip redundant error messages
                    throw new Error('manualDownloadRequired');
                }
            }

            // 3. å£“ç¸®å­—ä¸²æ¨¡å¼ (Legacy or direct compression)
            // console.log('[Debug] Assuming compressed string, attempting decompression...');
            try {
                const decompressed = LZString.decompressFromBase64(decodedText);
                if (!decompressed) {
                    // This could mean it wasn't Base64 or wasn't compressed with LZString
                    throw new Error('è§£å£“ç¸®å¾Œçµæœç‚ºç©º (å¯èƒ½éé æœŸæ ¼å¼)');
                }
                // console.log('[Debug] Decompressed successfully');
                return JSON.parse(decompressed); // Parse the decompressed JSON string
            } catch (error) {
                console.error('è§£å£“ç¸®æˆ–è§£æ JSON å¤±æ•—:', error);
                // Avoid overwriting the 'manualDownloadRequired' error
                if (error.message === 'manualDownloadRequired') throw error;

                let userFriendlyError = 'è§£ç¢¼å¤±æ•—ï¼šè³‡æ–™æ ¼å¼ç„¡æ³•è­˜åˆ¥æˆ–å·²ææ¯€ã€‚';
                if (error instanceof SyntaxError) {
                    userFriendlyError = `è§£ç¢¼å¤±æ•—ï¼šJSON æ ¼å¼éŒ¯èª¤ (${error.message})ã€‚`;
                } else if (error.message.includes('è§£å£“ç¸®å¾Œçµæœç‚ºç©º')) {
                    userFriendlyError = 'è§£ç¢¼å¤±æ•—ï¼šç„¡æ³•è§£å£“ç¸®è³‡æ–™ (å¯èƒ½éé æœŸæ ¼å¼)ã€‚';
                }
                // Add more specific error checks if needed
                throw new Error(userFriendlyError); // Throw a more user-friendly error
            }
        }

        /**
         * å°‡è§£æå¾Œçš„è³‡æ–™é¡¯ç¤ºåœ¨æƒæçµæœåˆ—è¡¨ä¸­
         * @param {object} data - è§£æå¾Œçš„ JSON ç‰©ä»¶
         */
        function displayScanResult(data) {
            // console.log("[Debug] Displaying scan result:", data);
            scanResultList.innerHTML = ''; // Clear previous results
            let hasContent = false;

            // Create a map of field configurations for easier lookup
            const fieldMap = fieldConfig.reduce((map, field) => {
                map[field.id] = field;
                return map;
            }, {});

            // Iterate through the data received from the QR code
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    const field = fieldMap[key]; // Get field config using the key
                    const value = data[key];

                    // Skip empty/null values and the base64 key itself (it's handled separately)
                    if (value === null || value === '' || key === 'productImageBase64') {
                        continue;
                    }

                    const label = field ? field.label : key; // Use config label or key as fallback
                    const type = field ? field.type : 'text'; // Get type from config, default to text

                    let displayValueHtml = '';
                    hasContent = true; // Mark that we have content to display

                    // --- Format value based on type ---
                    if (key === 'productImageUrl' && value) {
                         // console.log(`[Debug] Displaying image from URL: ${value}`);
                         // Display link and image preview with error handling
                         displayValueHtml = `<a href="${value}" target="_blank" rel="noopener noreferrer">${value}</a><br>
                                             <img src="${value}" alt="å•†å“åœ–ç‰‡ (URL è¼‰å…¥ä¸­...)" class="img-fluid rounded mt-2"
                                                  onerror="this.onerror=null; this.src='https://placehold.co/200x100/eee/ccc?text=ç„¡æ³•è¼‰å…¥åœ–ç‰‡'; this.alt='ç„¡æ³•è¼‰å…¥åœ–ç‰‡';">`;
                    } else if (type === 'textarea' && value) {
                         // console.log(`[Debug] Displaying textarea: ${key}`);
                         // Use <pre> for textareas to preserve line breaks and spacing
                         // Escape HTML content within <pre> to prevent XSS
                         const escapedValue = value.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                         displayValueHtml = `<pre>${escapedValue}</pre>`;
                    } else if (type === 'url' && value && key !== 'productImageUrl') { // Handle other URLs as links
                         // console.log(`[Debug] Displaying URL link: ${key}`);
                         // Ensure URL is properly escaped if needed, though usually href handles it
                         displayValueHtml = `<a href="${value}" target="_blank" rel="noopener noreferrer">${value}</a>`;
                    } else if (type === 'date' && value) {
                        // Optionally format date for display
                        try {
                           displayValueHtml = new Date(value).toLocaleDateString('zh-TW'); // Example: TW locale
                        } catch (e) {
                           displayValueHtml = value; // Fallback to original value if date is invalid
                        }
                    } else {
                        // console.log(`[Debug] Displaying text: ${key} = ${value}`);
                        // Default display: Escape HTML to prevent XSS from text fields
                        displayValueHtml = String(value).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    }

                    // Create and append list item
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';
                    // Use innerHTML carefully, only for trusted label and formatted value
                    listItem.innerHTML = `<strong>${label}:</strong> ${displayValueHtml}`;
                    scanResultList.appendChild(listItem);
                }
            }

             // Specifically check and display Base64 image if it exists
             if (data.productImageBase64) {
                 const field = fieldMap['productImageFile']; // Get the config for the file input
                 const label = field ? field.label : 'ä¸Šå‚³å•†å“åœ–ç‰‡'; // Use its label
                 hasContent = true;
                 const listItem = document.createElement('li');
                 listItem.className = 'list-group-item';
                 // console.log(`[Debug] Displaying image from Base64 (length: ${data.productImageBase64.length}) linked to ${label}`);
                 // Use the Base64 data directly in the src attribute
                 listItem.innerHTML = `<strong>${label}:</strong><br><img src="${data.productImageBase64}" alt="å•†å“åœ–ç‰‡ (ä¾†è‡ª QR Code)" class="img-fluid rounded mt-2">`;
                 scanResultList.appendChild(listItem);
             }


            // Show or hide the result section based on content
            if (hasContent) {
                scanResultDiv.style.display = 'block';
                scanResultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                 // Final success message already shown by parseQrData or scan success
                 // showMessage(scanMessageDiv, 'è³‡æ–™é¡¯ç¤ºå®Œç•¢ã€‚', 'success');
            } else {
                scanResultDiv.style.display = 'none';
                showMessage(scanMessageDiv, 'QR Code ä¸­æ²’æœ‰æ‰¾åˆ°å¯é¡¯ç¤ºçš„è³‡æ–™ã€‚', 'warning');
            }
        }

         /**
         * å°‡è§£æå¾Œçš„è³‡æ–™å›å¡«åˆ°ã€Œç”¢ç”Ÿã€é ç±¤çš„è¡¨å–®ä¸­
         * @param {object} data - è§£æå¾Œçš„ JSON ç‰©ä»¶
         */
        async function populateForm(data) { // Make async if any part needs await
            // console.log("[Debug] Populating form with data:", data);
            try {
                // Reset form and related UI elements first
                teaForm.reset(); // Clear standard form fields
                productImageBase64 = null; // Clear stored Base64 variable

                // Clear file input preview, filename display, and reset button text
                const previewDiv = document.getElementById('productImageFilePreview');
                const fileNameSpan = document.getElementById('productImageFileName'); // Corrected ID usage
                const fileInputButton = document.querySelector('label[for="productImageFile"]'); // The visible button label
                if (previewDiv) previewDiv.innerHTML = '';
                if (fileNameSpan) fileNameSpan.textContent = '';
                if (fileInputButton) { // Reset button to initial state
                    fileInputButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-image me-1" viewBox="0 0 16 16"> <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/> <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/> </svg>
                        é¸æ“‡åœ–ç‰‡`;
                }
                 // Also clear the hidden file input value itself
                 const fileInput = document.getElementById('productImageFile');
                 if (fileInput) fileInput.value = '';


                let populatedFields = 0;
                // Populate form fields based on the data object
                fieldConfig.forEach(field => {
                    const inputElement = document.getElementById(field.id);
                    if (inputElement) {
                        // Handle file input separately for preview
                        if (field.type === 'file') {
                            // Check if Base64 data exists in the loaded data
                            if (data.productImageBase64) {
                                // console.log(`[Debug] Populating Base64 image preview (length: ${data.productImageBase64.length})`);
                                productImageBase64 = data.productImageBase64; // Store it globally for potential resubmission
                                if (previewDiv) {
                                    const img = document.createElement('img');
                                    img.src = productImageBase64;
                                    img.alt = 'è¼‰å…¥çš„åœ–ç‰‡';
                                    // Add error handling for Base64 display? Unlikely to fail, but possible.
                                    img.onerror = () => { previewDiv.innerHTML = '<small class="text-danger">ç„¡æ³•é¡¯ç¤º Base64 åœ–ç‰‡</small>'; };
                                    previewDiv.appendChild(img);
                                }
                                if (fileNameSpan) fileNameSpan.textContent = 'å·²è¼‰å…¥åœ–ç‰‡ (ä¾†è‡ªè³‡æ–™)';
                                if (fileInputButton) { // Change button text to indicate loaded image
                                     fileInputButton.innerHTML = `
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill me-1" viewBox="0 0 16 16"> <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/> </svg>
                                        æ›´æ”¹åœ–ç‰‡`;
                                }
                                populatedFields++;
                             } else if (data.productImageUrl) {
                                 // If only URL exists, populate the URL field, leave file input clear.
                                 // console.log(`[Debug] Image URL found (${data.productImageUrl}), populating URL field.`);
                                 const urlInput = document.getElementById('productImageUrl');
                                 if (urlInput) {
                                     urlInput.value = data.productImageUrl;
                                     populatedFields++; // Count URL field as populated
                                 }
                                 if (fileNameSpan) fileNameSpan.textContent = 'åœ–ç‰‡ä½¿ç”¨ä¸‹æ–¹ç¶²å€';
                             }
                        } else if (field.type !== 'preview') { // Populate regular fields (excluding preview placeholder)
                             if (data[field.id] !== undefined && data[field.id] !== null) {
                                 inputElement.value = data[field.id];
                                 // console.log(`[Debug] Populated field ${field.id} with value: ${data[field.id]}`); // Reduce log verbosity
                                 populatedFields++;
                             } else {
                                 inputElement.value = ''; // Ensure field is cleared if not present in data
                             }
                        }
                    } else {
                        // This case might happen for the 'preview' type placeholder or if ID mismatch
                        if(field.type !== 'preview') {
                            console.warn(`[Warning] Input element not found for field ID: ${field.id} during form population.`);
                        }
                    }
                });

                // console.log(`[Debug] Form population complete. ${populatedFields} fields populated.`);

                // Expand the first accordion section by default after populating
                const firstAccordionButton = teaFormAccordion.querySelector('.accordion-button');
                const firstCollapse = teaFormAccordion.querySelector('.accordion-collapse');
                if (firstAccordionButton && firstCollapse && firstAccordionButton.classList.contains('collapsed')) {
                    // Use Bootstrap's Collapse instance to programmatically show
                    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(firstCollapse);
                    bsCollapse.show();
                    // console.log("[Debug] Expanded first accordion section after population.");
                }

                // Final success message on the generate tab
                showMessage(generateMessageDiv, 'å·²æˆåŠŸå¾ä¾†æºè¼‰å…¥è³‡æ–™åˆ°è¡¨å–®ã€‚', 'success');

                // Switch back to the generate tab if not already there
                if (!generateTab.classList.contains('active')) {
                    const bsGenerateTab = bootstrap.Tab.getOrCreateInstance(generateTab);
                    bsGenerateTab.show();
                }

                // Scroll to top smoothly for better UX after loading data
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                 console.error("[Error] Error during form population:", error);
                 showMessage(generateMessageDiv, `å¡«å……è¡¨å–®æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'danger');
            }
        }


        /**
         * QR Code æƒææˆåŠŸå›èª¿ (From Camera)
         */
        async function onScanSuccess(decodedText, decodedResult) {
            // Check if the scanner instance is still valid (might have been stopped concurrently)
            if (!html5QrCode) {
                 // console.warn("[Debug] Scan success callback triggered, but scanner instance is null. Ignoring.");
                 return; // Prevent processing if scanner was stopped/nulled
            }

            // console.log(`[Debug] QR Scan Success! Raw Text: ${decodedText}`, decodedResult);
            showMessage(scanMessageDiv, `æƒææˆåŠŸï¼æ­£åœ¨è™•ç†è³‡æ–™...`, 'info');
            scanResultDiv.style.display = 'none'; // Hide previous results while processing

            // --- Stop Scanner Gracefully ---
            const scannerToStop = html5QrCode; // Keep reference to the active scanner
            html5QrCode = null; // Nullify the global instance immediately to prevent race conditions

            try {
                // Ensure the reader div exists before trying to stop
                if (document.getElementById(scannerToStop.elementId)) {
                    await scannerToStop.stop();
                    // console.log("[Debug] QR Code scanning stopped successfully after scan.");
                    readerDiv.innerHTML = '<p class="text-center text-success p-3">æƒæå™¨å·²åœæ­¢ã€‚</p>';
                } else {
                    // console.warn("[Debug] Reader element not found during stop after scan.");
                }
            } catch (err) {
                 // Log error but continue processing the scanned data
                 console.error("[Error] Error stopping scanner after scan, but continuing processing:", err);
                 readerDiv.innerHTML = '<p class="text-center text-warning p-3">æƒæå™¨åœæ­¢æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä½†å·²è®€å–è³‡æ–™ã€‚</p>';
            }
            // --- End Stop Scanner ---


            // --- Process Scanned Data ---
            try {
                const jsonData = await parseQrData(decodedText);
                displayScanResult(jsonData); // Display results on scan tab
            } catch (error) {
                console.error("è™•ç†æƒæçµæœå¤±æ•—:", error);
                // Avoid showing duplicate error if parseQrData already showed 'manualDownloadRequired'
                if (error.message !== 'manualDownloadRequired') {
                    showMessage(scanMessageDiv, `è™•ç†æƒæçµæœå¤±æ•—: ${error.message}`, 'danger');
                }
                scanResultDiv.style.display = 'none'; // Ensure results are hidden on error
                // Offer to rescan
                readerDiv.innerHTML += '<div class="text-center p-2"><button class="btn btn-sm btn-primary mt-2" onclick="startScanner()">é‡æ–°æƒæ</button></div>';
            }
            // --- End Process Data ---
        }

        /**
         * QR Code æƒæéŒ¯èª¤å›èª¿ (Scanner errors, not decoding errors)
         */
        function onScanFailure(error) {
            // Ignore "No QR code found" which happens frequently and is expected.
            // Log other potential scanner errors.
            if (error && error.message && !error.message.includes("NotFoundException")) {
                 // console.warn(`[Debug] Non-critical scan failure: ${error}`);
                 // Optionally display a subtle message? Usually not needed.
            }
        }


        /**
         * åˆå§‹åŒ–ä¸¦å•Ÿå‹•ç›¸æ©Ÿæƒæå™¨
         */
        function startScanner() {
             // console.log("[Debug] Attempting to start scanner...");
             hideMessage(scanMessageDiv);
             scanResultDiv.style.display = 'none'; // Hide previous results
             scanResultList.innerHTML = '';      // Clear previous list items
             readerDiv.innerHTML = '<p class="text-muted small p-3">æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...</p>'; // Initial placeholder

             // Prevent starting if already scanning or instance exists but failed previously
             if (html5QrCode && html5QrCode.isScanning) {
                 // console.warn("[Debug] Scanner is already running. Aborting new start request.");
                 return;
             }
             // Clean up any previous instance that might be lingering (e.g., after an error)
             if (html5QrCode) {
                  // console.log("[Debug] Cleaning up previous inactive scanner instance before starting.");
                  // Attempt a clean stop if possible, though it might error if already stopped
                  try { html5QrCode.stop().catch(()=>{}); } catch(e){}
                  html5QrCode = null;
             }

             readerDiv.style.display = 'flex'; // Use flex for centering placeholder initially

             try {
                 // Create a new scanner instance targeting the readerDiv
                 html5QrCode = new Html5Qrcode("reader", { verbose: false }); // verbose: false reduces library logs

                 const config = {
                     fps: 10, // Scan frequency
                     qrbox: (viewfinderWidth, viewfinderHeight) => {
                         // Make QR box responsive, slightly smaller than the narrowest dimension
                         let minEdgePercentage = 0.7; // 70% of the smaller dimension
                         let minEdgeSize = Math.min(viewfinderWidth, viewfinderHeight);
                         let qrboxSize = Math.floor(minEdgeSize * minEdgePercentage);
                         // console.log(`[Debug] Viewfinder: ${viewfinderWidth}x${viewfinderHeight}, QRBox size: ${qrboxSize}`);
                         return { width: qrboxSize, height: qrboxSize };
                     },
                     rememberLastUsedCamera: true, // Try to reuse the last camera
                     supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA] // Only use camera
                     // aspectRatio: 1.0 // Optional: Force a square aspect ratio for the video feed? Test needed.
                 };

                 showMessage(scanMessageDiv, 'æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...', 'info');

                 // Start scanning using the back camera preferentially
                 html5QrCode.start(
                     { facingMode: "environment" }, // Prefer back camera
                     config,
                     onScanSuccess,  // Success callback
                     onScanFailure)  // Failure callback (for scanner errors)
                 .then(() => {
                     // console.log("[Debug] Scanner started successfully.");
                     // Check if the scan tab is still the active one before showing message
                     if (document.getElementById('scan-tab').classList.contains('active')) {
                        showMessage(scanMessageDiv, 'ç›¸æ©Ÿå·²å•Ÿå‹•ï¼Œè«‹å°‡ QR Code å°æº–æƒææ¡†ã€‚', 'info');
                        readerDiv.style.display = 'block'; // Switch to block display once video starts
                     } else {
                         // If tab changed quickly, stop the scanner we just started
                         // console.log("[Debug] Scan tab was hidden immediately after scanner start, stopping scanner.");
                         stopScanner();
                     }
                 })
                 .catch((err) => {
                     console.error("ç„¡æ³•å•Ÿå‹•æƒæå™¨:", err);
                      // Check if the scan tab is still active before showing the error
                      if (document.getElementById('scan-tab').classList.contains('active')) {
                        let errMsg = `ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿæƒæå™¨: ${err}. è«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™è¨­å®šï¼Œä¸¦é‡æ–°æ•´ç†é é¢å˜—è©¦ã€‚`;
                        if (String(err).includes('NotAllowedError')) {
                            errMsg = 'ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼šæ‚¨å°šæœªæˆäºˆç›¸æ©Ÿæ¬Šé™ï¼Œæˆ–æ¬Šé™å·²è¢«æ’¤éŠ·ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚';
                        } else if (String(err).includes('NotFoundError')) {
                            errMsg = 'ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼šæ‰¾ä¸åˆ°å¯ç”¨çš„ç›¸æ©Ÿè¨­å‚™ã€‚';
                        } else if (String(err).includes('NotReadableError')) {
                             errMsg = 'ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼šç›¸æ©Ÿå¯èƒ½æ­£åœ¨è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ï¼Œæˆ–ç¡¬é«”ç™¼ç”Ÿå•é¡Œã€‚';
                        }
                        showMessage(scanMessageDiv, errMsg, 'danger');
                        readerDiv.innerHTML = `<p class="text-center text-danger p-3">ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ <br><small>${err}</small></p>`;
                        readerDiv.style.display = 'flex'; // Keep flex for centering error message
                      }
                     html5QrCode = null; // Ensure instance is nulled on error
                 });
             } catch (e) {
                 console.error("åˆå§‹åŒ– Html5Qrcode æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                  if (document.getElementById('scan-tab').classList.contains('active')) {
                    showMessage(scanMessageDiv, `åˆå§‹åŒ–æƒæå™¨å¤±æ•—: ${e}.`, 'danger');
                    readerDiv.style.display = 'flex';
                    readerDiv.innerHTML = `<p class="text-center text-danger p-3">åˆå§‹åŒ–æƒæå™¨å¤±æ•—</p>`;
                  }
                 html5QrCode = null;
             }
        }

         /**
         * åœæ­¢ç›¸æ©Ÿæƒæå™¨ (Gracefully)
         */
        async function stopScanner() {
             // Use the current global instance
             const scannerToStop = html5QrCode;

             if (scannerToStop && scannerToStop.isScanning) {
                 // console.log("[Debug] Attempting to stop scanner manually...");
                 html5QrCode = null; // Nullify global instance first
                 try {
                     // Ensure the target element still exists before calling stop
                     if (document.getElementById(scannerToStop.elementId)) {
                         await scannerToStop.stop();
                         // console.log("[Debug] QR Code scanning stopped successfully via stopScanner().");
                     } else {
                         // console.warn("[Debug] Scanner element not found during manual stop.");
                     }
                 } catch (err) {
                     // Log error, but UI cleanup should still happen
                     console.error("[Error] Error stopping scanner manually:", err);
                 } finally {
                     // Ensure UI is cleared regardless of stop success/failure
                     readerDiv.innerHTML = ''; // Clear reader content
                     hideMessage(scanMessageDiv); // Hide any messages
                 }
             } else {
                 // If instance exists but not scanning, or doesn't exist
                 // console.log("[Debug] stopScanner() called but scanner was not active or found.");
                 readerDiv.innerHTML = ''; // Still clear UI just in case
                 hideMessage(scanMessageDiv);
                 html5QrCode = null; // Ensure nullified
             }
        }


        /**
         * è™•ç†è¼‰å…¥ QR Code æª”æ¡ˆè¼¸å…¥äº‹ä»¶ (Scans file and Populates Form)
         */
        async function handleLoadQrFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return; // No file selected
            }
            // console.log(`[Debug] Loading QR Code from file: ${file.name}`);

            hideMessage(generateMessageDiv); // Use generate tab's message area
            showMessage(generateMessageDiv, 'æ­£åœ¨è®€å–åœ–ç‰‡ä¸¦æƒæ QR Code...', 'info');
            loadQrInput.disabled = true; // Disable input while processing

             // Use html5-qrcode to scan the file. Create a temporary instance.
             // We need a temporary visible element for the library, even if we hide it.
             // Let's reuse the readerDiv temporarily, ensuring it's cleared later.
             const tempReaderId = 'reader'; // Use the existing scan tab reader div ID
             const fileScanner = new Html5Qrcode(tempReaderId, { verbose: false });

             try {
                 // Scan the file, don't show the image in the reader element (false)
                 const decodedText = await fileScanner.scanFile(file, /* showImage= */ false);
                 // console.log("[Debug] Scanned successfully from file:", decodedText.substring(0,100) + "...");
                 showMessage(generateMessageDiv, 'åœ–ç‰‡æƒææˆåŠŸï¼Œæ­£åœ¨è§£æè³‡æ–™...', 'info');

                 // Now parse the data and populate the form
                 try {
                     const jsonData = await parseQrData(decodedText);
                     showMessage(generateMessageDiv, 'è³‡æ–™è§£ææˆåŠŸï¼Œæ­£åœ¨å¡«å…¥è¡¨å–®...', 'info');
                     await populateForm(jsonData); // Populate the form on Generate tab
                     // Success message is shown inside populateForm
                     // console.log("[Debug] Load QR File process completed successfully.");

                 } catch (parseOrPopulateError) {
                     console.error("è™•ç†è¼‰å…¥çš„ QR è³‡æ–™å¤±æ•—:", parseOrPopulateError);
                     // Provide specific error from parseQrData or populateForm
                     // Avoid showing error if it was 'manualDownloadRequired' (already handled by parseQrData)
                     if (parseOrPopulateError.message !== 'manualDownloadRequired') {
                        showMessage(generateMessageDiv, `è™•ç†è¼‰å…¥çš„ QR è³‡æ–™å¤±æ•—: ${parseOrPopulateError.message}`, 'danger');
                     }
                 }

             } catch (scanError) {
                 console.error("å¾æª”æ¡ˆæƒæå¤±æ•—:", scanError);
                 let errorMessage = 'ç„¡æ³•å¾åœ–ç‰‡ä¸­æƒæåˆ° QR Codeã€‚';
                 // Provide more specific error message if available
                 if (scanError && scanError.message) {
                     if (String(scanError).includes("NotFoundException") || String(scanError).includes("No MultiFormat Readers found")) {
                          errorMessage = 'åœ–ç‰‡ä¸­æœªæ‰¾åˆ° QR Code æˆ–æ ¼å¼ä¸æ”¯æ´ã€‚';
                     } else if (String(scanError).includes("Corrupt")) {
                          errorMessage = 'åœ–ç‰‡æª”æ¡ˆå¯èƒ½å·²ææ¯€ã€‚';
                     }
                      else {
                          errorMessage = `æƒæåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤: ${scanError}`; // Show raw error for debugging
                     }
                 }
                 showMessage(generateMessageDiv, errorMessage, 'danger');
             } finally {
                  // Clean up temporary scanner resources if necessary (library might handle this)
                  try {
                      // Attempt to clear the temporary scanner instance if it has a clear method
                      if (fileScanner && typeof fileScanner.clear === 'function') {
                          // fileScanner.clear(); // As of 2.3.8, clear might not be needed for file scan, but check docs if issues arise
                      }
                  } catch (clearError) {
                      console.warn("Error clearing file scanner instance:", clearError);
                  }
                  // Reset the file input so the same file can be selected again immediately
                  loadQrInput.value = '';
                  loadQrInput.disabled = false; // Re-enable input
                  // Ensure the reader div used temporarily is cleared if it wasn't already
                  // document.getElementById(tempReaderId).innerHTML = ''; // Might interfere with active camera scanner
             }
        }

        /**
         * è™•ç†ä½¿ç”¨è€…è¼‰å…¥ .json æª”æ¡ˆ (Populates Form)
         */
        function handleLoadJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            // console.log(`[Debug] Loading JSON from file: ${file.name}`);
            hideMessage(generateMessageDiv);
            showMessage(generateMessageDiv, 'æ­£åœ¨è®€å– JSON æª”æ¡ˆ...', 'info');
            loadJsonInput.disabled = true;

            const reader = new FileReader();
            reader.onload = async (e) => { // Make async to await populateForm
                try {
                    const text = e.target.result;
                    const parsedJson = JSON.parse(text);

                    let dataToPopulate;
                    // Check if it's the compressed minimal format {v:1, d:"..."}
                    if (parsedJson && typeof parsedJson === 'object' && parsedJson.v === 1 && typeof parsedJson.d === 'string') {
                        // console.log("[Debug] Detected minimal-JSON format in loaded file, decompressing...");
                        const decompressed = LZString.decompressFromBase64(parsedJson.d);
                        if (!decompressed) throw new Error('å¾æª”æ¡ˆè§£å£“ç¸® minimal-JSON å¤±æ•—');
                        dataToPopulate = JSON.parse(decompressed);
                    } else {
                        // Assume it's raw JSON data
                        // console.log("[Debug] Assuming raw JSON format in loaded file.");
                        dataToPopulate = parsedJson;
                    }

                    // Populate the form with the final data object
                    await populateForm(dataToPopulate);
                    // Success message is shown inside populateForm

                } catch (err) {
                    console.error("è¼‰å…¥æˆ–è™•ç† JSON æª”æ¡ˆå¤±æ•—:", err);
                    let userMsg = 'è¼‰å…¥ JSON å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–ç„¡æ³•è§£æã€‚';
                    if (err instanceof SyntaxError) {
                        userMsg = `è¼‰å…¥ JSON å¤±æ•—ï¼šJSON èªæ³•éŒ¯èª¤ (${err.message})ã€‚`;
                    } else if (err.message.includes('è§£å£“ç¸®')) {
                        userMsg = `è¼‰å…¥ JSON å¤±æ•—ï¼š${err.message}ã€‚`;
                    }
                    showMessage(generateMessageDiv, userMsg, 'danger');
                } finally {
                    // Reset file input regardless of success/failure
                    loadJsonInput.value = '';
                    loadJsonInput.disabled = false;
                }
            };
            reader.onerror = (error) => {
                 console.error("è®€å– JSON æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                 showMessage(generateMessageDiv, 'è®€å– JSON æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚', 'danger');
                 loadJsonInput.value = '';
                 loadJsonInput.disabled = false;
            };
            reader.readAsText(file); // Read file as text
        }

        /**
         * è™•ç†åœ¨ã€Œæƒæã€é ç±¤è¼‰å…¥ JSON æª”æ¡ˆçš„äº‹ä»¶ (é¡¯ç¤ºçµæœæ–¼ Scan Tab)
         */
        function handleLoadJsonForScanTab(event) {
            const file = event.target.files[0];
            if (!file) {
                return; // No file selected
            }
            // console.log(`[Debug Scan Tab] Loading JSON from file: ${file.name}`);

            hideMessage(scanMessageDiv); // ä½¿ç”¨ Scan Tab çš„è¨Šæ¯å€
            showMessage(scanMessageDiv, 'æ­£åœ¨è®€å– JSON æª”æ¡ˆ...', 'info');
            scanResultDiv.style.display = 'none'; // éš±è—èˆŠçµæœ
            scanResultList.innerHTML = ''; // æ¸…ç©ºèˆŠåˆ—è¡¨
            if (loadJsonInputScan) loadJsonInputScan.disabled = true; // ç¦ç”¨æŒ‰éˆ•

            const reader = new FileReader();

            reader.onload = async (e) => { // Make async if displayScanResult becomes async
                try {
                    const text = e.target.result;
                    let dataToDisplay;

                    // å˜—è©¦è§£æ JSON (æ”¯æ´åŸå§‹ JSON æˆ– å£“ç¸®æ ¼å¼ {v:1, d:"..."})
                    const parsedJson = JSON.parse(text);
                    if (parsedJson && typeof parsedJson === 'object' && parsedJson.v === 1 && typeof parsedJson.d === 'string') {
                        // console.log("[Debug Scan Tab] Detected minimal-JSON format in loaded file, decompressing...");
                        const decompressed = LZString.decompressFromBase64(parsedJson.d);
                        if (!decompressed) throw new Error('å¾æª”æ¡ˆè§£å£“ç¸® minimal-JSON å¤±æ•—');
                        dataToDisplay = JSON.parse(decompressed);
                    } else {
                        // console.log("[Debug Scan Tab] Assuming raw JSON format in loaded file.");
                        dataToDisplay = parsedJson; // å‡è¨­æ˜¯åŸå§‹ JSON
                    }

                    // *** ä½¿ç”¨ç¾æœ‰çš„ displayScanResult å‡½å¼é¡¯ç¤ºåœ¨ç¬¬äºŒé  ***
                    displayScanResult(dataToDisplay);
                    showMessage(scanMessageDiv, 'å·²æˆåŠŸå¾æª”æ¡ˆè¼‰å…¥ä¸¦é¡¯ç¤ºè³‡æ–™ã€‚', 'success');

                } catch (err) {
                    console.error("è¼‰å…¥æˆ–è™•ç† JSON æª”æ¡ˆå¤±æ•— (Scan Tab):", err);
                    let userMsg = 'è¼‰å…¥ JSON å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–ç„¡æ³•è§£æã€‚';
                    if (err instanceof SyntaxError) {
                        userMsg = `è¼‰å…¥ JSON å¤±æ•—ï¼šJSON èªæ³•éŒ¯èª¤ (${err.message})ã€‚`;
                    } else if (err.message && err.message.includes('è§£å£“ç¸®')) {
                        userMsg = `è¼‰å…¥ JSON å¤±æ•—ï¼š${err.message}ã€‚`;
                    }
                    showMessage(scanMessageDiv, userMsg, 'danger');
                    scanResultDiv.style.display = 'none'; // ç¢ºä¿å‡ºéŒ¯æ™‚çµæœå€åŸŸæ˜¯éš±è—çš„
                } finally {
                    // Reset file input regardless of success/failure
                    if (loadJsonInputScan) {
                        loadJsonInputScan.value = '';
                        loadJsonInputScan.disabled = false;
                    }
                }
            };

            reader.onerror = (error) => {
                 console.error("è®€å– JSON æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ (Scan Tab):", error);
                 showMessage(scanMessageDiv, 'è®€å– JSON æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚', 'danger');
                 if (loadJsonInputScan) {
                     loadJsonInputScan.value = '';
                     loadJsonInputScan.disabled = false;
                 }
            };

            reader.readAsText(file); // Read file as text
        }        

        // --- Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // console.log("[Debug] DOMContentLoaded event fired.");
            try {
                generateFormFields(); // Generate form on page load
            } catch (error) {
                console.error("åˆå§‹åŒ–è¡¨å–®æ¬„ä½æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                // Display error in a prominent place if form generation fails
                const body = document.querySelector('body');
                if (body) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger m-3';
                    errorDiv.textContent = `é é¢åˆå§‹åŒ–éŒ¯èª¤ï¼šç„¡æ³•ç”¢ç”Ÿè¡¨å–®æ¬„ä½ (${error})ã€‚è«‹é‡æ–°æ•´ç†é é¢ã€‚`;
                    body.prepend(errorDiv);
                }
            }

            // Attach event listeners only if elements exist
            if (teaForm) {
                teaForm.addEventListener('submit', handleFormSubmit);
            } else { console.error("Error: teaForm element not found."); }

            if (saveQrButton) {
                saveQrButton.addEventListener('click', handleSaveQr);
            } else { console.error("Error: saveQrButton element not found."); }

            if (loadQrInput) {
                loadQrInput.addEventListener('change', handleLoadQrFile);
            } else { console.error("Error: loadQrInput element not found."); }

            if (loadJsonInput) {
                loadJsonInput.addEventListener('change', handleLoadJson);
            } else { console.error("Error: loadJsonInput element not found."); }

            if (copyJsonButton) {
                copyJsonButton.addEventListener('click', handleCopyJson);
            } else { console.error("Error: copyJsonButton element not found."); }

            if (downloadJsonButton) {
                downloadJsonButton.addEventListener('click', handleDownloadJson);
            } else { console.error("Error: downloadJsonButton element not found."); }

             if (generateLinkQrButton) {
                generateLinkQrButton.addEventListener('click', handleGenerateLinkQr);
            } else { console.error("Error: generateLinkQrButton element not found."); }

            if (loadJsonInputScan) {
                loadJsonInputScan.addEventListener('change', handleLoadJsonForScanTab);
            } else { console.error("Error: loadJsonInputScan element not found."); }
            

            // Tab switching logic for scanner activation/deactivation
            const scanTabElement = document.getElementById('scan-tab');
            // const generateTabElement = document.getElementById('generate-tab'); // Not strictly needed for logic

            if (scanTabElement) {
                // When Scan tab becomes visible, start the scanner
                scanTabElement.addEventListener('shown.bs.tab', (event) => {
                    // console.log("[Debug] Scan tab shown.");
                    startScanner();
                });
                 // When Scan tab is *about* to be hidden, stop the scanner
                 scanTabElement.addEventListener('hide.bs.tab', (event) => {
                     // console.log("[Debug] Scan tab hide event triggered.");
                     stopScanner(); // Call async stop function
                 });
            } else { console.error("Error: scan-tab element not found."); }

            // Also attempt to stop scanner if user navigates away or closes tab/window
            // Note: 'beforeunload' might not always complete async operations like stopping scanner
            window.addEventListener('beforeunload', () => {
                // console.log("[Debug] beforeunload event triggered. Attempting to stop scanner.");
                // This is a best-effort attempt, might not fully complete
                if (html5QrCode && html5QrCode.isScanning) {
                    stopScanner(); // Fire and forget attempt
                }
            });

            // console.log("[Debug] Event listeners attached.");
        });

    </script>

</body>
</html>
