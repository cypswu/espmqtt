<!--
===============================================================================
品茶 QR Code 管理系統 ‧ 程式說明文件  
Version : 1.4.0 (2025-04-30)
Author  : lung / ChatGPT-o3 collaborative draft  
License : MIT (可自由改作，請保留版權與授權條款)

▍一、功能總覽
  1. ✏️  表單輸入 — 一次填寫 26 項茶葉資訊＋產品圖片（支援檔案或網址）。
  2. 📷  QR Code 產生 — 將 JSON 壓縮成 Base64 後用 QRious 生成，
         自動檢測容量 (≈ 2.9 KB 上限)，超限即提示精簡內容並 fallback。
  3. 💾  QR Code 儲存 — 支援 File System Access API，
         彈出「另存為」視窗；不支援時自動轉傳統下載。
  4. 🔄  QR Code 載入 — 檔案選擇器解析 QR 圖片，先嘗試 decompressFromBase64()，
         失敗時再 atob()，並正確回填表單欄位及同步更新 QR。
  5. 🔍  QR Code 掃描 — 採用 Html5QrcodeScanner；
         預設優先「Camera 2.0 → 後鏡頭 → 第一鏡頭」。
         解析後以中文列表顯示所有欄位，並可預覽圖片。
  6. 🎨  UI 美學 — 茶葉配色、優雅襯線字體、柔和陰影與進場動畫；
         Debug 區可收合，方便開發與正式部署切換。
  7. 🛠️  可維護性 — 表單欄位、fields 陣列、labelMap 對照及
         CSS 色票集中管理；註解標示關鍵修改點。

▍二、快速使用  
  ① 雙擊 `index.html` 或部署於 HTTPS / localhost。  
  ② 在「產生 QR Code」分頁輸入資料 → 按「產生 QR Code」。  
  ③ 按「儲存 QR Code」或「載入 QR Code」按鈕執行操作。  
  ④ 切換「掃描 QR Code」分頁 → 授權相機 → 對準 QR 即可查看結果。

▍三、維護要點
  • 新增或刪減欄位時，更新 `fields[]`、`labelMap{}` 及 `<form>`。  
  • 壓縮/解壓邏輯集中於 `submit` 與 `load-btn` 事件。  
  • 如需其它檔案類型，擴充 `showSaveFilePicker.types`。

▍四、核心檔案結構
  • HTML 表單            → id 必須列入 JS `fields[]`；  
  • JS `fields[]`        → 控制輸出欄位；  
  • JS `labelMap{}`      → 英文鍵 ↔ 中文欄位名；  
  • CSS `:root` 變數     → 主題色票；  
  • `defaultCamId()`     → 鏡頭優先設定；  
  • `level:'M'`          → QR 容錯等級；

▍五、版本紀錄
  v1.4.0 (2025-04-30)
    • feat: 完整 26 欄位表單；  
    • feat: 支援產品圖片網址或檔案上傳；  
    • bump: 版本自動更新為 v1.4.0  
  v1.3.1 (2025-04-30)
    • feat: 引入 lz-string 庫 → 支援 JSON 壓縮/解壓
    • feat: 產生 QR 時 compressToBase64() → 逾容量再 fallback 至原 Base64
    • fix: 容量檢查改對 最終 b64.length（Version 40-M 上限 2 953 bytes）
    • fix: 載入流程先 decompressFromBase64() → 失敗再 atob()，並 正確回填表單欄位
    • feat: File System Access API 儲存；不支援時自動轉傳統下載
    • refactor: DOMContentLoaded 中統一初始化 QRious／事件綁定
    • docs: 更新頁首說明至 v1.3.1，補充快速流程與維護要點
  v1.2.0 (2025-04-29)
    • 新增：QR Code 儲存功能（File System Access API + 傳統下載）
    • 新增：QR Code 載入功能（檔案選擇器解析填表）
    • 修正：提升載入可靠度，完善錯誤處理。
    • 優化：更新使用說明與操作流程。
===============================================================================
-->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>品茶 QR Code 管理系統</title>

<!-- -------------------------------------------------
 字體與第三方函式庫
-------------------------------------------------- -->
<!-- ADD: 預連線以加速字體載入 -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- -------------------------------------------------
 引入 QRious, Html5Qrcode 及 LZ-String（ULTIMATE UPDATE [1]）
-------------------------------------------------- -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>
<script src="https://unpkg.com/html5-qrcode@2.3.7/html5-qrcode.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js" defer></script> <!-- ULTIMATE: 壓縮支持 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>

<!-- -------------------------------------------------
 自訂樣式：茶葉配色 ＋ 卡片陰影 ＋ 動畫
-------------------------------------------------- -->
<style>
  /*─────────────────────────────────────────────*/
  /* 主題色票 (集中管理，便於一鍵換色) */
  :root {
    --tea-primary:       #5a7d2c;   /* 主色 */
    --tea-primary-dark:  #496724;   /* 懸浮、互動色 */
    --tea-secondary:     #d4c3a0;   /* 次色 / 分頁背景 */
    --tea-bg:            #f9f7f2;   /* 頁面背景 */
    --tea-text:          #3f3320;   /* 文字色 */
    --bs-primary: var(--tea-primary);
  }

  /*─────────────────────────────────────────────*/
  /* 全域樣式 */
  body {
    font-family: 'Noto Serif TC', serif;
    background: linear-gradient(135deg, var(--tea-bg), #fff);
    color: var(--tea-text);
    margin: 0; padding: 0;
  }
  h3, h4, h5 {
    font-family: 'Playfair Display', serif;
    margin-top: 1rem; margin-bottom: 1rem;
  }

  /*─────────────────────────────────────────────*/
  /* 導覽列 */
  .navbar {
    background: var(--tea-primary);
  }
  .navbar-brand {
    color: #fff !important;
    font-weight: 600;
    letter-spacing: 1px;
    transition: opacity 0.3s;
  }
  .navbar-brand:hover {
    opacity: 0.85;
  }

  /*─────────────────────────────────────────────*/
  /* 分頁標籤 */
  .nav-tabs .nav-link {
    border: 0;
    font-weight: 600;
    color: var(--tea-text);
  }
  .nav-tabs .nav-link.active {
    background: var(--tea-secondary);
    color: var(--tea-text);
    border-radius: 0.5rem 0.5rem 0 0;
  }

  /*─────────────────────────────────────────────*/
  /* 卡片 (Bootstrap .card 覆寫) */
  .card {
    border: 0;
    border-radius: 1rem;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    background: #fff;
  }

  /*─────────────────────────────────────────────*/
  /* 按鈕  */
  .btn-primary {
    background: var(--tea-primary);
    border-color: var(--tea-primary);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .btn-primary:hover {
    background: var(--tea-primary-dark);
    border-color: var(--tea-primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
  }

  /*─────────────────────────────────────────────*/
  /* QR Canvas */
  #qr-code {
    display: block;
    margin: 2rem auto;
    border: 8px solid #fff;
    border-radius: 0.75rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }

  /*─────────────────────────────────────────────*/
  /* Debug 區塊 */
  .debug-wrapper summary {
    cursor: pointer;
    font-weight: 600;
    color: var(--tea-primary-dark);
  }
  pre.debug {
    background: #fff;
    border: 1px solid #e6e2d9;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    max-height: 200px;
    overflow: auto;
    padding: 0.75rem;
  }

  /*─────────────────────────────────────────────*/
  /* 進場動畫 (分頁切換卡片) */
  @keyframes fadeInUp {
    0% {
      opacity: 0;
      transform: translateY(20px);
    }
    100% {
      opacity: 1;
      transform: none;
    }
  }
  .tab-pane.fade.show.active > .card {
    animation: fadeInUp 0.5s ease-out;
  }
</style>
</head>
<body>
  <main>
    <!-- 導覽列 -->
    <nav class="navbar shadow-sm">
      <div class="container">
        <a class="navbar-brand" href="#">品茶 QR Code 管理系統</a>
      </div>
    </nav>

    <div class="container my-5">
      <!-- 分頁選單 -->
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#gen">
            產生 QR Code
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#scan">
            掃描 QR Code
          </button>
        </li>
      </ul>

      <div class="tab-content py-4">
        <!-- ► 產生 QR Code 分頁 -->
        <div class="tab-pane fade show active" id="gen">
          <div class="card p-4">
            <h3 class="mb-3">茶葉資訊輸入 (共 26 項)</h3>
            <form id="teaForm">
              <div class="row g-3">
                <!-- 1–5 -->
                <div class="col-md-6">
                  <label for="teaName" class="form-label">1. 茶葉名稱</label>
                  <input id="teaName" class="form-control" type="text" placeholder="例如：日月潭紅茶" required>
                </div>
                <div class="col-md-6">
                  <label for="teaType" class="form-label">2. 茶葉種類</label>
                  <input id="teaType" class="form-control" type="text" placeholder="例如：紅茶">
                </div>
                <div class="col-md-6">
                  <label for="originRegion" class="form-label">3. 產區</label>
                  <input id="originRegion" class="form-control" type="text" placeholder="例如：南投縣魚池鄉">
                </div>
                <div class="col-md-6">
                  <label for="producer" class="form-label">4. 生產者</label>
                  <input id="producer" class="form-control" type="text" placeholder="例如：茶山農場">
                </div>
                <div class="col-md-4">
                  <label for="harvestSeason" class="form-label">5. 採收季節</label>
                  <input id="harvestSeason" class="form-control" type="text" placeholder="例如：春季">
                </div>

                <!-- 6–10 -->
                <div class="col-md-4">
                  <label for="harvestDate" class="form-label">6. 採摘日期</label>
                  <input id="harvestDate" class="form-control" type="date">
                </div>
                <div class="col-md-4">
                  <label for="processingMethod" class="form-label">7. 處理方式</label>
                  <input id="processingMethod" class="form-control" type="text" placeholder="例如：烘焙">
                </div>
                <div class="col-md-4">
                  <label for="grade" class="form-label">8. 等級</label>
                  <input id="grade" class="form-control" type="text" placeholder="例如：特級">
                </div>
                <div class="col-md-4">
                  <label for="batchNo" class="form-label">9. 批號</label>
                  <input id="batchNo" class="form-control" type="text" placeholder="例如：202504A01">
                </div>
                <div class="col-md-4">
                  <label for="packagingDate" class="form-label">10. 包裝日期</label>
                  <input id="packagingDate" class="form-control" type="date">
                </div>

                <!-- 11–15 -->
                <div class="col-md-6">
                  <label for="netWeight" class="form-label">11. 淨重 (g)</label>
                  <input id="netWeight" class="form-control" type="number" step="0.01" placeholder="例如：50">
                </div>
                <div class="col-md-6">
                  <label for="moistureContent" class="form-label">12. 水分含量 (%)</label>
                  <input id="moistureContent" class="form-control" type="number" step="0.1" placeholder="例如：5.5">
                </div>
                <div class="col-md-6">
                  <label for="aromaProfile" class="form-label">13. 香氣</label>
                  <input id="aromaProfile" class="form-control" type="text" placeholder="例如：花香、果香">
                </div>
                <div class="col-md-6">
                  <label for="flavorNotes" class="form-label">14. 風味描述</label>
                  <input id="flavorNotes" class="form-control" type="text" placeholder="例如：甘醇回甘">
                </div>
                <div class="col-md-6">
                  <label for="infusionCount" class="form-label">15. 建議沖泡次數</label>
                  <input id="infusionCount" class="form-control" type="number" placeholder="例如：3">
                </div>

                <!-- 16–20 -->
                <div class="col-md-6">
                  <label for="recommendedRatio" class="form-label">16. 建議投茶量 (g/L)</label>
                  <input id="recommendedRatio" class="form-control" type="number" step="0.1" placeholder="例如：5">
                </div>
                <div class="col-md-4">
                  <label for="waterTemp" class="form-label">17. 水溫 (℃)</label>
                  <input id="waterTemp" class="form-control" type="number" placeholder="例如：90">
                </div>
                <div class="col-md-4">
                  <label for="brewTime" class="form-label">18. 沖泡時間 (秒)</label>
                  <input id="brewTime" class="form-control" type="number" placeholder="例如：30">
                </div>
                <div class="col-md-4">
                  <label for="servingSuggestion" class="form-label">19. 建議飲用方式</label>
                  <input id="servingSuggestion" class="form-control" type="text" placeholder="例如：熱飲、溫飲">
                </div>
                <div class="col-md-6">
                  <label for="caffeineLevel" class="form-label">20. 咖啡因含量</label>
                  <input id="caffeineLevel" class="form-control" type="text" placeholder="例如：中等">
                </div>

                <!-- 21–26 (圖片支援 URL 或 檔案) -->
                <div class="col-md-6">
                  <label for="pHValue" class="form-label">21. pH 值</label>
                  <input id="pHValue" class="form-control" type="number" step="0.01" placeholder="例如：6.5">
                </div>
                <div class="col-md-6">
                  <label for="storage" class="form-label">22. 保存方式</label>
                  <input id="storage" class="form-control" type="text" placeholder="例如：陰涼乾燥處">
                </div>
                <div class="col-md-6">
                  <label for="shelfLife" class="form-label">23. 賞味期限</label>
                  <input id="shelfLife" class="form-control" type="date">
                </div>
                <div class="col-md-6">
                  <label for="certification" class="form-label">24. 認證</label>
                  <input id="certification" class="form-control" type="text" placeholder="例如：有機、GAP">
                </div>
                <div class="col-md-6">
                  <label for="packagingType" class="form-label">25. 包裝方式</label>
                  <input id="packagingType" class="form-control" type="text" placeholder="例如：鋁箔袋">
                </div>
                <div class="col-md-12">
                  <label for="productImageUrl" class="form-label">26. 產品圖片 URL</label>
                  <input id="productImageUrl" class="form-control" type="url" placeholder="例如：https://例子.com/tea.jpg">
                </div>
                <div class="col-md-12">
                  <label for="productImageFile" class="form-label">產品圖片上傳</label>
                  <input id="productImageFile" class="form-control" type="file" accept="image/*">
                </div>
              </div>

              <button type="submit" class="btn btn-primary px-4 mt-4">
                產生 QR Code
              </button>
            </form>

            <!-- QR 顯示與操作按鈕 -->
            <div class="text-center my-4">
              <canvas id="qr-code" width="420" height="420"></canvas>
              <div id="qr-reader-file" style="display:none;"></div>
              <div class="mt-4">
                <button id="save-btn" class="btn btn-secondary mx-2">儲存 QR Code</button>
                <button id="load-btn" class="btn btn-secondary">載入 QR Code</button>
              </div>
            </div>

            <!-- Debug 資訊 -->
            <details class="debug-wrapper">
              <summary>Debug 資訊 ↡</summary>
              <pre id="orig-payload" class="debug mt-2"></pre>
              <pre id="b64-payload" class="debug mt-2"></pre>
            </details>
          </div>
        </div>

        <!-- ► 掃描 QR Code 分頁 -->
        <div class="tab-pane fade" id="scan">
          <div class="card p-4">
            <h3 class="mb-3">QR Code 掃描</h3>
            <p class="text-muted">點擊後授權相機，對準 QR 即可。</p>
            <div id="reader" style="width:100%;max-width:600px;margin:auto;"></div>
            <hr>
            <div id="result"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

<!-- -------------------------------------------------
 JavaScript 區：產生 + 掃描
-------------------------------------------------- -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // ──────────────────────────────────────────────────
    // 1. 初始化 QRious
    // ──────────────────────────────────────────────────
    const qr = new QRious({
      element: document.getElementById('qr-code'),
      size: 420,
      level: 'M'  // QR 容錯等級 M (≈3KB 容量)
    });

    // ──────────────────────────────────────────────────
    // 2. 欄位 & 標籤對應
    // ──────────────────────────────────────────────────
    const fields = [
      'teaName','teaType','originRegion','producer','harvestSeason',
      'harvestDate','processingMethod','grade','batchNo','packagingDate',
      'netWeight','moistureContent','aromaProfile','flavorNotes','infusionCount',
      'recommendedRatio','waterTemp','brewTime','servingSuggestion','caffeineLevel',
      'pHValue','storage','shelfLife','certification','packagingType'
    ];
    const labelMap = {
      teaName: '茶葉名稱', teaType: '茶葉種類', originRegion: '產區',
      producer: '生產者', harvestSeason: '採收季節', harvestDate: '採摘日期',
      processingMethod: '處理方式', grade: '等級', batchNo: '批號',
      packagingDate: '包裝日期', netWeight: '淨重', moistureContent: '水分含量',
      aromaProfile: '香氣', flavorNotes: '風味描述', infusionCount: '建議沖泡次數',
      recommendedRatio: '建議投茶量', waterTemp: '水溫', brewTime: '沖泡時間',
      servingSuggestion: '建議飲用方式', caffeineLevel: '咖啡因含量',
      pHValue: 'pH 值', storage: '保存方式', shelfLife: '賞味期限',
      certification: '認證', packagingType: '包裝方式', productImage: '產品圖片'
    };

    // ──────────────────────────────────────────────────
    // 3. 鏡頭預設
    // ──────────────────────────────────────────────────
    function defaultCamId(cameras) {
      // 優先選擇標籤含 rear/back/後 的鏡頭
      const rear = cameras.find(c => /rear|back|後/.test(c.label));
      return (rear || cameras[0]).id;
    }

    // ──────────────────────────────────────────────────
    // 4. 產生 QR Code（表單 submit）
    // ──────────────────────────────────────────────────
    document.getElementById('teaForm').addEventListener('submit', e => {
      e.preventDefault();

      // 收集表單資料
      const data = {};
      fields.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.value.trim()) data[id] = el.value.trim();
      });

      // 圖片：優先 URL，再檔案
      const url = document.getElementById('productImageUrl').value.trim();
      const file = document.getElementById('productImageFile').files[0];

      // 最終封包與 QR 生成
      const finalize = payload => {
        const jsonStr = JSON.stringify(payload);
        // 先用 LZString 壓縮
        let b64 = LZString.compressToBase64(jsonStr);
        // 超限就 fallback 至原生 Base64
        if (b64.length >= 2953) {
          b64 = btoa(unescape(encodeURIComponent(jsonStr)));
        }
        if (b64.length > 2953) {
          alert(`資料過長 (${b64.length} bytes)，請精簡內容。`);
          return;
        }
        qr.value = b64;
        // 顯示 Debug 資訊
        document.getElementById('orig-payload').textContent = jsonStr;
        document.getElementById('b64-payload').textContent = b64;
      };

      // 填入圖片資料
      if (url) {
        finalize({ ...data, productImage: url });
      }
      else if (file) {
        const reader = new FileReader();
        reader.onload = () => finalize({ ...data, productImage: reader.result });
        reader.readAsDataURL(file);
      }
      else {
        finalize(data);
      }
    });

    // ──────────────────────────────────────────────────
    // 5. 掃描 QR Code（切換至掃描分頁時初始化）
    // ──────────────────────────────────────────────────
    let scanner = null;
    const scanTabBtn = document.querySelector('button[data-bs-target="#scan"]');

    scanTabBtn.addEventListener('shown.bs.tab', () => {
      if (scanner) return;  // 已經初始化過就跳過

      // 建構 Html5QrcodeScanner
      scanner = new Html5QrcodeScanner(
        "reader",
        {
          fps: 12,                              // 掃描幀率
          qrbox: { width: 300, height: 300 },   // 顯示並掃描的框大小
          disableFlip: true,                    // 關閉翻轉
          rememberLastUsedCamera: true,         // 記住使用過的相機
          experimentalFeatures: {
            useBarCodeDetectorIfSupported: true // 如果有 BarcodeDetector API 就用它
          },
          defaultCameraId: defaultCamId         // 先前定義的鏡頭選擇函式
        },
        /* verbose= */ false
      );

      // 掃描成功回呼
      const onScanSuccess = decodedText => {
        try {
          // 先嘗試 LZString 解壓，失敗就用 atob
          let raw = LZString.decompressFromBase64(decodedText);
          if (!raw) raw = decodeURIComponent(escape(atob(decodedText)));
          const info = JSON.parse(raw);

          // 組畫面
          let html = '<h4 class="mb-3">茶葉資訊</h4><ul class="list-group mb-3">';
          Object.entries(info).forEach(([k, v]) => {
            const lbl = labelMap[k] || k;
            if (k === 'productImage') {
              html += `
                <li class="list-group-item">
                  <strong>${lbl}：</strong><br>
                  <img src="${v}" class="img-fluid rounded mt-2">
                </li>`;
            } else {
              html += `
                <li class="list-group-item d-flex justify-content-between">
                  <span>${lbl}</span><span>${v}</span>
                </li>`;
            }
          });
          html += '</ul>';
          document.getElementById('result').innerHTML = html;

          // 如果你只想掃一次，則可以停止掃描：
          // scanner.clear().catch(err => console.warn('停止掃描失敗', err));
        } catch (e) {
          document.getElementById('result').innerHTML =
            `<div class="alert alert-danger">解析錯誤：${e.message}</div>`;
        }
      };

      // 掃描錯誤回呼（可以印出來看看為什麼沒解到碼）
      const onScanError = errorMessage => {
        console.debug('QR 掃描錯誤：', errorMessage);
      };

      // 開始掃描（帶入成功與錯誤回呼）
      scanner.render(onScanSuccess, onScanError);
    });

    // ──────────────────────────────────────────────────
    // 6. 儲存 QR Code 圖片
    // ──────────────────────────────────────────────────
    document.getElementById('save-btn').addEventListener('click', async () => {
      try {
        // 直接取得 canvas 元素
        const canvas = document.getElementById('qr-code');
        // 將 canvas 轉為 blob
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const defaultName = (document.getElementById('teaName').value.trim() || 'qr-code') + '.png';

        if (window.showSaveFilePicker) {
          const handle = await showSaveFilePicker({
            suggestedName: defaultName,
            types: [{
              description: 'PNG 圖片',
              accept: { 'image/png': ['.png'] }
            }]
          });
          const writable = await handle.createWritable();
          await writable.write(blob);
          await writable.close();
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = defaultName;
          a.click();
          URL.revokeObjectURL(url);
        }
      } catch (err) {
        alert('儲存失敗：' + err.message);
      }
    });

    // ──────────────────────────────────────────────────
    // 7. 載入 QR Code（從檔案）
    // ──────────────────────────────────────────────────
    document.getElementById('load-btn').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new Html5Qrcode('qr-reader-file');
        reader.scanFile(file, true)
          .then(decodedText => {
            let raw = LZString.decompressFromBase64(decodedText);
            if (!raw) raw = decodeURIComponent(escape(atob(decodedText)));
            const info = JSON.parse(raw);

            // 回填表單
            Object.entries(info).forEach(([k, v]) => {
              const el = document.getElementById(k);
              if (el) el.value = v;
            });

            // 更新畫面 QR（以純 Base64 再產生）
            const jsonStr = JSON.stringify(info);
            qr.value = btoa(unescape(encodeURIComponent(jsonStr)));
            reader.clear();
          })
          .catch(err => {
            alert('載入失敗：' + err);
            reader.clear();
          });
      };
      input.click();
    });

  }); // end DOMContentLoaded
</script>
</body>
</html>
